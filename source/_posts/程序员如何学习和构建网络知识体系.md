---
title: 程序员如何学习和构建网络知识体系
date: 2020-05-24 17:30:03
categories:
    - network
tags:
    - network
    - TCP
    - Linux
---

# 程序员如何学习和构建网络知识体系

大家学习网络知识的过程中经常发现当时看懂了，很快又忘了，最典型的比如TCP三次握手、为什么要握手，大家基本都看过，但是种感觉还差那么一点点。都要看是因为面试官总要问，所以不能不知道啊。

我们来看一个典型的面试问题：

> 问：为什么TCP是可靠的？
> 答：因为TCP有连接（或者回答因为TCP有握手）
>
> 追问：为什么有连接就可靠了？（面试的人估计心里在骂，你这不是傻逼么，有连接就可靠啊）
>
> 追问：这个TCP连接的本质是什么？网络上给你保留了一个带宽所以能可靠？
> 答：……懵了（或者因为TCP有ack，所以可靠）
>
> 追问：握手的本质是什么？为什么握手就可靠了
> 答：因为握手需要ack
> 追问：那这个ack也只是保证握手可靠，握手是怎么保证后面可靠的？握手本质做了什么事情？
>
> 追问：有了ack可靠后还会带来什么问题（比如发一个包ack一下，肯定是可行的，但是效率不行，面试官想知道的是这里TCP怎么传输的，从而引出各个buffer、拥塞窗口的概念）

基本上我发现99%的程序员会回答TCP相对UDP是可靠的，70%以上的程序员会告诉你可靠是因为有ack（其他的会告诉你可靠是因为握手或者有连接），再追问下次就开始王顾左右而言他、胡言乱语。

我的理解：

> 物理上没有一个连接的东西在这里，udp也类似会占用端口、ip，但是大家都没说过udp的连接。而本质上我们说tcp的握手是指tcp是协商和维护一些状态信息的，这个状态信息就包含seq、ack、窗口/buffer，tcp握手就是协商出来这些初始值。这些状态才是我们平时所说的tcp连接的本质。

这说明大部分程序员对问题的本质的理解上出了问题，或者教科书描述的过于教条不够接地气所以看完书本质没get到。

想想 `费曼学习方法` 中对**事物本质**的理解的重要性。

## 来看一个案例

我第一次看[RFC1180](https://tools.ietf.org/html/rfc1180)的时候是震惊的，觉得讲述的太好了，2000字就把一本教科书的知识阐述的无比清晰、透彻。但是实际上我发现很快就忘了，而且大部分程序员基本都是这样

> RFC1180写的确实很好，清晰简洁，图文并茂，结构逻辑合理，但是对于95%的程序员没有什么用，当时看的时候很爽、也觉得自己理解了、学会了，实际上看完几周后就忘得差不多了。问题出在这种RFC偏理论多一点看起来完全没有体感无法感同身受，所以即使似乎当时看懂了，但是忘得也快，需要一篇结合实践的文章来帮助理解

在这个问题上，让我深刻地理解到：

> 一流的人看RFC就够了，差一些的人看《TCP/IP卷1》，再差些的人要看一个个案例带出来的具体知识的书籍了，比如[《wireshark抓包艺术》](https://book.douban.com/subject/26268767/)，人和人的学习能力有差别必须要承认。

也就是我们要认识到每个个人的[学习能力的差异](https://mp.weixin.qq.com/s/JlXWLpQSyj3Z_KMyUmzBPA)，我超级认同这篇文章中的一个评论

> 看完深有感触，尤其是后面的知识效率和工程效率型的区别。以前总是很中二的觉得自己看一遍就理解记住了，结果一次次失败又怀疑自己的智商是不是有问题，其实就是把自己当作知识效率型来用了。一个不太恰当的形容就是，有颗公主心却没公主命！

嗯，大部分时候我们都觉得自己看一遍就理解了记住了能实用解决问题了，实际上了是马上忘了，停下来想想自己是不是这样的？在网络的相关知识上大部分看RFC、TCP卷1等东西是很难实际理解的，还是要靠实践来建立对知识的具体的理解，而网络相关的东西基本离大家有点远（大家不回去读tcp、ip源码，纯粹是靠对书本的理解），所以很难建立具体的概念，所以这里有个必杀技就是学会抓包和用wireshark看包，同时针对实际碰到的文题来抓包、看包分析。

比如我的这篇《[从计算机知识到落地能力，你欠缺了什么？](https://mp.weixin.qq.com/s/x-ScSwEm3uQ2SFv-nAzNaA)》就对上述问题最好的阐述，程序员最常碰到的网络问题就是网络为啥不通？

这是最好建立对网络知识具体理解和实践的机会，你把《[从计算机知识到落地能力，你欠缺了什么？](https://mp.weixin.qq.com/s/x-ScSwEm3uQ2SFv-nAzNaA)》实践完再去看[RFC1180](https://tools.ietf.org/html/rfc1180) 就明白了。通过案例把RFC1180抽象的描述给它具体化、场景化了，理解起来就很轻松不容易忘记了。

> 经验一: 通过具体的东西(案例、抓包)来建立对网络基础的理解

![image-20220221151815993](/images/951413iMgBlog/image-20220221151815993.png)

## 不要追求知识的广度

学习网络知识过程中，不建议每个知识点都去看，因为很快会忘记，我的方法是只看经常碰到的问题点，碰到一个点把他学透理解明白。

比如我曾经碰到过 [nslookup OK but ping fail–看看老司机是如何解决问题的，解决问题的方法肯定比知识点重要多了，同时透过一个问题怎么样通篇来理解一大块知识，让这块原理真正在你的知识体系中扎根下来](/2019/01/09/%E5%B0%B1%E6%98%AF%E8%A6%81%E4%BD%A0%E6%87%82ping--nslookup-OK-but-ping-fail/) , 这个问题Google上很多人在搜索，说明很普遍，但是没找到有资料能把这个问题说清楚，所以借着这个机会就把 Linux下的 NSS（name service switch）的原理搞懂了。要不然碰到问题老司机告诉你改下 /etc/hosts 或者  /etc/nsswitch 或者 /etc/resolv.conf 之类的问题就能解决，但是你一直不知道这三个文件怎么起作用的，也就是你碰到过这种问题也解决过但是下次碰到类似的问题你不一定能解决。

当然对我来说为了解决这个问题最后写了4篇跟域名解析相关的文章，从windows到linux，涉及到vpn、glibc、docker等各种场景，我把他叫做场景驱动。后来换来工作环境从windows换到mac后又补了一篇mac下的路由、dns文章。

关于[场景驱动学习的方法可以看这篇总结](https://mp.weixin.qq.com/s/JlXWLpQSyj3Z_KMyUmzBPA )



## TCP是最复杂的，要从实用出发

比如拥塞算法基本大家不会用到，了解下就行。还有拥塞窗口、慢启动，这个实际中碰到的概率不高，面试要问你基本上是属于炫技类型。实际碰到更多的是传输效率（[对BDP、Buffer、各种窗口、rt的理解和运用](https://mp.weixin.qq.com/s/fKWJrDNSAZjLsyobolIQKw)），还有为什么连不通、[连接建立不起来](https://mp.weixin.qq.com/s/yH3PzGEFopbpA-jw4MythQ)、为什么收到包不回复、为什么要reset、为什么丢包了之类的问题。

关于为什么连不通，我碰到了[这个问题](/2019/05/16/%E7%BD%91%E7%BB%9C%E9%80%9A%E4%B8%8D%E9%80%9A%E6%98%AF%E4%B8%AA%E5%A4%A7%E9%97%AE%E9%A2%98--%E5%8D%8A%E5%A4%9C%E9%B8%A1%E5%8F%AB/)，随后在这个问题的基础上进行了总结，得到客户端建立连接的时候抛异常，可能的原因（握手失败，建不上连接）：

-  网络不通，诊断：ping ip
-  端口不通,  诊断：telnet ip port
-  rp_filter 命中(rp_filter=1, 多网卡环境）， 诊断:  netstat -s | grep -i filter ;
-  snat/dnat的时候宿主机port冲突，内核会扔掉 syn包。诊断: sudo conntrack -S | grep  insert_failed //有不为0的
-  全连接队列满的情况，诊断： netstat -s | egrep "listen|LISTEN" 
-  syn flood攻击, 诊断：同上
-  若远端服务器的内核参数 net.ipv4.tcp_tw_recycle 和 net.ipv4.tcp_timestamps 的值都为 1，则远端服务器会检查每一个报文中的时间戳（Timestamp），若 Timestamp 不是递增的关系，不会响应这个报文。配置 NAT 后，远端服务器看到来自不同的客户端的源 IP 相同，但 NAT 前每一台客户端的时间可能会有偏差，报文中的 Timestamp 就不是递增的情况。nat后的连接，开启timestamp。因为快速回收time_wait的需要，会校验时间该ip上次tcp通讯的timestamp大于本次tcp(nat后的不同机器经过nat后ip一样，保证不了timestamp递增），诊断：是否有nat和是否开启了timestamps
-  NAT 哈希表满导致 ECS 实例丢包 nf_conntrack full， 诊断: dmesg |grep conntrack



## 总结

- 一定要会用tcpdump和wireshark（纯工具，没有任何门槛，用不好只有一个原因: 懒）
- 多实践（因为网络知识离我们有点远、有点抽象）,用好各种工具，工具能帮我们看到、摸到
- 不要追求知识面的广度，深抠几个具体的知识点然后让这些点建立体系
- 不要为那些基本用不到的偏门知识花太多精力，天天用的都学不过来对吧。