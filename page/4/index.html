<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"plantegg.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.26.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="java mysql tcp performance network docker Linux">
<meta property="og:type" content="website">
<meta property="og:title" content="plantegg">
<meta property="og:url" content="https://plantegg.github.io/page/4/index.html">
<meta property="og:site_name" content="plantegg">
<meta property="og:description" content="java mysql tcp performance network docker Linux">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="twitter @plantegg">
<meta property="article:tag" content="技术,编程,博客">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://plantegg.github.io/page/4/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>plantegg</title>
  








  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">plantegg</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">java tcp mysql performance network docker Linux</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">twitter @plantegg</p>
  <div class="site-description" itemprop="description">java mysql tcp performance network docker Linux</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">190</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">282</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2023/06/30/%E7%AD%89%E9%A2%9D%E6%9C%AC%E9%87%91%E5%92%8C%E7%AD%89%E9%A2%9D%E6%9C%AC%E6%81%AF%E4%BB%A5%E5%8F%8A%E6%8F%90%E5%89%8D%E8%BF%98%E8%B4%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="twitter @plantegg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
      <meta itemprop="description" content="java mysql tcp performance network docker Linux">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | plantegg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/30/%E7%AD%89%E9%A2%9D%E6%9C%AC%E9%87%91%E5%92%8C%E7%AD%89%E9%A2%9D%E6%9C%AC%E6%81%AF%E4%BB%A5%E5%8F%8A%E6%8F%90%E5%89%8D%E8%BF%98%E8%B4%B7/" class="post-title-link" itemprop="url">等额本息和等额本金以及提前还贷误区</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-06-30 12:30:03" itemprop="dateCreated datePublished" datetime="2023-06-30T12:30:03+08:00">2023-06-30</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-11-16 19:58:49" itemprop="dateModified" datetime="2025-11-16T19:58:49+08:00">2025-11-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E5%B7%A7/" itemprop="url" rel="index"><span itemprop="name">技巧</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="等额本息和等额本金以及提前还贷误区"><a href="#等额本息和等额本金以及提前还贷误区" class="headerlink" title="等额本息和等额本金以及提前还贷误区"></a>等额本息和等额本金以及提前还贷误区</h1><h5 id="1-等额本金和等额本息的差异"><a href="#1-等额本金和等额本息的差异" class="headerlink" title="1 等额本金和等额本息的差异"></a>1 等额本金和等额本息的差异</h5><p>没有差异。等额本金&#x3D;等额本息+每月提前还贷一点点()</p>
<h5 id="2-为什么等额本金总利息少"><a href="#2-为什么等额本金总利息少" class="headerlink" title="2 为什么等额本金总利息少"></a>2 为什么等额本金总利息少</h5><p>因为每个月等额本金还款多，第一个月后欠本金少了，后面每个月都是这样，所还本金更多，最终总利息自然更少</p>
<blockquote>
<p>其实可以用极限思维来分析他们的差异：假设等额本息和等额本金都借100万，周期一个月(没看错，一个月还清，极限假设)，所以一个月后他们还钱一样多！所以这个时候没有任何区别；现在继续假设，假如还款周期是2个月，那么等额本金在第一个月还钱多，导致等额本金在第二个月的时候欠钱少了，到第二个月月底还清所有欠款的时候利息要少(本金少了)——这才是他们的差异，所以是没区别的。等额本金这两个月相当于欠了银行150万一个月(第一个月欠100万，第二个月欠50万) 应还利息就是150万 乘以 月利率；等额本息相当于欠了银行 151万（第一个月欠100万，第二个月51万，因为第一个月还钱的时候只还了49万本金），所以应还利息就是 151万 乘以 月利率；欠得多利息就多天经地义这里没有投机、没有人吃亏</p>
<p>再或者换个思路：第一个月借100万，月底都还清，此时利息一样多；然后再借出来99.X万，这时等额本金借得少这个X更小，所以从第二个月开始等额本金还的利息少，归根结底换利息少是因为借得少(即现实中的还本金多)</p>
</blockquote>
<p>把上面的极限思维图形化就是下图中的灰色部分面积代表你的欠款(每个月的欠款累加)，等额本息的方式欠得多，自然利息多：</p>
<p><img src="/images/951413iMgBlog/image-20230704214346239.png" alt="image-20230704214346239"></p>
<h5 id="3-为什么总有等额本金划得来的说法"><a href="#3-为什么总有等额本金划得来的说法" class="headerlink" title="3 为什么总有等额本金划得来的说法"></a>3 为什么总有等额本金划得来的说法</h5><p>同样贷款金额下等额本金总还款额少，也就是总利息少，所以给了很多人划得来的感觉，或者给人感觉利息便宜。其实这都是错的，解释如上第二个问题</p>
<h5 id="4-利息的计算方式"><a href="#4-利息的计算方式" class="headerlink" title="4 利息的计算方式"></a>4 利息的计算方式</h5><p>利息每个月计算一次，这个月所欠本金*月利率。所以利息只和你欠钱多少有关（我们假设所有人的利率都一样）。每个月的月供，都是先还掉这个月的利息，多余的再还本金</p>
<p>等额本金因为每个月还掉的本金多，所以计算下来每个月的利息更少</p>
<h5 id="5-如何理解等额本金和等额本息"><a href="#5-如何理解等额本金和等额本息" class="headerlink" title="5 如何理解等额本金和等额本息"></a>5 如何理解等额本金和等额本息</h5><p>同样贷款额+利率的话等额本金开始还款一定比等额本息要多一些，那么你可以把等额本金分成两块，一块和等额本息一样，多出来的部分你把他看成这个月额外做了一次提前还款。你提前还款了后面的总利息自然也会更少一些，然后每个月的等额本息也会减少，以此类推每个月都是这样额外做一次提前还款直到最后一个月。</p>
<p>总结：等额本金&#x3D;等额本息+提前还贷</p>
<p>额本金开始还款一定比等额本息要多一些，可以把等额本金分成两块，一块和等额本息一样，多出来的部分把他看成这个月额外做了一次提前还款。提前还款后总利息也会更少一些，然后每个月的等额本息也会减少，以此类推每个月都是这样额外做一次提前还款直到最后一个月。</p>
<h5 id="6-提前还款划不划得来"><a href="#6-提前还款划不划得来" class="headerlink" title="6 提前还款划不划得来"></a>6 提前还款划不划得来</h5><p>钱在你手里没法赚到比利息更高的收益的话(99%的人属于这种)提前还贷划得来，之所以以前不建议大家提前还贷，是因为以前普遍涨薪快、通胀厉害、房价涨得块，把钱留出来继续买二套、三套更赚钱。另外钱留在手里会有主动权和应急方便</p>
<h5 id="7-提前还贷会多付利息吗？"><a href="#7-提前还贷会多付利息吗？" class="headerlink" title="7 提前还贷会多付利息吗？"></a>7 提前还贷会多付利息吗？</h5><p>不会，见第四条利息的计算方式。担心提前还贷的时候这比贷款把后面10年的利息收走了的是脑子不好使的人。但有些银行提前还贷会有违约金</p>
<h5 id="8-为什么等额本金和等额本息给了这么多人错觉"><a href="#8-为什么等额本金和等额本息给了这么多人错觉" class="headerlink" title="8 为什么等额本金和等额本息给了这么多人错觉"></a>8 为什么等额本金和等额本息给了这么多人错觉</h5><p>从知识的第一性出发，他们都没理解第4条，受社会普遍意识影响都预先留下了错误经验。本质就是利息只和贷款额、利率有关。</p>
<h5 id="9-贷款30年和10年利率有差异吗？"><a href="#9-贷款30年和10年利率有差异吗？" class="headerlink" title="9 贷款30年和10年利率有差异吗？"></a>9 贷款30年和10年利率有差异吗？</h5><p>没有</p>
<h5 id="10贷款30年，还了6年了，然后一次还清所有欠款会多还利息吗？"><a href="#10贷款30年，还了6年了，然后一次还清所有欠款会多还利息吗？" class="headerlink" title="10贷款30年，还了6年了，然后一次还清所有欠款会多还利息吗？"></a>10贷款30年，还了6年了，然后一次还清所有欠款会多还利息吗？</h5><p>不会，你前6年只是还了前6年的利息，没为之后的6年多付一分利息</p>
<h5 id="11-那为什么利率不变我每个月利息越来越少"><a href="#11-那为什么利率不变我每个月利息越来越少" class="headerlink" title="11 那为什么利率不变我每个月利息越来越少"></a>11 那为什么利率不变我每个月利息越来越少</h5><p>因为你欠的钱越来越少了，不是你提前还了利息，是你一直在还本金</p>
<h5 id="12-网购分期合适吗？"><a href="#12-网购分期合适吗？" class="headerlink" title="12 网购分期合适吗？"></a>12 网购分期合适吗？</h5><p>大部分小贷公司的套路就是利用你每个月已经在还本金的差异，利息自然越来越少，然后计算一个大概5%的年息误导你，实际这种网购分期的实际利息要是他计算的2倍……好好想想</p>
<p>等额本金、本息都搞不清楚的人就不要去搞分期了，你的脑瓜子在这方面不好使。</p>
<p>聪明人只看第4条就能在大脑里得出所有结论，普通人除了要有第4条还需要去看每个月的还款额、还款额里面的本金、还款额里的利息等实践输入才能理解这个问题，这就是差异</p>
<p><img src="/images/951413iMgBlog/%E6%88%BF%E8%B4%B7.jpg" alt="房贷"></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/161405128">https://zhuanlan.zhihu.com/p/161405128</a></p>
<h2 id="提前还贷"><a href="#提前还贷" class="headerlink" title="提前还贷"></a>提前还贷</h2><h5 id="要不要提前还贷"><a href="#要不要提前还贷" class="headerlink" title="要不要提前还贷"></a>要不要提前还贷</h5><p>要</p>
<h5 id="提前还贷划得来吗？"><a href="#提前还贷划得来吗？" class="headerlink" title="提前还贷划得来吗？"></a>提前还贷划得来吗？</h5><p>划不划得来要看这笔钱在你手里能否获得比房贷利息更高的收入以及你对流动资金的需要。其实万一有个啥事也可以走消费贷啥的，现在利息都很低</p>
<h5 id="等额本息比等额本金提前还贷更划得来？"><a href="#等额本息比等额本金提前还贷更划得来？" class="headerlink" title="等额本息比等额本金提前还贷更划得来？"></a>等额本息比等额本金提前还贷更划得来？</h5><p>一样的，你这个问题等价于我欠100万，老婆欠50万，所以我提前还贷比朋友合算吗？显然你两谁提前还贷合算只和你两的贷款利率是否有差别</p>
<p>等额本息和等额本金利率一样的，所以没有差别</p>
<h5 id="20年的房贷我已经还了15年了是不是不值得提前还贷了？"><a href="#20年的房贷我已经还了15年了是不是不值得提前还贷了？" class="headerlink" title="20年的房贷我已经还了15年了是不是不值得提前还贷了？"></a>20年的房贷我已经还了15年了是不是不值得提前还贷了？</h5><p>错误！利率还是那个利率，跟你还剩10年和还剩5年没关系，提前还贷都是等价的。记住有闲钱就提前还</p>
<h5 id="问题的本质"><a href="#问题的本质" class="headerlink" title="问题的本质"></a>问题的本质</h5><p>搞清楚每个月的利息怎么计算出来的  利息&#x3D;欠款额*月利率，月供都是把本月利息还掉多出来的还本金，也就是每个月欠款额会变少</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>每个领域都有一些核心知识点代表着这些问题的本质，你只有把核心知识点或者说问题本质搞懂了才能化繁为简、不被忽悠！</p>
<p>那贷款这里的本质是什么？就是利息只和你每个月欠款以及利率有关！这简直是屁话，太简单了，但你不能理解他，就容易被套上等额本金、等额本息、提前还贷的外壳给忽悠了。</p>
<p>再或者说这里的本质就是：你去搞清楚每个月的还款是怎么计算的。月供&#x3D;本月所欠X利率+本月还掉的本金  这是个核心公式，差别在每个月还掉的本金不一样！</p>
<p>就这样吧该懂的也该看懂了，看不懂的大概怎么样也看不懂！只能说是蠢，这些人肯定理科不好、逻辑不行，必定做不了程序员。</p>
<p>比如网上流传的如图总结的所有结论都是错的：</p>
<p><img src="/images/951413iMgBlog/image-20230704215506179.png" alt="image-20230704215506179"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2023/06/20/%E5%AE%9E%E6%88%98%E7%93%B6%E9%A2%88%E5%AE%9A%E4%BD%8D-%E6%88%91%E7%9A%84MySQL%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8E%8B%E4%B8%8D%E4%B8%8A%E5%8E%BB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="twitter @plantegg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
      <meta itemprop="description" content="java mysql tcp performance network docker Linux">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | plantegg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/20/%E5%AE%9E%E6%88%98%E7%93%B6%E9%A2%88%E5%AE%9A%E4%BD%8D-%E6%88%91%E7%9A%84MySQL%E4%B8%BA%E4%BB%80%E4%B9%88%E5%8E%8B%E4%B8%8D%E4%B8%8A%E5%8E%BB/" class="post-title-link" itemprop="url">实战瓶颈定位-我的MySQL为什么压不上去</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-06-20 17:30:03" itemprop="dateCreated datePublished" datetime="2023-06-20T17:30:03+08:00">2023-06-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-11-29 15:11:18" itemprop="dateModified" datetime="2025-11-29T15:11:18+08:00">2025-11-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/performance/" itemprop="url" rel="index"><span itemprop="name">performance</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="实战瓶颈定位-我的MySQL为什么压不上去"><a href="#实战瓶颈定位-我的MySQL为什么压不上去" class="headerlink" title="实战瓶颈定位-我的MySQL为什么压不上去"></a>实战瓶颈定位-我的MySQL为什么压不上去</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>环境两台云上相同 128C的EC2(有点豪)，一台当压力机一台当服务器，用Sysbench测试MySQL纯读场景，不存在任何修改，也就几乎没有锁</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#uname -r</span><br><span class="line">5.10.84.aarch64</span><br><span class="line"></span><br><span class="line">Server:            MySQL</span><br><span class="line">Server version:        8.0.18 Source distribution</span><br></pre></td></tr></table></figure>

<p>EC2机器128核，故意只给MySQLD绑定了其中的24Core，网卡32队列</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#ethtool -l eth0</span><br><span class="line">Channel parameters for eth0:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:        0</span><br><span class="line">TX:        0</span><br><span class="line">Other:        0</span><br><span class="line">Combined:    32</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:        0</span><br><span class="line">TX:        0</span><br><span class="line">Other:        0</span><br><span class="line">Combined:    32</span><br></pre></td></tr></table></figure>

<p><img src="/images/951413iMgBlog/FlDlXFTuGa0BPv1YxR3KQZaP40de.png" alt="img"></p>
<h2 id="压测过程"><a href="#压测过程" class="headerlink" title="压测过程"></a>压测过程</h2><p>走同一交换机内网IP压MySQL跑不满CPU，跑压力和不跑压力时ping rtt 分别是 0.859&#x2F;0.053(RTT 有增加–注意点), 此时TPS：119956.67 1000并发 RT 8.33</p>
<p>下图是压测时 htop 看到的MySQLD 所在EC2的 CPU使用情况，右边65-88是MySQLD进程(绿色表示us, 红色表示sys+si CPU)</p>
<p><img src="/images/951413iMgBlog/image-20230511125934259.png" alt="image-20230511125934259"></p>
<p>用top查看详细的每个 core 使用(只展示MySQLD使用的24core ，top 然后按1–还可以试试2&#x2F;3，有惊喜)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">top - 13:49:55 up 160 days, 18:10,  3 users,  load average: 555.26, 720.12, 462.21</span><br><span class="line">Tasks: 1065 total,   1 running, 499 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Node1 : 10.1 us,  5.3 sy,  0.0 ni, 83.3 id,  0.0 wa,  0.0 hi,  1.3 si,  0.0 st</span><br><span class="line">%Cpu64 : 29.3 us, 16.5 sy,  0.0 ni, 54.2 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu65 : 37.0 us, 18.5 sy,  0.0 ni, 26.9 id,  0.0 wa,  0.0 hi, 17.5 si,  0.0 st</span><br><span class="line">%Cpu66 : 34.2 us, 17.8 sy,  0.0 ni, 47.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu67 : 26.0 us, 15.1 sy,  0.0 ni, 58.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu68 : 26.1 us, 14.8 sy,  0.0 ni, 59.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu69 : 27.2 us, 13.8 sy,  0.0 ni, 59.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu70 : 25.7 us, 11.8 sy,  0.0 ni, 62.5 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu71 : 18.3 us, 10.6 sy,  0.0 ni, 71.1 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu72 : 29.7 us, 12.6 sy,  0.0 ni, 57.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu73 : 21.2 us, 13.0 sy,  0.0 ni, 65.9 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu74 : 18.9 us, 10.8 sy,  0.0 ni, 70.4 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu75 : 28.9 us, 15.1 sy,  0.0 ni, 36.1 id,  0.0 wa,  0.0 hi, 19.9 si,  0.0 st</span><br><span class="line">%Cpu76 : 30.3 us, 15.5 sy,  0.0 ni, 54.1 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu77 : 25.1 us, 13.2 sy,  0.0 ni, 61.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu78 : 18.2 us, 10.3 sy,  0.0 ni, 71.5 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu79 : 14.9 us,  8.8 sy,  0.0 ni, 76.3 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu80 : 23.4 us, 12.2 sy,  0.0 ni, 64.4 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu81 : 35.3 us, 17.6 sy,  0.0 ni, 30.2 id,  0.0 wa,  0.0 hi, 16.9 si,  0.0 st</span><br><span class="line">%Cpu82 : 28.2 us, 16.1 sy,  0.0 ni, 55.7 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu83 : 37.5 us, 16.9 sy,  0.0 ni, 27.0 id,  0.0 wa,  0.0 hi, 18.6 si,  0.0 st</span><br><span class="line">%Cpu84 : 35.4 us, 18.5 sy,  0.0 ni, 46.1 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu85 : 27.9 us, 16.8 sy,  0.0 ni, 55.2 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu86 : 28.2 us, 13.7 sy,  0.0 ni, 58.1 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu87 : 27.2 us, 11.0 sy,  0.0 ni, 61.8 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu88 :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br></pre></td></tr></table></figure>

<p>继续尝试用2000并发，TPS、CPU、ping rtt都和1000并发没有区别，当然按照我们以前QPS、RT理论2000并发的时候RT应该翻倍，实际确实是16.66，<strong>所以这里的问题就是翻倍的 RT哪里来的瓶颈就在哪里</strong>。</p>
<p>也试过用两个压力机每个压力机分别用1000并发同时压，QPS一样稳定——目的快速排除压力端、链路上有瓶颈。</p>
<p>写到这里RT 刚好翻倍16.66&#x3D;8.33*2 数字精准得好像编故事一样，不得不贴一下原始数据证实一下：</p>
<p><img src="/images/951413iMgBlog/image-20230511130851332.png" alt="image-20230511130851332"></p>
<p>1000 并发和2000并发时的ping RTT对比(ttl 64说明内网直达)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#ping mysqld27</span><br><span class="line">PING yt27 (mysqld217) 56(84) bytes of data.</span><br><span class="line">---以下是2000并发</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=1 ttl=64 time=0.867 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=2 ttl=64 time=0.952 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=3 ttl=64 time=0.849 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=4 ttl=64 time=0.857 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=5 ttl=64 time=0.987 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=6 ttl=64 time=0.860 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=7 ttl=64 time=0.909 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=8 ttl=64 time=0.875 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=9 ttl=64 time=0.979 ms  </span><br><span class="line">---终止压测，无无压力的rtt</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=10 ttl=64 time=0.104 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=11 ttl=64 time=0.079 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=12 ttl=64 time=0.075 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=13 ttl=64 time=0.075 ms </span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=14 ttl=64 time=0.074 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=15 ttl=64 time=0.078 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=16 ttl=64 time=0.075 ms</span><br><span class="line">---开启1000并发时的rtt</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=17 ttl=64 time=0.872 ms </span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=18 ttl=64 time=0.969 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=19 ttl=64 time=0.862 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=20 ttl=64 time=0.877 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=21 ttl=64 time=0.961 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=22 ttl=64 time=0.828 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=23 ttl=64 time=0.098 ms</span><br><span class="line">64 bytes from mysqld27 (mysqld217): icmp_seq=24 ttl=64 time=0.083 ms</span><br></pre></td></tr></table></figure>

<h3 id="抓包证明"><a href="#抓包证明" class="headerlink" title="抓包证明"></a>抓包证明</h3><p>在抓保证明前推荐一个工具快速绕过抓包(原理也是通过pcap lib去分析网络包，tcpdump也会调用pcap lib)</p>
<p><a target="_blank" rel="noopener" href="https://github.com/y123456yz/tcprstat">监控tcprstat</a>，从网络层抓包来对比两个并发下的RT：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">//./tcprstat -p 3307 -t 1 -n 0 -l 10.9.10.22 -f &quot;%T\t\t%n\t\t%a\t%h\t%S\t%C\t%95M\t%95a\t%95S\t%99M\t%99a\t%99S\n&quot;</span><br><span class="line">#tcprstat -p 14822 -t 1 -n 0 -l mysqld217 -f &quot;%T\t\t%n\t\t%a\n&quot;</span><br><span class="line">timestamp        count        avg</span><br><span class="line">1683785023        50743        626</span><br><span class="line">1683785024        120004        100</span><br><span class="line">1683785025        120051        103</span><br><span class="line">1683785026        120042        102</span><br><span class="line">1683785027        120031        103</span><br><span class="line">1683785028        120034        104</span><br><span class="line">1683785029        120034        104</span><br><span class="line">1683785030         55209        103    ---以上是2000并发</span><br><span class="line">1683785038        0        0</span><br><span class="line">1683785039        0        0</span><br><span class="line">1683785040         55224        614    ---以下是1000并发</span><br><span class="line">1683785041        119998        104</span><br><span class="line">1683785042        120039        105</span><br><span class="line">1683785043        120039        105</span><br><span class="line">1683785044        120026        107</span><br><span class="line">1683785045        120039        108</span><br><span class="line">1683785046        120047        108</span><br><span class="line">1683785047        120037        108</span><br><span class="line">1683785048        120032        108</span><br><span class="line">1683785049        120041        108</span><br></pre></td></tr></table></figure>

<p>也就是网卡层面<strong>确认了压不上去瓶颈不在MySQL</strong> 上，加并发后网卡的RT没变(网卡RT包含MySQLD RT)，因为ping RTT 在1000和2000并发也没有差异，推测交换机不是瓶颈，大概率出网卡的虚拟层面</p>
<p>在客户端的机器上抓包，上面我们说过了1000并发的RT是8.33毫秒：</p>
<p><img src="/images/951413iMgBlog/image-20230511141508811.png" alt="image-20230511141508811"></p>
<p>注意上图，我把RT排序了，明显看到5ms到17ms 中间没有这个RT范围的包，但是有很多25ms的RT，平均下来确实是8.33毫秒，留下一个疑问：RT分布不符合正态，而且中间有很大一段范围镂空了！这是不应该的。</p>
<p>同样我们再到MySQLD 所在机器抓包分析(注：正常路径先抓MySQLD上的包就行了)：</p>
<p><img src="/images/951413iMgBlog/image-20230511141925557.png" alt="image-20230511141925557"></p>
<p>同样是对RT 排序了，但是慢的RT都是对端发慢了(注意最右边的select， MySQL相应是 response)，同样对这个抓包求平均时间就是tcprstat 看到的103微秒，也就是0.1毫秒。如下图红框是请求，请求的间隔是11毫米，绿框是响应，响应的间隔都是0.2ms不到</p>
<p><img src="/images/951413iMgBlog/image-20230513084610300.png" alt="image-20230513084610300"></p>
<p>同样在2000并发时也对MySQLD所在网卡抓包对比，response 的RT 没有变化，从这里可以看出瓶颈点在sysbench 和 MySQLD 的网卡之间的链路上，似乎有限流、管控</p>
<img src="/images/951413iMgBlog/image-20230512084446715.png" alt="image-20230512084446715" style="zoom:35%;" />

<h3 id="快速验证"><a href="#快速验证" class="headerlink" title="快速验证"></a>快速验证</h3><p>到这里我们已经找到了有力的证据，RT是在离开MySQLD网卡后增加上去的，先验证下走走本机127.0.0.1快速压一把，让sysbench 跑在0-7 core上，这时可以看到MySQL跑满了CPU，下图左边1-8核是压力进程，右边65-88是业务进程，TPS：239969.91 1000并发 RT 4.16</p>
<p>htop状态：</p>
<p><img src="/images/951413iMgBlog/image-20230511125346066.png" alt="image-20230511125346066"></p>
<p>各CPU 详细分析：</p>
<ul>
<li>us MySQL解析SQL、处理查询</li>
<li>si  网络软中断</li>
<li>sy OS 的sys API 消耗，一般用户进程会调用系统 API, 比如读写文件、分配内存、网络访问等</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">//sysbench</span><br><span class="line">top - 13:44:27 up 160 days, 18:04,  3 users,  load average: 792.17, 619.09, 311.58</span><br><span class="line">Tasks: 1073 total,   1 running, 500 sleeping,   0 stopped,   0 zombie</span><br><span class="line">%Cpu0  : 14.0 us, 29.1 sy,  0.0 ni, 33.3 id,  0.0 wa,  0.0 hi, 23.5 si,  0.0 st</span><br><span class="line">%Cpu1  : 12.5 us, 33.0 sy,  0.0 ni, 33.7 id,  0.0 wa,  0.0 hi, 20.8 si,  0.0 st</span><br><span class="line">%Cpu2  : 11.2 us, 32.7 sy,  0.0 ni, 34.2 id,  0.0 wa,  0.0 hi, 21.9 si,  0.0 st</span><br><span class="line">%Cpu3  : 13.4 us, 31.2 sy,  0.0 ni, 34.4 id,  0.0 wa,  0.0 hi, 21.0 si,  0.0 st</span><br><span class="line">%Cpu4  : 12.1 us, 31.3 sy,  0.0 ni, 34.2 id,  0.0 wa,  0.0 hi, 22.4 si,  0.0 st</span><br><span class="line">%Cpu5  : 10.5 us, 31.8 sy,  0.0 ni, 33.6 id,  0.0 wa,  0.0 hi, 24.1 si,  0.0 st</span><br><span class="line">%Cpu6  : 12.9 us, 31.3 sy,  0.0 ni, 34.2 id,  0.0 wa,  0.0 hi, 21.6 si,  0.0 st</span><br><span class="line">%Cpu7  : 12.3 us, 31.4 sy,  0.0 ni, 34.3 id,  0.0 wa,  0.0 hi, 22.0 si,  0.0 st</span><br><span class="line">%Cpu8  :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line"></span><br><span class="line">//MySQLD</span><br><span class="line">Tasks: 1073 total,   1 running, 505 sleeping,   0 stopped,   1 zombie</span><br><span class="line">%Node1 : 22.6 us, 10.1 sy,  0.0 ni, 62.4 id,  0.0 wa,  0.0 hi,  4.8 si,  0.0 st</span><br><span class="line">%Cpu64 : 57.9 us, 29.1 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 12.9 si,  0.0 st</span><br><span class="line">%Cpu65 : 60.3 us, 26.2 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 13.6 si,  0.0 st</span><br><span class="line">%Cpu66 : 57.6 us, 28.1 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 14.2 si,  0.0 st</span><br><span class="line">%Cpu67 : 60.9 us, 25.5 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 13.6 si,  0.0 st</span><br><span class="line">%Cpu68 : 59.9 us, 26.2 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 13.9 si,  0.0 st</span><br><span class="line">%Cpu69 : 57.9 us, 27.5 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 14.6 si,  0.0 st</span><br><span class="line">%Cpu70 : 61.3 us, 26.2 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 12.6 si,  0.0 st</span><br><span class="line">%Cpu71 : 64.0 us, 23.4 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 12.5 si,  0.0 st</span><br><span class="line">%Cpu72 : 61.3 us, 26.8 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 11.9 si,  0.0 st</span><br><span class="line">%Cpu73 : 63.0 us, 22.8 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 14.2 si,  0.0 st</span><br><span class="line">%Cpu74 : 61.4 us, 27.4 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 11.2 si,  0.0 st</span><br><span class="line">%Cpu75 : 63.9 us, 26.5 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  9.6 si,  0.0 st</span><br><span class="line">%Cpu76 : 61.3 us, 27.2 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 11.6 si,  0.0 st</span><br><span class="line">%Cpu77 : 55.0 us, 30.5 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 14.6 si,  0.0 st</span><br><span class="line">%Cpu78 : 60.9 us, 26.8 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 12.3 si,  0.0 st</span><br><span class="line">%Cpu79 : 58.4 us, 26.7 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 14.9 si,  0.0 st</span><br><span class="line">%Cpu80 : 58.7 us, 29.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 12.2 si,  0.0 st</span><br><span class="line">%Cpu81 : 62.6 us, 27.2 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 10.3 si,  0.0 st</span><br><span class="line">%Cpu82 : 61.9 us, 25.5 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 12.6 si,  0.0 st</span><br><span class="line">%Cpu83 : 58.7 us, 27.4 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 13.9 si,  0.0 st</span><br><span class="line">%Cpu84 : 59.4 us, 27.7 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 12.9 si,  0.0 st</span><br><span class="line">%Cpu85 : 58.9 us, 28.5 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 12.6 si,  0.0 st</span><br><span class="line">%Cpu86 : 58.4 us, 28.4 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 13.2 si,  0.0 st</span><br><span class="line">%Cpu87 : 61.1 us, 27.4 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 11.6 si,  0.0 st</span><br></pre></td></tr></table></figure>

<p>就以上sysbench VS  MySQLD 的CPU 消耗来看，因为sysbench 处理逻辑简单，就是发SQL给MySQLD，所以 sysbench自身US很少，大部分都是调用OS的网络操作，而MySQLD有 60% CPU用于US，也就是自身业务逻辑，MySQLD收到SQL要做SQL解析，要去查找数据，这些都是用户态消耗，找到数据后走网络发给Sysbench，这部分是sy </p>
<p>到这里可以拿着证据去VIP通道(土豪+专业的客户得有VIP通道)找做网络管控的了，不会再有撕逼和甩锅</p>
<h3 id="sysbench-结果不是正态分布"><a href="#sysbench-结果不是正态分布" class="headerlink" title="sysbench 结果不是正态分布"></a>sysbench 结果不是正态分布</h3><p>把所有请求RT 分布进行图形化，此时平均 RT 8.33，理论上是一个正态分布，下图是有限速时：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"> 3.615 |                                         2177</span><br><span class="line"> 3.681 |**                                       14738</span><br><span class="line"> 3.748 |*******                                  55690</span><br><span class="line"> 3.816 |*************                            109713</span><br><span class="line"> 3.885 |***************                          121830</span><br><span class="line"> 3.956 |***************                          124851</span><br><span class="line"> 4.028 |*******************                      154927</span><br><span class="line"> 4.101 |***********************                  188826</span><br><span class="line"> 4.176 |***************************              226206</span><br><span class="line"> 4.252 |************************************     302617</span><br><span class="line"> 4.329 |**************************************** 333310  //这里以4.329为中心符合正态</span><br><span class="line"> 4.407 |*******************************          257048</span><br><span class="line"> 4.487 |********************                     163100</span><br><span class="line"> 4.569 |************                             101785</span><br><span class="line"> 4.652 |********                                 63871</span><br><span class="line"> 4.737 |*****                                    43998</span><br><span class="line"> 4.823 |*****                                    40854</span><br><span class="line"> 4.910 |*****                                    42189</span><br><span class="line"> 4.999 |*****                                    41182</span><br><span class="line"> 5.090 |****                                     35652</span><br><span class="line"> 5.183 |****                                     30343</span><br><span class="line"> 5.277 |***                                      28573</span><br><span class="line"> 5.373 |***                                      24763</span><br><span class="line"> 5.470 |***                                      22210</span><br><span class="line"> 5.570 |***                                      21808</span><br><span class="line"> 5.671 |***                                      25606</span><br><span class="line"> 5.774 |***                                      26994</span><br><span class="line"> 5.879 |***                                      24672</span><br><span class="line"> 5.986 |***                                      22087</span><br><span class="line"> 6.095 |**                                       18466</span><br><span class="line"> 6.205 |**                                       14822</span><br><span class="line"> 6.318 |**                                       13688</span><br><span class="line"> 6.433 |**                                       15381</span><br><span class="line"> 6.550 |**                                       13573</span><br><span class="line"> 6.669 |*                                        11325</span><br><span class="line"> 6.790 |*                                        9442</span><br><span class="line"> 6.913 |*                                        7412</span><br><span class="line"> 省略一大堆</span><br><span class="line">20.736 |*                                        11407</span><br><span class="line">21.112 |*                                        9755</span><br><span class="line">21.496 |*                                        8957</span><br><span class="line">21.886 |*                                        9434</span><br><span class="line">22.284 |*                                        9715</span><br><span class="line">22.689 |**                                       12774</span><br><span class="line">23.101 |**                                       17000</span><br><span class="line">23.521 |***                                      22937</span><br><span class="line">23.948 |*****                                    40401</span><br><span class="line">24.384 |********                                 65370</span><br><span class="line">24.827 |**********                               82186</span><br><span class="line">25.278 |**********                               85505</span><br><span class="line">25.737 |***********                              94347 //以25.7附近大概又是一个新正态</span><br><span class="line">26.205 |**********                               82958</span><br><span class="line">26.681 |****                                     30760</span><br><span class="line">27.165 |                                         2222</span><br><span class="line">27.659 |                                         69</span><br><span class="line">28.162 |                                         16</span><br><span class="line">28.673 |                                         15</span><br><span class="line">29.194 |                                         20</span><br><span class="line">29.725 |                                         17       </span><br></pre></td></tr></table></figure>

<p>去掉限速后平均 RT 3.26(比下图中大概的中位数2.71大了不少)  完美正态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">1.857 |**                                       19894</span><br><span class="line">1.891 |***                                      23569</span><br><span class="line">1.925 |***                                      27912</span><br><span class="line">1.960 |****                                     33720</span><br><span class="line">1.996 |****                                     39892</span><br><span class="line">2.032 |*****                                    48289</span><br><span class="line">2.069 |******                                   57649</span><br><span class="line">2.106 |********                                 69437</span><br><span class="line">2.145 |*********                                83611</span><br><span class="line">2.184 |***********                              99507</span><br><span class="line">2.223 |*************                            119275</span><br><span class="line">2.264 |****************                         141013</span><br><span class="line">2.305 |*******************                      165450</span><br><span class="line">2.347 |**********************                   191778</span><br><span class="line">2.389 |*************************                219706</span><br><span class="line">2.433 |****************************             250885</span><br><span class="line">2.477 |*******************************          278379</span><br><span class="line">2.522 |**********************************       303931</span><br><span class="line">2.568 |*************************************    325777</span><br><span class="line">2.615 |***************************************  342948</span><br><span class="line">2.662 |**************************************** 354029</span><br><span class="line">2.710 |**************************************** 356295</span><br><span class="line">2.760 |**************************************** 353068</span><br><span class="line">2.810 |**************************************   341345</span><br><span class="line">2.861 |************************************     324600</span><br><span class="line">2.913 |**********************************       303525</span><br><span class="line">2.966 |*******************************          280221</span><br><span class="line">3.020 |*****************************            255042</span><br><span class="line">3.075 |**************************               230861</span><br><span class="line">3.130 |***********************                  206909</span><br><span class="line">3.187 |*********************                    184616</span><br><span class="line">3.245 |*******************                      164903</span><br><span class="line">3.304 |****************                         146199</span><br><span class="line">3.364 |***************                          131427</span><br><span class="line">3.425 |*************                            117059</span><br><span class="line">3.488 |************                             104954</span><br><span class="line">3.551 |***********                              94404</span><br><span class="line">3.615 |*********                                83739</span><br><span class="line">3.681 |********                                 75705</span><br><span class="line">3.748 |********                                 67944</span><br><span class="line">3.816 |*******                                  60727</span><br><span class="line">3.885 |******                                   53757</span><br><span class="line">3.956 |*****                                    47053</span><br><span class="line">4.028 |*****                                    42130</span><br><span class="line">4.101 |****                                     38069</span><br><span class="line">4.176 |****                                     33666</span><br><span class="line">4.252 |***                                      30048</span><br><span class="line">4.329 |***                                      26923</span><br><span class="line">4.407 |***                                      23886</span><br><span class="line">4.487 |**                                       21615</span><br><span class="line">4.569 |**                                       19897</span><br><span class="line">4.652 |**                                       18458</span><br><span class="line">4.737 |**                                       17729</span><br><span class="line">4.823 |**                                       17041</span><br><span class="line">4.910 |**                                       16011</span><br><span class="line">4.999 |**                                       16099</span><br><span class="line">5.090 |**                                       16090</span><br><span class="line">5.183 |**                                       16393</span><br><span class="line">5.277 |**                                       16729</span><br><span class="line">5.373 |**                                       17412</span><br></pre></td></tr></table></figure>

<h2 id="用其他网络业务验证"><a href="#用其他网络业务验证" class="headerlink" title="用其他网络业务验证"></a>用其他网络业务验证</h2><p>先测试一下网络下载时的ping：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">--无流量</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=11 ttl=64 time=0.075 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=12 ttl=64 time=0.080 ms</span><br><span class="line">--从有网络限速的机器下载，带宽100MB</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=13 ttl=64 time=0.738 ms </span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=14 ttl=64 time=0.873 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=15 ttl=64 time=0.993 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=16 ttl=64 time=0.859 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=17 ttl=64 time=0.892 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=18 ttl=64 time=0.972 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=19 ttl=64 time=1.05 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=20 ttl=64 time=0.973 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=21 ttl=64 time=0.997 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=22 ttl=64 time=0.915 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=23 ttl=64 time=0.892 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=24 ttl=64 time=0.960 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=25 ttl=64 time=1.05 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=26 ttl=64 time=0.089 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=27 ttl=64 time=0.097 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=28 ttl=64 time=0.081 ms </span><br><span class="line">--从没有网络限速的机器下载，带宽1000MB</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=29 ttl=64 time=0.078 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=30 ttl=64 time=0.077 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=31 ttl=64 time=0.073 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=32 ttl=64 time=0.072 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=33 ttl=64 time=0.079 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=34 ttl=64 time=0.074 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=35 ttl=64 time=0.080 ms</span><br><span class="line">64 bytes from 172.16.0.205: icmp_seq=36 ttl=64 time=0.077 ms</span><br></pre></td></tr></table></figure>

<p>有限速方向，尝试了BBR和cubic 拥塞算法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">#tcpperf -c 172.16.0.205 -t 100</span><br><span class="line">Connected mysqld217:51254 -&gt; 172.16.0.205:2009, congestion control: cubic</span><br><span class="line">Time (s)  Throughput   Bitrate    Cwnd    Rwnd  sndbuf  ssthresh  Retr  CA  Pacing  rtt/var</span><br><span class="line">  0.000s   0.00kB/s   0.00kbps  14.3Ki  41.3Ki  85.0Ki    2048Mi     0   0  65.2Mi  427us/213</span><br><span class="line">  1.029s    122MB/s    975Mbps  1595Ki  1595Ki  9512Ki     576Ki     0   0   123Mi  15.2ms/8</span><br><span class="line">  2.005s    105MB/s    843Mbps  1595Ki  1595Ki  9512Ki     576Ki     0   0   123Mi  15.2ms/10</span><br><span class="line">  3.010s    105MB/s    843Mbps  1595Ki  1595Ki  9512Ki     576Ki     0   0   123Mi  15.2ms/17</span><br><span class="line">  4.016s    105MB/s    843Mbps  1595Ki  1595Ki  9512Ki     576Ki     0   0   123Mi  15.2ms/13</span><br><span class="line">  5.022s    105MB/s    843Mbps  1595Ki  1595Ki  9512Ki     576Ki     0   0   123Mi  15.2ms/14</span><br><span class="line">  6.028s    105MB/s    842Mbps  1595Ki  1595Ki  9512Ki     576Ki     0   0   123Mi  15.2ms/17</span><br><span class="line">  7.003s    105MB/s    843Mbps  1595Ki  1595Ki  9512Ki     576Ki     0   0   123Mi  15.2ms/15</span><br><span class="line">  8.009s    105MB/s    843Mbps  1595Ki  1595Ki  9512Ki     576Ki     0   0   123Mi  15.2ms/13</span><br><span class="line"> #tcpperf -c 172.16.0.205 -t 100</span><br><span class="line">Connected mysqld217:51932 -&gt; 172.16.0.205:2009, congestion control: bbr</span><br><span class="line">Time (s)  Throughput   Bitrate    Cwnd    Rwnd  sndbuf  ssthresh  Retr  CA  Pacing  rtt/var</span><br><span class="line">  0.000s   0.00kB/s   0.00kbps  14.3Ki  41.3Ki   128Ki    2048Mi     0   0  98.0Mi  406us/203</span><br><span class="line">  1.011s    120MB/s    957Mbps   271Ki  2281Ki  10.4Mi     560Ki  2244   0   108Mi  2427us/11</span><br><span class="line">  2.033s    104MB/s    831Mbps   271Ki  2281Ki  10.4Mi     560Ki  1056   0   109Mi  2417us/18</span><br><span class="line">  3.021s    104MB/s    830Mbps   274Ki  2281Ki  10.4Mi     560Ki  1056   0   109Mi  2428us/18</span><br><span class="line">  4.014s    103MB/s    827Mbps   271Ki  2281Ki  10.4Mi     560Ki  1452   0   108Mi  2423us/19</span><br><span class="line">  5.031s    104MB/s    835Mbps   274Ki  2281Ki  10.4Mi     560Ki   660   0  80.2Mi  2435us/22</span><br><span class="line">  6.033s    102MB/s    818Mbps   271Ki  2272Ki  10.4Mi     560Ki  2112   0   109Mi  2426us/17</span><br><span class="line">  7.030s    103MB/s    823Mbps   274Ki  2281Ki  10.4Mi     560Ki  1716   0   117Mi  2430us/18</span><br><span class="line">  8.023s    103MB/s    826Mbps   274Ki  2281Ki  10.4Mi     560Ki  1452   0   109Mi  2428us/20</span><br><span class="line">  9.016s    103MB/s    827Mbps   271Ki  2281Ki  10.4Mi     560Ki  1452   0   108Mi  2423us/15   </span><br></pre></td></tr></table></figure>

<p>跑tcpperf触发限速时的监控(上下两个窗口是同一台机器)，红色是丢包率挺高的，绿色丢包就没了，应该是拥塞算法和限速管控达成了平衡</p>
<p><img src="/images/951413iMgBlog/image-20230511215940306.png" alt="image-20230511215940306"></p>
<p>反过来限速被我去掉了(限速可以进出双向单独控制)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#tcpperf -c mysqld217 -t 1000</span><br><span class="line">Connected 172.16.0.205:32186 -&gt; mysqld217:2009, congestion control: bbr</span><br><span class="line">Time (s)  Throughput   Bitrate    Cwnd    Rwnd  sndbuf  ssthresh  Retr  CA  Pacing  rtt/var</span><br><span class="line">  0.000s   0.00kB/s   0.00kbps  14.3Ki  41.3Ki   128Ki    2048Mi     0   0   100Mi  397us/198</span><br><span class="line">  1.001s   1107MB/s   8859Mbps   471Ki   985Ki  4641Ki     277Ki     0   0  1083Mi  390us/22</span><br><span class="line">  2.001s   1103MB/s   8823Mbps   465Ki   985Ki  4641Ki     277Ki     0   0  1089Mi  393us/16</span><br><span class="line">  3.000s   1111MB/s   8892Mbps   465Ki   985Ki  4641Ki     277Ki     0   0  1072Mi  403us/25</span><br><span class="line">  4.000s   1099MB/s   8789Mbps   459Ki   985Ki  4794Ki     277Ki     0   0   799Mi  399us/18</span><br><span class="line">  5.001s   1098MB/s   8786Mbps   459Ki   985Ki  4794Ki     277Ki     0   0  1066Mi  387us/12</span><br><span class="line">  6.000s   1100MB/s   8799Mbps   462Ki   974Ki  4794Ki     277Ki     0   0  1069Mi  399us/16</span><br><span class="line">  7.001s   1135MB/s   9078Mbps   453Ki   985Ki  4794Ki     277Ki     0   0  1059Mi  377us/19</span><br></pre></td></tr></table></figure>

<p>查看限速配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;txcmbps:844.000, txckpps:120.000&#125;</span><br><span class="line"></span><br><span class="line">//限速解释</span><br><span class="line">0-31 我猜这是网卡队列(可以修改);</span><br><span class="line">txcmbps:844.000 105.5MB/s     每秒带宽105.5MB</span><br><span class="line">txckpps:120.000 120K packet/s 每秒12万网络包</span><br></pre></td></tr></table></figure>

<p>sysbench(主键查询-小包) 12万QPS 正好命中 txckpps:120，tcpperf (大包)稳定的105MB带宽命中txcmbps:844</p>
<p>去掉后长这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#ovsctl -n set_out_pps -v -1  //把pps限制为-1==不限制</span><br><span class="line">#ovsctl set_tx -p &#123;&#125; -r -1;   //带宽不限制</span><br><span class="line"></span><br><span class="line">&#123;vport:  2 &#123;map:  0, prio:L, weight:   0&#125;meter: &#123;-&#125;queue: [  0- 31L]&#125;</span><br></pre></td></tr></table></figure>

<p>对这块网络管控感兴趣可以去了解一下 ovs 这个开源项目(open virtual switch)</p>
<h3 id="去掉网卡限速后的结果"><a href="#去掉网卡限速后的结果" class="headerlink" title="去掉网卡限速后的结果"></a>去掉网卡限速后的结果</h3><p>实际结构如下：</p>
<p><img src="/images/951413iMgBlog/image-20230513132101185.png" alt="image-20230513132101185"></p>
<p>放开所有网络控制后，1000并发压力 30万QPS，RT 3.28，此时从sysbench 以及空闲机器ping MySQLD机器的 RTT和没压力基本一致</p>
<p><img src="/images/951413iMgBlog/image-20230512090205685.png" alt="image-20230512090205685"></p>
<p>top状态：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">%Node1 : 23.4 us, 12.3 sy,  0.0 ni, 61.4 id,  0.0 wa,  0.0 hi,  3.0 si,  0.0 st</span><br><span class="line">%Cpu64 : 63.2 us, 36.8 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu65 : 44.4 us, 21.9 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 33.8 si,  0.0 st</span><br><span class="line">%Cpu66 : 66.6 us, 33.4 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu67 : 63.4 us, 36.6 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu68 : 64.2 us, 35.8 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu69 : 64.9 us, 35.1 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu70 : 66.6 us, 33.4 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu71 : 65.3 us, 34.7 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu72 : 67.7 us, 32.3 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu73 : 63.6 us, 36.4 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu74 : 66.7 us, 33.3 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu75 : 42.4 us, 19.9 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 37.7 si,  0.0 st</span><br><span class="line">%Cpu76 : 63.9 us, 36.1 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu77 : 67.0 us, 33.0 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu78 : 68.3 us, 31.7 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu79 : 64.9 us, 35.1 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu80 : 65.2 us, 34.8 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu81 : 44.4 us, 21.5 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 34.1 si,  0.0 st</span><br><span class="line">%Cpu82 : 63.9 us, 36.1 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu83 : 44.2 us, 23.4 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi, 32.3 si,  0.0 st</span><br><span class="line">%Cpu84 : 65.7 us, 34.3 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu85 : 68.3 us, 31.7 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu86 : 67.5 us, 32.5 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu87 : 62.4 us, 37.6 sy,  0.0 ni,  0.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class="line">%Cpu88 :  0.0 us,  0.0 sy,  0.0 ni,100.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br></pre></td></tr></table></figure>

<p><img src="/images/951413iMgBlog/image-20230512092713141.png" alt="image-20230512092713141"></p>
<p>小思考：</p>
<blockquote>
<p>我们中间尝试走本机127.0.0.1 压测时QPS 是24万，比跨机器压的 30万打了8折，想想为什么？网络延时消耗完全没影响？</p>
</blockquote>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>简单可复制的证明办法：抓包，快速撕逼和分析</p>
<p>肯定有很多人想到：内存、磁盘、线程池、队列、网络等等原因，但是这些所有原因有一个共同的爹：RT，所有这些影响因素最后体现出来就是RT 高了，你CPU资源不够、内存慢最后总表现就是在客户端看来你的 RT 太高。</p>
<p>所以我们去掉这些复杂因素先在MySQLD所在EC2 的网卡上抓一个包看看RT，再对比一下1000&#x2F;2000并发时抓包看到的 RT 有没有升高，如果有升高说明问题在MySQLD这端(含OS、MySQLD的问题)，如果 RT 不变那么问题不在MySQLD这端，并且从EC2网卡出去都是很快的，那么问题只能是在路上或者客户端的sysbench自己慢了。</p>
<p>这是我们星球里说的无招胜有招–抓包大法，扯皮过程中我还没见过几个不认网络抓包的，也有那么一两个扯上是不是网卡驱动有问题，我的代码不会有问题</p>
<p>两个限速条件：pps 120k(每秒最多12万网络包)，带宽 844mbps&#x3D;105.5MB&#x2F;s</p>
<p>Sysbench 查询都是小包，触发第一个条件，tcpperf触发第二个条件</p>
<p>ping ping神功失效了吗？也没有，我后来又测试了100、200并发，rtt 0.2ms和0.4ms，也就是说随着并发的增加rtt 增加到0.8ms后就不再增加了。上来1000并发已经到了天花板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=159 ttl=64 time=0.226 ms</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=160 ttl=64 time=0.334 ms</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=161 ttl=64 time=0.336 ms</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=162 ttl=64 time=0.213 ms</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=163 ttl=64 time=0.104 ms</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=164 ttl=64 time=0.096 ms</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=165 ttl=64 time=0.101 ms</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=166 ttl=64 time=0.116 ms</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=167 ttl=64 time=0.104 ms--以上 100并发，QPS 119K</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=168 ttl=64 time=0.093 ms</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=169 ttl=64 time=0.088 ms</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=170 ttl=64 time=0.405 ms--以下 200并发，QPS 119K</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=171 ttl=64 time=0.419 ms</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=172 ttl=64 time=0.386 ms</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=173 ttl=64 time=0.474 ms</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=174 ttl=64 time=0.462 ms</span><br><span class="line">64 bytes from polardbxyt27 (mysqld217): icmp_seq=175 ttl=64 time=0.410 ms</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2023/06/08/Nginx%20reuseport%20%E5%AF%BC%E8%87%B4%E5%81%B6%E5%8F%91%E6%80%A7%E5%8D%A1%E9%A1%BF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="twitter @plantegg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
      <meta itemprop="description" content="java mysql tcp performance network docker Linux">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | plantegg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/06/08/Nginx%20reuseport%20%E5%AF%BC%E8%87%B4%E5%81%B6%E5%8F%91%E6%80%A7%E5%8D%A1%E9%A1%BF/" class="post-title-link" itemprop="url">Nginx reuseport 导致偶发性卡顿</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-06-08 17:30:03" itemprop="dateCreated datePublished" datetime="2023-06-08T17:30:03+08:00">2023-06-08</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-11-16 19:58:49" itemprop="dateModified" datetime="2025-11-16T19:58:49+08:00">2025-11-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/performance/" itemprop="url" rel="index"><span itemprop="name">performance</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Nginx-reuseport-导致偶发性卡顿"><a href="#Nginx-reuseport-导致偶发性卡顿" class="headerlink" title="Nginx reuseport 导致偶发性卡顿"></a>Nginx reuseport 导致偶发性卡顿</h1><p>by @橘橘球</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>从2018年开始，我们有个业务陆续接到反馈 Nginx 线上集群经常出现不响应或者偶发性的“超慢”请求。这种卡顿每天都有少量出现。而只有多个集群中的一个出现，其他压力更大的集群皆未出现。<br>业务结构比较简单：LVS-&gt;Nginx-&gt;后端，如图<br><img src="/images/951413iMgBlog/image-20230607103449616.png" alt="image-20230607103449616"></p>
<p>一些观察到的现象：</p>
<ul>
<li>出问题前不久升级 Nginx 配置，打开了 reuseport 功能</li>
<li>在压力大的后端（upstream）服务环境不容易出现，后端压力轻对应的Nginx卡顿概率更高</li>
<li>关闭 reuseport 后 问题少了很多</li>
<li>失败的请求响应时间都是 0ms（Nginx日志不靠谱了）</li>
<li>从 Nginx 日志上看，所有失败的健康检查请求都是0ms 的499 错误码（健康检查设置超时是2秒），但实际出问题的时候有5s-2分钟没有任何日志输出（Nginx卡了这么久）要么是Nginx卡住没去accept，要么是accept了没响应</li>
<li>所有超时来自同一个worker(一个Nginx服务一般按照机器核数开启多个worker)</li>
</ul>
<p>并且已知，卡顿的原因是打开 reuseport 后，新进来的请求可以由内核 hash 派发给一个 Nginx woker ，避免了锁争抢以及惊群。但如果网络条件足够好，压力足够低，Nginx worker 一直来不及读完 receive buffer 中的内容时，就无法切换并处理其他的 request，于是在新请求的客户端会观测不间断的卡顿，而压力大的后端由于网络传输慢，经常卡顿，Nginx worker 反而有时间能处理别的请求。在调小 receive buffer 人为制造卡顿后该问题得以解决。</p>
<h2 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h2><p>由于所述场景比较复杂，缺乏直接证据，打算通过构造一个较简单的环境来复现这个问题，并且在这个过程中抓包、观测Nginx worker的具体行为，验证这个假设。</p>
<h2 id="术语"><a href="#术语" class="headerlink" title="术语"></a>术语</h2><h3 id="快连接和慢连接"><a href="#快连接和慢连接" class="headerlink" title="快连接和慢连接"></a>快连接和慢连接</h3><ul>
<li>快连接：通常是传输时间短、传输量小的连接，耗时通常是ms级别</li>
<li>慢连接：通常是传输时间长、传输量大的连接，可以维持传输状态一段时间（如30s, 1min）</li>
</ul>
<p>在本次场景复现过程中，这两种连接都是短连接，每次请求开始前都需要三次握手建立连接，结束后都需要四次挥手销毁连接</p>
<h3 id="Epoll"><a href="#Epoll" class="headerlink" title="Epoll"></a>Epoll</h3><p>Nginx使用了epoll模型，epoll 是多路复用的一种实现。在多路复用的场景下，一个task（process）会批量处理多个socket，哪个来了数据就去读那个。这就意味着要公平对待所有这些socket，不能阻塞在任何socket的”数据读”上，也就是说不能在阻塞模式下针对任何socket调用recv&#x2F;recvfrom。  </p>
<p>epoll 每次循环为O(1) 操作，循环前会得到一个就绪队列，其中包含所有已经准备好的 socket stream（有数据可读），不需要循环全部 socket stream 读取数据，在循环后会将被读取数据的 stream 重新放回睡眠队列。睡眠队列中的 socket stream 有数据可读时，再唤醒加入到 就绪队列中。</p>
<p>epoll 伪代码 （不包含唤醒、睡眠）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">while(true) &#123;  </span><br><span class="line">    streamArr = getEpollReadyStream(); // 找到准备好的stream</span><br><span class="line">    for(Stream i: streamArr) &#123;         // 循环准备好的stream</span><br><span class="line">        doSomething();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="reuseport与惊群"><a href="#reuseport与惊群" class="headerlink" title="reuseport与惊群"></a>reuseport与惊群</h3><p>Nginx reuseport 选项解决惊群的问题：在 TCP 多进程&#x2F;线程场景中（B 图），服务端如果所有新连接只保存在一个 listen socket 的全连接队列中，那么多个进程&#x2F;线程去这个队列里获取（accept）新的连接，势必会出现多个进程&#x2F;线程对一个公共资源的争抢，争抢过程中，大量资源的损耗，也就会发生惊群现象。<br><img src="/images/951413iMgBlog/reuseport-explained.jpg" alt="img"><br>而开启reuseport后（C 图)，有多个 listener 共同 bind&#x2F;listen 相同的 IP&#x2F;PORT，也就是说每个进程&#x2F;线程有一个独立的 listener，相当于每个进程&#x2F;线程独享一个 listener 的全连接队列，新的连接请求由内核hash分配，不需要多个进程&#x2F;线程竞争某个公共资源，能充分利用多核，减少竞争的资源消耗，效率自然提高了。  </p>
<p>但同时也是由于这个分配机制，避免了上下文切换，在服务压力不大，网络情况足够好的情况下，进程&#x2F;线程更有可能专注于持续读取某个慢连接数据而忽视快连接建立的请求，从而造成快连接方卡顿。  </p>
<h2 id="复现过程"><a href="#复现过程" class="headerlink" title="复现过程"></a>复现过程</h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><ol>
<li>整体的架构是N个client-&gt;1个Nginx-&gt;N个server。因为卡顿原因和reuseport机制有关，和server数量无关，server数量设为任意数字都能复现，这里为了方便设成1。client数量设为2，为了将快连接和慢连接区分开便于抓包观测</li>
<li>用慢连接制造卡顿环境，用快连接观测卡顿。在快连接客户端进行观测和抓包</li>
<li>进程数量要足够少，使得同一个 worker 有几率分配到多个连接 <code>worker_processes 2</code></li>
<li>连接数目要足够多，慢连接数目&gt;&#x3D;进程数量，使得快连接在分配时，有一定概率分配到一个正在处理慢连接的worker上</li>
<li>reuseport: 这个配置要开启，卡顿现象才能观测到。<code>listen 8000 reuseport</code></li>
</ol>
<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">linux kernal version: 6.1  </span><br><span class="line">linux image: amazon/al2023-ami-2023.0.20230419.0-kernel-6.1-x86_64  </span><br><span class="line">instance type:  </span><br><span class="line">1X AWS t2.micro (1 vCPU, 1GiB RAM) – Nginx client(fast request)  </span><br><span class="line">3X AWS t3.micro (2 vCPU, 1GiB RAM) – Http server, Nginx server, Nginx client(slow request)  </span><br></pre></td></tr></table></figure>



<h3 id="复现操作"><a href="#复现操作" class="headerlink" title="复现操作"></a>复现操作</h3><ol>
<li>在server instance上放置一个 2GiB 大文件（0000000000000000.data）和一个 3MiB 小文件（server.pcap），并开启一个http server</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup python -m http.server 8000</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>在Nginx instance上安装、配置好Nginx，并启动Nginx (注意要绑核！)</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"># install</span><br><span class="line">sudo yum install nginx</span><br><span class="line"># config (/etc/nginx/nginx.conf)</span><br><span class="line">user nginx;</span><br><span class="line">worker_processes 2;</span><br><span class="line">error_log /var/log/nginx/error.log notice;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  &#x27;$remote_addr [$time_local] &quot;$request&quot; &#x27;</span><br><span class="line">                      &#x27;status=$status body_bytes_sent=$body_bytes_sent &#x27;</span><br><span class="line">                      &#x27;rt=$request_time uct=&quot;$upstream_connect_time&quot; uht=&quot;$upstream_header_time&quot; urt=&quot;$upstream_response_time&quot;&#x27;;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    keepalive_timeout   60;</span><br><span class="line">    types_hash_max_size 4096;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # Load modular configuration files from the /etc/nginx/conf.d directory.</span><br><span class="line">    # See http://nginx.org/en/docs/ngx_core_module.html#include</span><br><span class="line">    # for more information.</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       8000 reuseport;</span><br><span class="line">        server_name  server1;</span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">        # Load configuration files for the default server block.</span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line">        </span><br><span class="line">        location / &#123;</span><br><span class="line">        proxy_pass http://172.31.86.252:8000; # server ip</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">        location = /404.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">        location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"># start nginx</span><br><span class="line">sudo taskset -c 0 nginx</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>启动慢连接client，开启4个下载进程并计时，测试脚本<a target="_blank" rel="noopener" href="https://github.com/plantegg/programmer_case/blob/main/performance/Nginx%20reuseport%20%E5%AF%BC%E8%87%B4%E5%81%B6%E5%8F%91%E6%80%A7%E5%8D%A1%E9%A1%BF/script/get_big_file.sh">在此</a> </li>
<li>启动快连接client，开启1个下载进程并计时，抓包，测试脚本<a target="_blank" rel="noopener" href="https://github.com/plantegg/programmer_case/blob/main/performance/Nginx%20reuseport%20%E5%AF%BC%E8%87%B4%E5%81%B6%E5%8F%91%E6%80%A7%E5%8D%A1%E9%A1%BF/script/get_small_file.sh">在此</a><br>需要注意的是此处使用了curl –max-time 1，意味着即使1s内文件没有下载完，也会自动终止。</li>
<li>进入Nginx instance观察access.log</li>
<li>关掉reuseport或者调小recv buffer大小，重试一次</li>
</ol>
<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><p>ip maping:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">172.31.86.252: http server</span><br><span class="line">172.31.89.152: nginx server</span><br><span class="line">172.31.91.109: 快连接 client</span><br><span class="line">172.31.92.10:  慢连接 client</span><br></pre></td></tr></table></figure>
<ol>
<li>快连接client端：下载同一个小文件的下载时长有快有慢，方差很大，完整日志<a target="_blank" rel="noopener" href="https://github.com/plantegg/programmer_case/blob/main/performance/Nginx%20reuseport%20%E5%AF%BC%E8%87%B4%E5%81%B6%E5%8F%91%E6%80%A7%E5%8D%A1%E9%A1%BF/log-bench/client-runtime.txt">在此</a></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[2023-05-31 08:27:32,127] runtime=1010</span><br><span class="line">[2023-05-31 08:27:33,140] runtime=1009</span><br><span class="line">[2023-05-31 08:27:34,152] runtime=38</span><br><span class="line">[2023-05-31 08:27:34,192] runtime=1011</span><br><span class="line">[2023-05-31 08:27:35,205] runtime=37</span><br><span class="line">[2023-05-31 08:27:35,245] runtime=1008</span><br><span class="line">[2023-05-31 08:27:36,256] runtime=57</span><br><span class="line">[2023-05-31 08:27:36,315] runtime=1011</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>快连接client：无论耗时长短，抓包结果都显示存在不同程度卡顿，抓包文件<a target="_blank" rel="noopener" href="https://github.com/plantegg/programmer_case/blob/main/performance/Nginx%20reuseport%20%E5%AF%BC%E8%87%B4%E5%81%B6%E5%8F%91%E6%80%A7%E5%8D%A1%E9%A1%BF/log-bench/nginx-case-client.pcap">在此</a>  耗时长的下载过程<br><img src="/images/951413iMgBlog/benchmark-pkg-cature1.png" alt="img"><br>耗时短的下载过程<br><img src="/images/951413iMgBlog/benchmark-pkg-cature2.png" alt="img"></p>
</li>
<li><p>Nginx access.log 存在大量未下载完的200请求，和少量499请求，且499请求的耗时为0，access.log文件<a target="_blank" rel="noopener" href="https://github.com/plantegg/programmer_case/blob/main/performance/Nginx%20reuseport%20%E5%AF%BC%E8%87%B4%E5%81%B6%E5%8F%91%E6%80%A7%E5%8D%A1%E9%A1%BF/log-bench/access.log.txt">在此</a><br>卡顿的日志建立连接时长（utc）在0.3-0.4ms左右，超过1s的就出现499了</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">172.31.91.109 [31/May/2023:08:27:49 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=102195 rt=0.790 uct=&quot;0.413&quot; uht=&quot;0.592&quot; urt=&quot;0.791&quot;</span><br><span class="line">172.31.91.109 [31/May/2023:08:27:50 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=3602590 rt=0.058 uct=&quot;0.000&quot; uht=&quot;0.002&quot; urt=&quot;0.053&quot;</span><br><span class="line">172.31.91.109 [31/May/2023:08:27:51 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=499 body_bytes_sent=0 rt=0.000 uct=&quot;-&quot; uht=&quot;-&quot; urt=&quot;0.000&quot;</span><br><span class="line">172.31.91.109 [31/May/2023:08:27:51 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=102195 rt=0.763 uct=&quot;0.400&quot; uht=&quot;0.580&quot; urt=&quot;0.763&quot;</span><br><span class="line">172.31.91.109 [31/May/2023:08:27:52 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=102195 rt=0.767 uct=&quot;0.480&quot; uht=&quot;0.768&quot; urt=&quot;0.768&quot;</span><br><span class="line">172.31.91.109 [31/May/2023:08:27:53 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=580007 rt=0.773 uct=&quot;0.330&quot; uht=&quot;0.431&quot; urt=&quot;0.773&quot;</span><br><span class="line">172.31.91.109 [31/May/2023:08:27:55 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=499 body_bytes_sent=0 rt=0.000 uct=&quot;-&quot; uht=&quot;-&quot; urt=&quot;0.000&quot;</span><br><span class="line">172.31.91.109 [31/May/2023:08:27:55 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=499 body_bytes_sent=0 rt=0.000 uct=&quot;-&quot; uht=&quot;-&quot; urt=&quot;0.000&quot;</span><br></pre></td></tr></table></figure>
<p>下载中途被关闭的连接（200），可以观测到Nginx server在客户端已经请求FIN并被ACK之后仍然在发送一些网络数据包，客户端非常迷惑，向Nginx发送RST<br><img src="/images/951413iMgBlog/benchmark-pkg-cature3.png" alt="img"><br>未和Nginx建立连接就被关闭的连接（499），可以观测到连接始终没有被建立，在等待1s后客户端超时，主动请求关连接<br><img src="/images/951413iMgBlog/benchmark-pkg-cature4.png" alt="img"></p>
<ol start="4">
<li>限制Nginx server所在的instance的recv buffer大小，重新进行实验，可以观测到仍然有少量停顿，但整体耗时好了很多，不再有长达1s的卡顿，也不再有RST，完整日志<a target="_blank" rel="noopener" href="https://github.com/plantegg/programmer_case/blob/main/performance/Nginx%20reuseport%20%E5%AF%BC%E8%87%B4%E5%81%B6%E5%8F%91%E6%80%A7%E5%8D%A1%E9%A1%BF/log-exp1/">在此</a></li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sysctl -w net.ipv4.tcp_rmem=&quot;40960 40960 40960&quot;</span><br></pre></td></tr></table></figure>
<p>client runtime log: 耗时稳定在50-100ms，比无慢连接、纯跑快连接时要大一倍（25-50ms）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[2023-06-05 06:13:22,791] runtime=120</span><br><span class="line">[2023-06-05 06:13:22,913] runtime=82</span><br><span class="line">[2023-06-05 06:13:22,997] runtime=54</span><br><span class="line">[2023-06-05 06:13:23,054] runtime=61</span><br><span class="line">[2023-06-05 06:13:23,118] runtime=109</span><br><span class="line">[2023-06-05 06:13:23,229] runtime=58</span><br><span class="line">[2023-06-05 06:13:23,290] runtime=55</span><br><span class="line">[2023-06-05 06:13:23,347] runtime=79</span><br><span class="line">[2023-06-05 06:13:23,429] runtime=65</span><br><span class="line">[2023-06-05 06:13:23,497] runtime=53</span><br></pre></td></tr></table></figure>
<p>client 抓包结果：<br><img src="/images/951413iMgBlog/exp1-pkg-cature1.png" alt="img"><br>Nginx access.log: 都发完了，而且发得很流畅，建立连接时间（utc)非常短</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">172.31.91.109 [05/Jun/2023:06:13:22 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=3602590 rt=0.101 uct=&quot;0.001&quot; uht=&quot;0.004&quot; urt=&quot;0.101&quot;</span><br><span class="line">172.31.91.109 [05/Jun/2023:06:13:22 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=3602590 rt=0.064 uct=&quot;0.001&quot; uht=&quot;0.002&quot; urt=&quot;0.064&quot;</span><br><span class="line">172.31.91.109 [05/Jun/2023:06:13:23 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=3602590 rt=0.044 uct=&quot;0.000&quot; uht=&quot;0.001&quot; urt=&quot;0.044&quot;</span><br><span class="line">172.31.91.109 [05/Jun/2023:06:13:23 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=3602590 rt=0.047 uct=&quot;0.000&quot; uht=&quot;0.001&quot; urt=&quot;0.047&quot;</span><br><span class="line">172.31.91.109 [05/Jun/2023:06:13:23 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=3602590 rt=0.100 uct=&quot;0.000&quot; uht=&quot;0.001&quot; urt=&quot;0.099&quot;</span><br><span class="line">172.31.91.109 [05/Jun/2023:06:13:23 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=3602590 rt=0.047 uct=&quot;0.000&quot; uht=&quot;0.001&quot; urt=&quot;0.047&quot;</span><br><span class="line">172.31.91.109 [05/Jun/2023:06:13:23 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=3602590 rt=0.045 uct=&quot;0.001&quot; uht=&quot;0.002&quot; urt=&quot;0.045&quot;</span><br><span class="line">172.31.91.109 [05/Jun/2023:06:13:23 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=3602590 rt=0.066 uct=&quot;0.000&quot; uht=&quot;0.002&quot; urt=&quot;0.066&quot;</span><br></pre></td></tr></table></figure>
<p>对于慢连接大文件下载时长略有影响：46s (无限制) vs 53s (有限制)</p>
<ol start="5">
<li>关闭nginx reuseport</li>
</ol>
<p>卡顿依然大量存在，但大多以连接能够建立但是下载不完的形式（200）出现，499较少，并且存在惊群现象，完整日志<a target="_blank" rel="noopener" href="https://github.com/plantegg/programmer_case/blob/main/performance/Nginx%20reuseport%20%E5%AF%BC%E8%87%B4%E5%81%B6%E5%8F%91%E6%80%A7%E5%8D%A1%E9%A1%BF/log-exp2/">在此</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 8000;</span><br></pre></td></tr></table></figure>
<p>client runtime log：存在卡顿，和benchmark没有区别</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[2023-06-05 06:38:06,682] runtime=1008</span><br><span class="line">[2023-06-05 06:38:07,692] runtime=1008</span><br><span class="line">[2023-06-05 06:38:08,703] runtime=220</span><br><span class="line">[2023-06-05 06:38:08,926] runtime=112</span><br><span class="line">[2023-06-05 06:38:09,040] runtime=60</span><br><span class="line">[2023-06-05 06:38:09,103] runtime=865</span><br><span class="line">[2023-06-05 06:38:09,970] runtime=1009</span><br><span class="line">[2023-06-05 06:38:10,982] runtime=1008</span><br><span class="line">[2023-06-05 06:38:11,992] runtime=1009</span><br></pre></td></tr></table></figure>
<p>client抓包结果：存在卡顿，存在RST，和benchmark没有区别<br><img src="/images/951413iMgBlog/exp2-pkg-cature1.png" alt="img"><br><img src="/images/951413iMgBlog/exp2-pkg-cature2.png" alt="img"><br>access.log：卡顿的日志连接时间比benchmark略短，在0.2-0.3s左右，出现499的情况少了但是依然会有</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">172.31.91.109 [05/Jun/2023:06:38:02 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=204595 rt=0.844 uct=&quot;0.362&quot; uht=&quot;0.539&quot; urt=&quot;0.845&quot;</span><br><span class="line">172.31.91.109 [05/Jun/2023:06:38:03 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=204595 rt=0.907 uct=&quot;0.334&quot; uht=&quot;0.476&quot; urt=&quot;0.906&quot;</span><br><span class="line">172.31.91.109 [05/Jun/2023:06:38:04 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=543900 rt=0.836 uct=&quot;0.319&quot; uht=&quot;0.504&quot; urt=&quot;0.836&quot;</span><br><span class="line">172.31.91.109 [05/Jun/2023:06:38:05 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=204595 rt=0.831 uct=&quot;0.161&quot; uht=&quot;0.480&quot; urt=&quot;0.830&quot;</span><br><span class="line">172.31.91.109 [05/Jun/2023:06:38:06 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=552849 rt=0.820 uct=&quot;0.180&quot; uht=&quot;0.329&quot; urt=&quot;0.819&quot;</span><br><span class="line">172.31.91.109 [05/Jun/2023:06:38:07 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=204595 rt=0.800 uct=&quot;0.122&quot; uht=&quot;0.462&quot; urt=&quot;0.800&quot;</span><br><span class="line">172.31.91.109 [05/Jun/2023:06:38:08 +0000] &quot;GET /server.pcap HTTP/1.1&quot; status=200 body_bytes_sent=543900 rt=0.871 uct=&quot;0.251&quot; uht=&quot;0.380&quot; urt=&quot;0.871&quot;</span><br></pre></td></tr></table></figure>
<p>存在惊群现象，以下是Nginx worker进程的cpu使用率和上下文切换频率对比</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 每5s输出一次统计结果</span><br><span class="line">pidstat -w -u 5</span><br></pre></td></tr></table></figure>
<p>两者的cpu使用率和上下文切换频率差不多，但关闭reuseport后花在wait上的cpu时间明显增加（1.3-1.6% vs 2.8-2.9%），这就是惊群带来的性能损耗。原始文件：<a target="_blank" rel="noopener" href="https://github.com/plantegg/programmer_case/blob/main/performance/Nginx%20reuseport%20%E5%AF%BC%E8%87%B4%E5%81%B6%E5%8F%91%E6%80%A7%E5%8D%A1%E9%A1%BF/log-bench/pidstat.txt">开启reuseport</a>，<a target="_blank" rel="noopener" href="https://github.com/plantegg/programmer_case/blob/main/performance/Nginx%20reuseport%20%E5%AF%BC%E8%87%B4%E5%81%B6%E5%8F%91%E6%80%A7%E5%8D%A1%E9%A1%BF/log-exp2/pidstat.txt">关闭reuseport</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 开启reuseport</span><br><span class="line">Average:      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command</span><br><span class="line">Average:      992      2590    1.77    9.57    0.00    1.25   11.35     -  nginx</span><br><span class="line">Average:      992      2591    1.37    5.75    0.00    1.62    7.12     -  nginx</span><br><span class="line"></span><br><span class="line">Average:      UID       PID   cswch/s nvcswch/s  Command</span><br><span class="line">Average:      992      2590    179.18     49.64  nginx</span><br><span class="line">Average:      992      2591    342.51      9.87  nginx</span><br><span class="line"></span><br><span class="line"># 关闭reuseport</span><br><span class="line">Average:      UID       PID    %usr %system  %guest   %wait    %CPU   CPU  Command</span><br><span class="line">Average:      992      2788    1.02    8.02    0.00    2.80    9.04     -  nginx</span><br><span class="line">Average:      992      2789    0.92    9.07    0.00    2.97    9.99     -  nginx</span><br><span class="line"></span><br><span class="line">Average:      UID       PID   cswch/s nvcswch/s  Command</span><br><span class="line">Average:      992      2788    159.06     28.68  nginx</span><br><span class="line">Average:      992      2789    250.26     22.93  nginx</span><br></pre></td></tr></table></figure>
<p>惊群对于慢连接大文件下载时长略有影响：46s (开reuseport) vs 53s (关reuseport)</p>
<ol start="6">
<li>其他的观察</li>
</ol>
<p>最初复现的场景是所有的instance都是t2.micro，但开2个慢连接进程时比较难复现，开4个进程又太容易触发限流，所以开始考虑用大一些又没那么容易限流的instance型号。考虑到aws是通过间歇掉包来限速的，慢连接进程数量并非越大越好，引发限速后反而会造成网络连接不畅，造成慢连接卡顿，使得快连接卡顿反而不容易观测。最后选择将慢连接全链路改成t3.micro，结果好复现多了.  </p>
<p>可以观察到有一些access.log上499的连接，各种计时也是0，这其实是因为计时也是通过worker进行的，只有进行epoll和上下文切换才会在日志上打入时间信息，worker如果一直不进行切换，那么计时就会失真，就会看到日志上计时也是0的现象。  </p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><ol>
<li>reuseport是Nginx避免惊群的优秀feature，应该开启</li>
<li>开启reuseport后如果网络情况非常好且后端服务压力不大，且存在大量慢连接时，会造成快连接卡顿，这是Nginx的worker-epoll架构带来的，原因是recv buffer一直读不完，NGINX采用的epoll ET 触发模式在这种情况下一直无法触发暂停导致worker无法响应其它请求</li>
<li>减小recv buffer通过人为制造卡顿，提供了epoll ET切换连接的条件，可以很大程度上缓解这个问题，同时带来的负面效果是有一定性能损耗。但卡顿无法根除，只能控制在可接受范围内</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a target="_blank" rel="noopener" href="https://wenfh2020.com/2021/09/29/nginx-thundering-herd/">Nginx 惊群 – wenfh2020</a></li>
<li><a target="_blank" rel="noopener" href="https://wenfh2020.com/2021/10/12/thundering-herd-tcp-reuseport/">Nginx reuseport – wenfh2020</a></li>
<li><a target="_blank" rel="noopener" href="https://wenfh2020.com/2021/11/21/question-nginx-epoll-et/">Epoll – wenfh2020</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/my_captain/p/12667016.html">上下文切换的案例以及CPU使用率 – cnhkzyy</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2023/05/26/MySQL%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8D%A1%E9%A1%BF%E9%87%8D%E7%8E%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="twitter @plantegg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
      <meta itemprop="description" content="java mysql tcp performance network docker Linux">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | plantegg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/05/26/MySQL%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%8D%A1%E9%A1%BF%E9%87%8D%E7%8E%B0/" class="post-title-link" itemprop="url">MySQL线程池卡顿重现</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-05-26 17:30:03" itemprop="dateCreated datePublished" datetime="2023-05-26T17:30:03+08:00">2023-05-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-11-16 19:58:49" itemprop="dateModified" datetime="2025-11-16T19:58:49+08:00">2025-11-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL/" itemprop="url" rel="index"><span itemprop="name">MySQL</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MySQL线程池卡顿重现"><a href="#MySQL线程池卡顿重现" class="headerlink" title="MySQL线程池卡顿重现"></a>MySQL线程池卡顿重现</h1><p>by @wych42 </p>
<h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>为了激励大家多动手少空想，我在推特发起了白嫖我的<a target="_blank" rel="noopener" href="http://t.zsxq.com/0cz93XUPj">知识星球活动</a>：</p>
<blockquote>
<p>白嫖我星球的机会来了，总有人说贵、没有优惠券，这次直接来一个完全100%免费的机会，要求： 在MySQL的基础上重现某个线程池卡的现象，给出可复制的重现过程。就是因为某个线程池满了导致落到这个池里的查询一定都慢，否则都快。 不愿意出钱就动手吧</p>
</blockquote>
<p>参考现象：<a href="https://plantegg.github.io/2020/11/17/MySQL%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AF%BC%E8%87%B4%E7%9A%84%E5%BB%B6%E6%97%B6%E5%8D%A1%E9%A1%BF%E6%8E%92%E6%9F%A5/">https://plantegg.github.io/2020/11/17/MySQL%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%AF%BC%E8%87%B4%E7%9A%84%E5%BB%B6%E6%97%B6%E5%8D%A1%E9%A1%BF%E6%8E%92%E6%9F%A5/</a></p>
<hr>
<p>感谢推友<a target="_blank" rel="noopener" href="https://twitter.com/wych42">王鱼翅</a>同学，以下是他的教科书级的细致重现，你复制粘贴就能和他一样重现了</p>
<h2 id="这个案例的重要性"><a href="#这个案例的重要性" class="headerlink" title="这个案例的重要性"></a>这个案例的重要性</h2><p>这个现象对应我们年度四大案例之一，如下图左下角</p>
<p><img src="/images/951413iMgBlog/image-20230517082106489.png" alt="image-20230517082106489"></p>
<p>重现后请思考：</p>
<ol>
<li>MySQL为什么要将多个线程分成小池子，小池子肯定容易局部资源不足</li>
<li>Nginx 一个连接固定在一个worker上，那么同样多个Worker也会有不均衡(有的worker很闲，有的很卡)</li>
<li>动手实验一下将多个小池子改成一个大线程池会怎么样</li>
<li>Java ConcurrentHashMap为什么能够高性能</li>
</ol>
<p>由 @wych42 重现 </p>
<h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><p>根据 <a target="_blank" rel="noopener" href="https://www.brendangregg.com/usemethod.html">USE</a> 分析套路。看到服务端执行快，但是整体RT慢的现象，大概率是中间哪个位置有排队。根据文章里的描述，原因是在thread pool group中出现了排队。</p>
<p>排队的主要原因是服务端拒绝创建新的thread（worker），导致新进来的SQL需要等待前面的执行完成。那么就需要重点分析thread(worker)的创建过程和约束条件。根据文章和文档的说明，重点在thread_pool_size, thread_pool_oversubscribe, thread_pool_max_threads, thread_pool_stall_limit这几个参数上。</p>
<p>跟据文档分析和实际执行结果，这几个参数在MySQL不同的发型版中的行为逻辑是不尽相同的。核心差异在对创建新worker的限制条件上，后面复现也会根据两个发型版的特点分别执行。</p>
<h2 id="mariadb"><a href="#mariadb" class="headerlink" title="mariadb"></a>mariadb</h2><p><a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/thread-groups-in-the-unix-implementation-of-the-thread-pool/">文档</a></p>
<ul>
<li>通常情况下，新worker由listener worker创建</li>
<li>当timer worker检测到thread group 有stall时，可能会选择创建一个新的worker</li>
<li>worker的数量上限由thread_pool_max_threads限制</li>
<li>thread_pool_oversubscribe约束的是被额外创建出来的worker，在执行完任务后，最多能保留active状态的数量<blockquote>
<p>To clarify, the thread_pool_oversubscribe system variable does not play any part in the creation of new worker threads. The thread_pool_oversubscribe system variable is only used to determine how many worker threads should remain active in a thread group, once a thread group is already oversubscribed due to stalls.</p>
</blockquote>
</li>
</ul>
<h2 id="percona"><a href="#percona" class="headerlink" title="percona"></a>percona</h2><p><a target="_blank" rel="noopener" href="https://docs.percona.com/percona-server/8.0/performance/threadpool.html">文档</a></p>
<p>percona的行为更符合原文章里的说明：</p>
<ul>
<li>如果线程执行超过时间 thread_pool_stall_limit 的值，会被任务stalled，会创建一个新的线程执行排队的任务</li>
<li>thread_pool_oversubscribe 约束了每个thread group的线程数上限。</li>
</ul>
<h2 id="尝试复现"><a href="#尝试复现" class="headerlink" title="尝试复现"></a>尝试复现</h2><h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>并发向DB发起请求，观察客户端耗时，这些请求应当符合这些条件：</p>
<ul>
<li>可控的并发数量：以对比数据库服务端不同参数值的情况</li>
<li>有稳定的、相同的服务端执行耗时：以对比客户端在不同场景下的耗时</li>
<li>对服务端的硬件压力较小：避免因为并发不同时，因IO、CPU资源占用，影响服务端执行耗时</li>
</ul>
<p>综合考虑使用 <code>select sleep(2); </code>作为测试SQL。并发控制使用下面的golang代码实现。</p>
<p>再控制数据库服务端参数，运行同一个并发程序进行对比，mariadb和percona分析执行运行过程：</p>
<h2 id="复现执行"><a href="#复现执行" class="headerlink" title="复现执行"></a>复现执行</h2><h3 id="mariadb-1"><a href="#mariadb-1" class="headerlink" title="mariadb"></a>mariadb</h3><p>由上面分析可以，mariadb 中造成排队的约束是thread_pool_max_threads。</p>
<h4 id="执行方案"><a href="#执行方案" class="headerlink" title="执行方案"></a>执行方案</h4><ul>
<li>DB配置</li>
</ul>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">| thread_pool_max_threads                 | 6               |</span><br><span class="line">| thread_pool_oversubscribe               | 1               |</span><br><span class="line">| thread_pool_size                        | 1               |</span><br><span class="line">| thread_pool_stall_limit                 | 500             |</span><br></pre></td></tr></table></figure>
<ul>
<li>执行SQL <code>select sleep(2)</code></li>
<li>执行并发：8</li>
</ul>
<p>预期结果： 6个SQL执行的客户端观察耗时为2s；2个SQL为4s</p>
<p>若调整 thread_pool_max_threads&#x3D;8，则8个SQL的执行客户端观察耗时都为2s</p>
<h4 id="执行结果"><a href="#执行结果" class="headerlink" title="执行结果"></a>执行结果</h4><ol>
<li>thread_pool_max_threads&#x3D;6;concurrency&#x3D;8</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">go run ./main.go</span><br><span class="line">2023/05/16 13:34:51 starting taskId:task_3</span><br><span class="line">2023/05/16 13:34:51 starting taskId:task_1</span><br><span class="line">2023/05/16 13:34:51 starting taskId:task_6</span><br><span class="line">2023/05/16 13:34:51 starting taskId:task_4</span><br><span class="line">2023/05/16 13:34:51 starting taskId:task_0</span><br><span class="line">2023/05/16 13:34:51 starting taskId:task_7</span><br><span class="line">2023/05/16 13:34:51 starting taskId:task_2</span><br><span class="line">2023/05/16 13:34:51 starting taskId:task_5</span><br><span class="line">2023/05/16 13:34:53 taskId:task_0 exec cost : 2.021305666s</span><br><span class="line">2023/05/16 13:34:53 taskId:task_6 exec cost : 2.021421041s</span><br><span class="line">2023/05/16 13:34:53 taskId:task_3 exec cost : 2.021258917s</span><br><span class="line">2023/05/16 13:34:53 taskId:task_2 exec cost : 2.021275458s</span><br><span class="line">2023/05/16 13:34:53 taskId:task_4 exec cost : 2.021254083s</span><br><span class="line">2023/05/16 13:34:53 taskId:task_7 exec cost : 2.02146725s</span><br><span class="line">2023/05/16 13:34:55 taskId:task_5 exec cost : 4.021478584s</span><br><span class="line">2023/05/16 13:34:55 taskId:task_1 exec cost : 4.02192s</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>thread_pool_max_threads&#x3D;8;concurrency&#x3D;8</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">go run ./main.go</span><br><span class="line">2023/05/16 13:36:17 starting taskId:task_7</span><br><span class="line">2023/05/16 13:36:17 starting taskId:task_3</span><br><span class="line">2023/05/16 13:36:17 starting taskId:task_1</span><br><span class="line">2023/05/16 13:36:17 starting taskId:task_5</span><br><span class="line">2023/05/16 13:36:17 starting taskId:task_0</span><br><span class="line">2023/05/16 13:36:17 starting taskId:task_6</span><br><span class="line">2023/05/16 13:36:17 starting taskId:task_4</span><br><span class="line">2023/05/16 13:36:17 starting taskId:task_2</span><br><span class="line">2023/05/16 13:36:19 taskId:task_6 exec cost : 2.045480167s</span><br><span class="line">2023/05/16 13:36:19 taskId:task_2 exec cost : 2.045405667s</span><br><span class="line">2023/05/16 13:36:19 taskId:task_7 exec cost : 2.045507334s</span><br><span class="line">2023/05/16 13:36:19 taskId:task_1 exec cost : 2.04553075s</span><br><span class="line">2023/05/16 13:36:19 taskId:task_3 exec cost : 2.04554975s</span><br><span class="line">2023/05/16 13:36:19 taskId:task_0 exec cost : 2.045697375s</span><br><span class="line">2023/05/16 13:36:19 taskId:task_4 exec cost : 2.046417375s</span><br><span class="line">2023/05/16 13:36:19 taskId:task_5 exec cost : 2.046453792s</span><br></pre></td></tr></table></figure>

<p>均符合预期。</p>
<h3 id="percona-1"><a href="#percona-1" class="headerlink" title="percona"></a>percona</h3><p>由上面分析可以，percona中造成排队的约束是thread_pool_oversubscribe。</p>
<h4 id="执行方案-1"><a href="#执行方案-1" class="headerlink" title="执行方案"></a>执行方案</h4><ul>
<li>DB配置: thread_pool_max_threads设置一个较大的值，以排除影响。</li>
</ul>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">| thread_pool_max_threads                 | 1000               |</span><br><span class="line">| thread_pool_oversubscribe               | 1               |</span><br><span class="line">| thread_pool_size                        | 1               |</span><br><span class="line">| thread_pool_stall_limit                 | 500             |</span><br></pre></td></tr></table></figure>
<ul>
<li>执行SQL <code>select sleep(2)</code></li>
<li>执行并发：8</li>
</ul>
<p>预期结果： 客户端观察到的耗时分四个批次输出，每个批次2个SQL，耗时分别为2s,4s,6s,8s.</p>
<p>若调整 thread_pool_oversubscribe&#x3D;2，则三个批次输出，分别为3条SQL耗时均为2s，3条SQL耗时均为4s，2条SQL耗时均为6s</p>
<h4 id="执行结果-1"><a href="#执行结果-1" class="headerlink" title="执行结果"></a>执行结果</h4><ol>
<li>thread_pool_oversubscribe&#x3D;1,concurrency&#x3D;8</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">go run ./main.go</span><br><span class="line">2023/05/16 13:39:35 starting taskId:task_2</span><br><span class="line">2023/05/16 13:39:35 starting taskId:task_4</span><br><span class="line">2023/05/16 13:39:35 starting taskId:task_3</span><br><span class="line">2023/05/16 13:39:35 starting taskId:task_5</span><br><span class="line">2023/05/16 13:39:35 starting taskId:task_6</span><br><span class="line">2023/05/16 13:39:35 starting taskId:task_0</span><br><span class="line">2023/05/16 13:39:35 starting taskId:task_1</span><br><span class="line">2023/05/16 13:39:35 starting taskId:task_7</span><br><span class="line">2023/05/16 13:39:37 taskId:task_7 exec cost : 2.063547416s</span><br><span class="line">2023/05/16 13:39:37 taskId:task_0 exec cost : 2.064091541s</span><br><span class="line">2023/05/16 13:39:39 taskId:task_5 exec cost : 4.06672125s</span><br><span class="line">2023/05/16 13:39:39 taskId:task_6 exec cost : 4.066822583s</span><br><span class="line">2023/05/16 13:39:41 taskId:task_3 exec cost : 6.067720292s</span><br><span class="line">2023/05/16 13:39:41 taskId:task_2 exec cost : 6.069995s</span><br><span class="line">2023/05/16 13:39:43 taskId:task_4 exec cost : 8.069296042s</span><br><span class="line">2023/05/16 13:39:43 taskId:task_1 exec cost : 8.071391709s</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>thread_pool_oversubscribe&#x3D;2,concurrency&#x3D;8</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">go run ./main.go</span><br><span class="line">2023/05/16 13:41:02 starting taskId:task_7</span><br><span class="line">2023/05/16 13:41:02 starting taskId:task_1</span><br><span class="line">2023/05/16 13:41:02 starting taskId:task_3</span><br><span class="line">2023/05/16 13:41:02 starting taskId:task_2</span><br><span class="line">2023/05/16 13:41:02 starting taskId:task_5</span><br><span class="line">2023/05/16 13:41:02 starting taskId:task_6</span><br><span class="line">2023/05/16 13:41:02 starting taskId:task_4</span><br><span class="line">2023/05/16 13:41:02 starting taskId:task_0</span><br><span class="line">2023/05/16 13:41:04 taskId:task_1 exec cost : 2.057093667s</span><br><span class="line">2023/05/16 13:41:04 taskId:task_3 exec cost : 2.057156334s</span><br><span class="line">2023/05/16 13:41:04 taskId:task_5 exec cost : 2.057170667s</span><br><span class="line">2023/05/16 13:41:06 taskId:task_6 exec cost : 4.066917041s</span><br><span class="line">2023/05/16 13:41:06 taskId:task_7 exec cost : 4.066944125s</span><br><span class="line">2023/05/16 13:41:06 taskId:task_2 exec cost : 4.066976875s</span><br><span class="line">2023/05/16 13:41:08 taskId:task_4 exec cost : 6.070653125s</span><br><span class="line">2023/05/16 13:41:08 taskId:task_0 exec cost : 6.070612083s</span><br></pre></td></tr></table></figure>

<p>均符合预期。</p>
<h3 id="real-world-模拟（percona）版本"><a href="#real-world-模拟（percona）版本" class="headerlink" title="real-world 模拟（percona）版本"></a>real-world 模拟（percona）版本</h3><p>现实场景中，很少会有大批量的2s在SQL在生产环境执行（限互联网业务)，上述的分析过程能否在真实场景中验证呢？尝试用一个执行200ms的SQL来模拟下：</p>
<ul>
<li>DB配置: thread_pool_max_threads设置一个较大的值，以排除影响。</li>
</ul>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">| thread_pool_max_threads                 | 1000               |</span><br><span class="line">| thread_pool_oversubscribe               | 1               |</span><br><span class="line">| thread_pool_size                        | 1               |</span><br><span class="line">| thread_pool_stall_limit                 | 500             |</span><br></pre></td></tr></table></figure>
<ul>
<li>执行SQL <code>select sleep(0.2)</code></li>
<li>执行并发：10</li>
</ul>
<p>从执行结果中可以看到，只有第一条SQL按照预期的时间执行完成了。<br>从抓包结果中可以看到，所有SQL几乎是同时发出。观察最慢的一条SQL,但是从客户端发包到服务端响应包发出的耗时，与客户端观察到的耗时也能对应上。</p>
<p>可以验证上述分析过程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2023/05/16 14:47:47 taskId:task_1 exec cost : 239.34925ms</span><br><span class="line">2023/05/16 14:47:47 taskId:task_9 exec cost : 239.560833ms</span><br><span class="line">2023/05/16 14:47:47 taskId:task_5 exec cost : 453.795084ms</span><br><span class="line">2023/05/16 14:47:47 taskId:task_3 exec cost : 458.0005ms</span><br><span class="line">2023/05/16 14:47:47 taskId:task_6 exec cost : 659.441541ms</span><br><span class="line">2023/05/16 14:47:47 taskId:task_8 exec cost : 659.660917ms</span><br><span class="line">2023/05/16 14:47:47 taskId:task_0 exec cost : 862.526375ms</span><br><span class="line">2023/05/16 14:47:47 taskId:task_7 exec cost : 864.450042ms</span><br><span class="line">2023/05/16 14:47:48 taskId:task_2 exec cost : 1.063766875s</span><br><span class="line">2023/05/16 14:47:48 taskId:task_4 exec cost : 1.066266041s</span><br></pre></td></tr></table></figure>

<p><img src="/images/951413iMgBlog/238557399-c92e2c4e-436f-4f89-ba87-48c49b5393ac.png" alt="send_sql"></p>
<p><img src="/images/951413iMgBlog/238557635-1209f057-0c3c-4cfd-9072-12bfc112b4c6.png" alt="response_delay"></p>
<h3 id="复现文章中部分线程池卡的现象"><a href="#复现文章中部分线程池卡的现象" class="headerlink" title="复现文章中部分线程池卡的现象"></a>复现文章中部分线程池卡的现象</h3><p>配置两个线程池，在其中一个线程池上,通过<code>select sleep()</code>较长时间模拟线程池被慢SQL或者大量任务堵塞的情况，具体配置方案如下：</p>
<ul>
<li>thread_pool_size&#x3D;2: 保留两个线程池，验证一个卡顿，一个不卡</li>
<li>thread_pool_oversubscribe&#x3D;1: 允许多创建一个线程，每个线程池中可以同时运行1+1&#x3D;2个线程</li>
<li>thread_pool_max_threads&#x3D;2: 每个线程池的线程数量上限，为thread_pool_oversubscribe的配置约束加一个硬限制，每个线程池中最多允许运行2个线程</li>
</ul>
<p>操作步骤如下:</p>
<ul>
<li>通过mysql client在终端发起链接，通过 <code>show processlist</code>语句获取到链接Id, 该链接会分配到 id%2 的线程池中。</li>
<li>用偶数id的链接验证卡顿线程池，用奇数id的链接验证不卡的线程池，链接情况如下:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">  show processlist;</span><br><span class="line">+-----+-----------------+----------------+------+---------+-------+------------------------+------------------+----------+-----------+---------------+</span><br><span class="line">| Id  | User            | Host           | db   | Command | Time  | State                  | Info             | Time_ms  | Rows_sent | Rows_examined |</span><br><span class="line">+-----+-----------------+----------------+------+---------+-------+------------------------+------------------+----------+-----------+---------------+</span><br><span class="line">|   5 | event_scheduler | localhost      | NULL | Daemon  | 23664 | Waiting on empty queue | NULL             | 23663650 |         0 |             0 |</span><br><span class="line">| 404 | root            | _gateway:51310 | NULL | Sleep   |  7256 |                        | NULL             |  7256057 |         1 |             1 |</span><br><span class="line">| 405 | root            | _gateway:48860 | NULL | Sleep   |  7295 |                        | NULL             |  7295342 |         1 |             1 |</span><br><span class="line">| 406 | root            | _gateway:41144 | NULL | Sleep   |  7254 |                        | NULL             |  7254236 |         1 |             1 |</span><br><span class="line">| 410 | root            | _gateway:46794 | NULL | Sleep   |  7196 |                        | NULL             |  7196042 |         1 |             1 |</span><br><span class="line">+-----+-----------------+----------------+------+---------+-------+------------------------+------------------+----------+-----------+---------------+</span><br></pre></td></tr></table></figure>

<ul>
<li>在 id&#x3D;404, id&#x3D;406的链接上，执行 <code>select sleep(30)</code>，再到 id&#x3D;410 的链接上执行 <code>select 1</code>，预计 <code>select &#39;slow&#39;</code>会直接卡顿约30s再执行完成。</li>
<li>同时，在id&#x3D;405的链接上，反复执行 <code>select &#39;fast&#39;</code>,都可以很快执行完成。</li>
</ul>
<p>执行结果:</p>
<ul>
<li>id&#x3D;410 上的语句执行约25s返回结果（终端操作手速影响导致了5s误差）,语句执行时数据库实例输出报错日志，提示线程不足:<blockquote>
<p>2023-05-16T11:27:09.997916Z 406 [ERROR] [MY-000000] [Server] Threadpool could not create additional thread to handle queries, because the number of allowed threads was reached. Increasing ‘thread_pool_max_threads’ parameter can help in this situation.  If ‘admin_port’ parameter is set, you can still connect to the database with superuser account (it must be TCP connection using admin_port as TCP port) and troubleshoot the situation. A likely cause of pool blocks are clients that lock resources for long time. ‘show processlist’ or ‘show engine innodb status’ can give additional hints.</p>
</blockquote>
</li>
<li>id&#x3D;405链接上的执行都行快。可参考下面抓包截图。</li>
</ul>
<p>抓包结果:</p>
<p>id&#x3D;410 上的阻塞SQL,可以看到:</p>
<ol>
<li>三条语句在3s内接连发出,但是由于线程池阻塞， <code>select &#39;slow&#39;</code>原本应该很快返回结果，被卡住</li>
<li>在30s时，第一个<code>select sleep(30)</code>语句执行完成，空出的线程立刻执行了 <code>select &#39;slow&#39;</code>并返回结果<br><img src="/images/951413iMgBlog/238638548-c4161d72-b94c-43ef-b698-3acc1002eb43.png" alt="slow query"></li>
</ol>
<p>id&#x3D;405链接上的执行结果可以看到，每条语句执行都很快。<br><img src="/images/951413iMgBlog/238637635-323fca3b-edf1-4ae7-8d68-d9db9811c692.png" alt="fast query"></p>
<h1 id="参数合理值-已知参数的容量评估"><a href="#参数合理值-已知参数的容量评估" class="headerlink" title="参数合理值&#x2F;已知参数的容量评估"></a>参数合理值&#x2F;已知参数的容量评估</h1><p>percona 的默认配置中，thread_pool_size&#x3D;核心数，thread_pool_oversubscribe&#x3D;3.假设在一台 16core 的服务器上运行percona，默认配置下最多可以有 16*(1+3)&#x3D;64个worker同时接受请求。也就是最大可并行处理的SQL数量为 64 个。</p>
<p>假设同时有65个执行耗时为10ms的SQL到达服务端，理论上，会有一个进入排队。排查网络、解析等阶段，在客户端观察到的64个SQL执行耗时10ms，1个SQL执行耗时约20ms。这也会导致耗时监控中出现毛刺、耗时分布不符合正态分布。</p>
<p>反之，根据硬件配置、查询的量、耗时等特点，也可以推算合理的参数值。</p>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><h2 id="过程回顾"><a href="#过程回顾" class="headerlink" title="过程回顾"></a>过程回顾</h2><h3 id="阶段一-确定原因"><a href="#阶段一-确定原因" class="headerlink" title="阶段一 确定原因"></a>阶段一 确定原因</h3><p>看到文章时，基本确认问题根源在执行线程(worker)不够，导致排队，出于以下几点分析:</p>
<ul>
<li>开头提到的 <a target="_blank" rel="noopener" href="https://www.brendangregg.com/usemethod.html">USE</a> 分析套路，结合排查过类似问题(非SQL)的经验</li>
<li>看到文章作者调大thread_pool_oversubscribe便解决问题, 结合文章中对该参数作用的文档引用，基本可以确定</li>
</ul>
<h3 id="阶段二-走上弯路"><a href="#阶段二-走上弯路" class="headerlink" title="阶段二 走上弯路"></a>阶段二 走上弯路</h3><p>尝试复现时，要先启动一个DB实例，便查询文档该参数如何在配置文件中配置，查了MySQL的文档，似乎只在enterprise版本中才有该配置项，便转头去看mariadb的配置说明(这一步给走弯路埋下了伏笔)。</p>
<p>用docker在本地启动了mariadb实例(thread_pool_size&#x3D;2 thread_pool_oversubscribe&#x3D;1)</p>
<p>先尝试用 <code>select sleep(30)</code> 模拟阻塞，用 sysbench 模拟正常流量，结果失败：</p>
<ol>
<li>正常流量中有慢的，但是整体还符合正态分布，没有出现都卡的情况。</li>
<li>加大了  <code>select sleep(30)</code> 查询的并发量，现象同上。</li>
</ol>
<p>又翻阅了一些文档，看到DB在调度时，对不同类型的SQL调度优先级会有所区别，类似sleep这种啥也不干的SQL，会不会被降低调度优先级，才导致了没有复现呢？(走上了弯路)</p>
<p>尝试人工制造慢查询:</p>
<ol>
<li>用 sysbench 制造百万量级的表</li>
<li>执行 offset limit 的排序查询，并且不走索引</li>
</ol>
<p>复现结果仍不满意：</p>
<ol>
<li>整体耗时上升了，出现几笔长尾的耗时特别长的请求</li>
<li>但是整体仍然符合正态分布</li>
</ol>
<p>此时分析了下，整体耗时上升是人工制造的慢查询，占用了过多IO和CPU资源，影响了sysbench SQL执行的效率。</p>
<h3 id="阶段三-柳岸花明"><a href="#阶段三-柳岸花明" class="headerlink" title="阶段三 柳岸花明"></a>阶段三 柳岸花明</h3><p>回头又仔细看了下 mariadb关于线程池的<a target="_blank" rel="noopener" href="https://mariadb.com/kb/en/thread-groups-in-the-unix-implementation-of-the-thread-pool/">文档</a>，注意到文档中提到 thread_pool_oversubscribe 不决定同时有多少线程池被创建出来并执行任务，这个行为逻辑与文章中作者引用的并不相同。<br>又去查看了另一个MySQL发行版 percona 的文档，对该配置的行为描述与文章中的相符，基本就确定前面复现失败的原因了。</p>
<p>确定了前面提到的复现思路：用有稳定服务端执行耗时、并且不消耗大量硬件资源的SQL,用可控的并发进行模拟流量，到具体执行时：</p>
<ul>
<li>SQL就用 <code>select sleep(N)</code></li>
<li>可控的并发就用 golang写个小脚本(事后看直接在终端手动操作也是可以的,不过写个脚本也不费事就是了)</li>
</ul>
<h2 id="mariadb-启动命令和配置"><a href="#mariadb-启动命令和配置" class="headerlink" title="mariadb 启动命令和配置"></a>mariadb 启动命令和配置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkdir mariadb</span><br><span class="line">cat &gt; mariadb/my.cnf &lt;&lt; EOF</span><br><span class="line">[mariadb]</span><br><span class="line">#thread pool</span><br><span class="line">thread_handling=pool-of-threads</span><br><span class="line">thread_pool_oversubscribe=1</span><br><span class="line">thread_pool_size=1</span><br><span class="line">thread_pool_max_threads=6</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">docker run --name mariadb -v ./mariadb:/etc/mysql/conf.d -e MYSQL_ROOT_PASSWORD=password -p3306:3306 mariadb:10.3</span><br></pre></td></tr></table></figure>


<h2 id="percona-启动命令和配置"><a href="#percona-启动命令和配置" class="headerlink" title="percona 启动命令和配置"></a>percona 启动命令和配置</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mkdir percona</span><br><span class="line">cat &gt; percona/my.cnf &lt;&lt; EOF</span><br><span class="line">[mysqld]</span><br><span class="line">#thread pool</span><br><span class="line">thread_handling=pool-of-threads</span><br><span class="line">thread_pool_oversubscribe=1</span><br><span class="line">thread_pool_size=1</span><br><span class="line">thread_pool_max_threads=1000</span><br><span class="line">default_authentication_plugin=mysql_native_password</span><br><span class="line">EOF</span><br><span class="line">docker run --name percona -v ./percona:/etc/my.cnf.d -e MYSQL_ROOT_PASSWORD=123 -p33060:3306 percona:ps-8</span><br></pre></td></tr></table></figure>

<p>注：Mac M1启动percona时，需要在 docker run 后面添加 <code>--platform linux/x86_64</code> 参数。(percona 未提供arm架构的image)</p>
<h2 id="其他人的重现和分析"><a href="#其他人的重现和分析" class="headerlink" title="其他人的重现和分析"></a>其他人的重现和分析</h2><p><a target="_blank" rel="noopener" href="https://lotabout.me/2023/Verification-of-Percona-Thread-Pool-Behavior/">https://lotabout.me/2023/Verification-of-Percona-Thread-Pool-Behavior/</a>  从源代码debug上来分析</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2023/05/10/%E7%A8%8B%E5%BA%8F%E5%91%98%E6%A1%88%E4%BE%8B%E6%98%9F%E7%90%83%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="twitter @plantegg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
      <meta itemprop="description" content="java mysql tcp performance network docker Linux">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | plantegg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/05/10/%E7%A8%8B%E5%BA%8F%E5%91%98%E6%A1%88%E4%BE%8B%E6%98%9F%E7%90%83%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">程序员案例星球介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-05-10 17:30:03" itemprop="dateCreated datePublished" datetime="2023-05-10T17:30:03+08:00">2023-05-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-11-16 19:58:49" itemprop="dateModified" datetime="2025-11-16T19:58:49+08:00">2025-11-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/others/" itemprop="url" rel="index"><span itemprop="name">others</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="程序员案例星球介绍"><a href="#程序员案例星球介绍" class="headerlink" title="程序员案例星球介绍"></a>程序员案例星球介绍</h1><h2 id="【星球宗旨】"><a href="#【星球宗旨】" class="headerlink" title="【星球宗旨】"></a>【星球宗旨】</h2><p>平时一学就懂，但是实践总是不会，这是因为学习时<strong>缺少实践案例</strong>、场景导致学起来没有体感。我们总是习惯通过课程、教科书想要一次系统性地掌握很多东西，但最终什么都没掌握好。所以星球想通过案例打透一个或几个知识点，让你通过这几个知识点再去生长发芽形成体系</p>
<p><img src="/images/951413iMgBlog/image-20230510191422496.png" alt="image-20230510191422496"></p>
<h2 id="【关于案例】"><a href="#【关于案例】" class="headerlink" title="【关于案例】"></a>【关于案例】</h2><p>本星球剖析各种程序员疑难经典案例，搞清楚一个案例基本能横扫一个领域，其次在一个案例后再带3&#x2F;5个相关小案例可以帮你丰富场景，多角度理解。用做会来解决学不会的问题。 案例典型普适性强，代表基础组件基本原理等知识。分析手段尽量通用，分析过程一定要逻辑合理每个疑问都能回答清晰。 最终实现在新领域用旧知识旧工具解决疑难问题，无招胜有招</p>
<p><img src="/images/951413iMgBlog/image-20230510191512744.png" alt="image-20230510191512744"></p>
<h2 id="【关于星主】"><a href="#【关于星主】" class="headerlink" title="【关于星主】"></a>【关于星主】</h2><p>星主20多年的编程实践经历，疑难问题无数，擅长网络，性能，复杂系统的疑难问题分析，BAT背景，目前还在一线撕逼，作者的故事： <a href="https://plantegg.github.io/2022/01/01/%E4%B8%89%E4%B8%AA%E6%95%85%E4%BA%8B/">https://plantegg.github.io/2022/01/01/%E4%B8%89%E4%B8%AA%E6%95%85%E4%BA%8B/</a></p>
<h2 id="【星球成员成果】"><a href="#【星球成员成果】" class="headerlink" title="【星球成员成果】"></a>【星球成员成果】</h2><ul>
<li><p><a target="_blank" rel="noopener" href="https://yishenggong.com/2023/05/06/why-does-my-network-speed-drop-cn/">强龙难压地头蛇的故事</a> 这位星球成员刚大学毕业几个月，加入星球不到2个月</p>
</li>
<li><p>成员故事 <a target="_blank" rel="noopener" href="https://liarlee.site/2023/05/08/Linux/Linux_RDS%20QPS%20%E4%B8%8B%E9%99%8D%E5%BC%95%E5%8F%91%E7%9A%84%E7%BD%91%E7%BB%9C%E6%B5%81%E6%8E%A7%E5%88%86%E6%9E%90%E8%AE%B0%E5%BD%95/">tcp协议和 os 网络系统的分析我之前真是一句都说不出来， 这次确实完整的走了一遍网络的部分。</a> 这位星球成员目前是 AWS 中国区员工</p>
</li>
</ul>
<p>强龙难压地头蛇的故事也引起各路技术大佬纷纷下场教年轻人如何学习：<a target="_blank" rel="noopener" href="https://t.co/IBLCRzJem2">treeverse.app&#x2F;view&#x2F;RDzsOXjO</a></p>
<img src="/images/951413iMgBlog/image-20230510193840999.png" alt="image-20230510193840999" style="zoom: 33%;" />

<h2 id="【加入星球】"><a href="#【加入星球】" class="headerlink" title="【加入星球】"></a>【加入星球】</h2><p>知识星球：<a target="_blank" rel="noopener" href="https://t.zsxq.com/0cSFEUh2J">https://t.zsxq.com/0cSFEUh2J</a></p>
<img src="/images/951413iMgBlog/image-20230407232314969.png" alt="image-20230407232314969" style="zoom:50%;" />






      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2023/05/06/%E6%88%91%E7%9A%84%E7%BD%91%E7%BB%9C%E4%BC%A0%E8%BE%93%E9%80%9F%E5%BA%A6%E4%B8%BA%E4%BB%80%E4%B9%88%E7%AA%81%E7%84%B6%E4%B8%8B%E9%99%8D%E4%BA%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="twitter @plantegg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
      <meta itemprop="description" content="java mysql tcp performance network docker Linux">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | plantegg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/05/06/%E6%88%91%E7%9A%84%E7%BD%91%E7%BB%9C%E4%BC%A0%E8%BE%93%E9%80%9F%E5%BA%A6%E4%B8%BA%E4%BB%80%E4%B9%88%E7%AA%81%E7%84%B6%E4%B8%8B%E9%99%8D%E4%BA%86/" class="post-title-link" itemprop="url">我的网络传输速度为什么突然下降了</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-05-06 12:30:03" itemprop="dateCreated datePublished" datetime="2023-05-06T12:30:03+08:00">2023-05-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-11-16 19:58:49" itemprop="dateModified" datetime="2025-11-16T19:58:49+08:00">2025-11-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/TCP/" itemprop="url" rel="index"><span itemprop="name">TCP</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="我的网络传输速度为什么突然下降了"><a href="#我的网络传输速度为什么突然下降了" class="headerlink" title="我的网络传输速度为什么突然下降了"></a>我的网络传输速度为什么突然下降了</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这个问题是我星球成员做星球里面的必做实验时碰到的一个问题</p>
<p>最后的分析用到了我们的抓包大法+ping一ping真牛逼的证明方案，所以特意放出来供大家试试，同时也检验大家对知识的掌握和运用。</p>
<p>这个问题很好，在EC2上稳定重现，假如你们的业务碰到了这个问题你怎么解决？</p>
<p>或者换个场景描述：你有一个SQL单独执行很快，2个SQL并行一起查速度就降到了原来的10%，是DB还是谁的锅？</p>
<p>推特上大佬们的讨论，看看别人都是怎么思考和推理的：<a target="_blank" rel="noopener" href="https://treeverse.app/view/RDzsOXjO">https://treeverse.app/view/RDzsOXjO</a></p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>一个降速问题，在AWS的 <a href="t2.micro">t2.micro</a>机器上几乎100％复现，操作: </p>
<ol>
<li>开三台aws <a href="t2.micro">t2.micro</a>机器，一台做server两台做client, 已知正常情况rtt是0.5ms，bandwidth 60mbps，文件大小2g</li>
<li>client1 去curl get server 文件，等一段时间速度稳定在 60mbps</li>
<li>然后用 client2 去curl get server 文件</li>
<li>可以观察到两个client都降速到3.5mbps，这种情况就是算把server跑坏了。</li>
<li>关掉client2, 观察到client1恢复到7-8mbps，但是远低于60mbps的带宽上限，也就是速度被限制到了标称的10%</li>
<li>server搞坏之后，client重新下载就会出现一开始还行，但过10s就会掉到7-8mbps的情况，需要重启server才能恢复到60mbps</li>
</ol>
<p>星球不能发多图，和pcap文件，重现的详细抓包、截图等都放在 google driver上了: <a target="_blank" rel="noopener" href="https://drive.google.com/drive/folders/13rsOQ-6VZhXu0JRMLlUypRposRRcRN-a">https://drive.google.com/drive/folders/13rsOQ-6VZhXu0JRMLlUypRposRRcRN-a</a> （<strong>建议大家去下载client2.pcap抓包看看</strong>）</p>
<p>抓包发现大量dup ack, 且bytes in flight很大，server send buffer很大。</p>
<p><img src="/images/951413iMgBlog/FryRnESX2vOUCICndaLZ3MuaqSmH.png" alt="img"></p>
<p><strong>&#x3D;&#x3D;强烈建议你先别往下看，去下载上面链接中的抓包文件分析看看，然后和下面的分析对比一下&#x3D;&#x3D;</strong></p>
<hr>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>有网络大牛陈硕老师 <a target="_blank" rel="noopener" href="https://twitter.com/bnu_chenshuo/status/1654288717673291776">在EC2上重现了这个问题</a> 以及他的分析，速度由300Mbps下降到了60Mbps：</p>
<p><img src="/images/951413iMgBlog/Fnl-CGFUBMjLwQWa2i6kPo7MuJFc.png" alt="img"></p>
<p>以及 左耳朵耗子 老师也做了实验以及分析：<a target="_blank" rel="noopener" href="https://twitter.com/haoel/status/1654655067365179393">https://twitter.com/haoel/status/1654655067365179393</a></p>
<p>我的分析：<a target="_blank" rel="noopener" href="https://articles.zsxq.com/id_iq5a872u8sux.html">https://articles.zsxq.com/id_iq5a872u8sux.html</a></p>
<p><img src="/images/951413iMgBlog/image-20230506132001274.png" alt="image-20230506132001274"></p>
<h3 id="证明"><a href="#证明" class="headerlink" title="证明"></a>证明</h3><p>证明原理如这个图</p>
<p><img src="/images/951413iMgBlog/image-20230506131422140.png" alt="image-20230506131422140"></p>
<p><img src="/images/951413iMgBlog/image-20230506131709216.png" alt="image-20230506131709216"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>99%的人不会弄脏双手去实验，哪怕是只需要下载一个抓包就能分析出来都不会去下载。但是为什么刚好是两位陈老师会去测试重现一下呢(原谅你没有AWS机器，但是不接受你不去google driver下载抓包文件 :) )，大概率他们的时间、经验、知识都比你要丰富一些，但是他们不忌惮弄脏手而你只想做个过客看看就懂，但最后你真的啥都没看懂！</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2023/04/20/scapy%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="twitter @plantegg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
      <meta itemprop="description" content="java mysql tcp performance network docker Linux">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | plantegg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/20/scapy%E4%BD%BF%E7%94%A8/" class="post-title-link" itemprop="url">从一个fin 卡顿问题到 scapy 的使用</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-20 17:30:03" itemprop="dateCreated datePublished" datetime="2023-04-20T17:30:03+08:00">2023-04-20</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-11-16 19:58:49" itemprop="dateModified" datetime="2025-11-16T19:58:49+08:00">2025-11-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/network/" itemprop="url" rel="index"><span itemprop="name">network</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="从一个fin-卡顿问题到-scapy-的使用"><a href="#从一个fin-卡顿问题到-scapy-的使用" class="headerlink" title="从一个fin 卡顿问题到 scapy 的使用"></a>从一个fin 卡顿问题到 scapy 的使用</h1><h2 id="scapy-使用"><a href="#scapy-使用" class="headerlink" title="scapy 使用"></a>scapy 使用</h2><p>scapy 可以绕过内核构造任意网络包</p>
<p>使用比较简单，git clone  <a target="_blank" rel="noopener" href="https://github.com/secdev/scapy">https://github.com/secdev/scapy</a> 然后在有python3的环境直接可以跑(python2官方说也支持)</p>
<p>注意：</p>
<p>scapy会触发内核发送reset，所以先要在iptables条件一条规则把内核的reset干掉，要不影响scapy的测试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">iptables -A OUTPUT -p tcp --tcp-flags RST RST -s 192.168.0.1 -j DROP</span><br><span class="line"></span><br><span class="line">iptables -A OUTPUT -p tcp --tcp-flags RST RST -s 192.168.0.1 -d 192.168.0.2 --sport 1234 --dport 12347 -j DROP</span><br></pre></td></tr></table></figure>

<p>因为包是 scapy 绕过OS 构造的，导致 OS 不认识 scapy 模拟发出的包，内核里面没有你这个 Socket记录，只能 Reset你，所以还得用 iptables把这个OS 触发的 Reset 丢掉，否则 Reset 会让对端释放连接，这样测试才能顺利进行</p>
<h2 id="三次握手"><a href="#三次握手" class="headerlink" title="三次握手"></a>三次握手</h2><p>用scapy 模拟客户端来进行3次握手</p>
<p>代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sport=random.randint(1024,65535)</span><br><span class="line">ip=IP(dst=&quot;127.0.0.1&quot;)</span><br><span class="line">SYN=TCP(sport=sport, dport=22345, flags=&#x27;S&#x27;, seq=123451000)</span><br><span class="line">c=sr1(ip/SYN)</span><br></pre></td></tr></table></figure>

<p>完整案例：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ./run_scapy</span></span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sport=random.randint(<span class="number">1024</span>,<span class="number">65535</span>) //初始化一个本地随机端口</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>SYN=TCP(sport=sport, dport=<span class="number">22345</span>, flags=<span class="string">&#x27;S&#x27;</span>, seq=<span class="number">123451000</span>) //构造一个连 <span class="number">22345</span> 目标端口的 SYN 包 </span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>ip=IP(dst=<span class="string">&quot;192.168.0.2&quot;</span>) //构造目标地址</span><br><span class="line"><span class="meta">&gt;&gt;&gt; </span>sr1(ip/SYN) 发送包</span><br><span class="line">Begin emission:</span><br><span class="line">Finished sending <span class="number">1</span> packets.</span><br><span class="line">.*</span><br><span class="line">Received <span class="number">2</span> packets, got <span class="number">1</span> answers, remaining <span class="number">0</span> packets</span><br><span class="line">&lt;IP  version=<span class="number">4</span> ihl=<span class="number">5</span> tos=<span class="number">0x0</span> <span class="built_in">len</span>=<span class="number">44</span> <span class="built_in">id</span>=<span class="number">0</span> flags=DF frag=<span class="number">0</span> ttl=<span class="number">64</span> proto=tcp chksum=<span class="number">0xb978</span> src=<span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span> dst=<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span> |&lt;TCP  sport=<span class="number">22345</span> dport=<span class="number">45814</span> seq=<span class="number">1599494827</span> ack=<span class="number">123451001</span> dataofs=<span class="number">6</span> reserved=<span class="number">0</span> flags=SA window=<span class="number">64240</span> chksum=<span class="number">0x99bb</span> urgptr=<span class="number">0</span> options=[(<span class="string">&#x27;MSS&#x27;</span>, <span class="number">1460</span>)] |&lt;Padding  load=<span class="string">b&#x27;\x00\x00&#x27;</span> |&gt;&gt;&gt;</span><br><span class="line">&gt;&gt;&gt;</span><br></pre></td></tr></table></figure>

<p>上面的代码是给对端22345 发了个syn包，然后收到了 syn+ack 包并展示在最后，这一来一回的两个握手包都可以用tcpdump 抓到</p>
<p>服务端的话可以起一个标准http server来验证：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 22345</span><br></pre></td></tr></table></figure>

<p>对应抓包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">15:58:43.301867 IP localhost.44633 &gt; ky2.22345: Flags [S], seq 123451000, win 8192, length 0</span><br><span class="line">15:58:43.301929 IP ky2.22345 &gt; localhost.44633: Flags [S.], seq 106274946, ack 123451001, win 64240, options [mss 1460], length 0</span><br><span class="line">15:58:44.361834 IP ky2.22345 &gt; localhost.44633: Flags [S.], seq 106274946, ack 123451001, win 64240, options [mss 1460], length 0</span><br><span class="line">15:58:46.441862 IP ky2.22345 &gt; localhost.44633: Flags [S.], seq 106274946, ack 123451001, win 64240, options [mss 1460], length 0</span><br></pre></td></tr></table></figure>



<h2 id="fin-挥手端口卡顿案例"><a href="#fin-挥手端口卡顿案例" class="headerlink" title="fin 挥手端口卡顿案例"></a>fin 挥手端口卡顿案例</h2><p>一个奇葩的tcp连接断开的卡顿问题(来自这里 <a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/BxU246Btm2FLt1pppBgYQg">https://mp.weixin.qq.com/s/BxU246Btm2FLt1pppBgYQg</a> )，下面是我对这篇文章问题描述的总结：</p>
<blockquote>
<p>1 两端几乎同时发fin, client收到fin回了一个ack </p>
<p>2 client发的ack先fin到达server，server收到ack直接进入time_wait </p>
<p>3 fin到达server被扔掉—-接下来就是要用scapy验证这个fin包被扔掉&#x2F;忽略了，导致client不能立即断开要等200ms</p>
<p>4 client认为关闭失败，等了200ms重传fin然后关闭成功 </p>
</blockquote>
<p>这个问题的总结就是：TCP连接断开的四次挥手中，由于fin包和ack包乱序，导致等了一次timeout才关闭连接，但是上层业务设置了200ms超时，导致业务报错了，现在需要重现这个问题！</p>
<blockquote>
<p>出现这种问题的场景：比如在 OVS&#x2F;MOC 等网络场景下，SYN&#x2F;FIN 等关键包需要更新路由(session flow)，会走 slowpath(送到更高层的复杂逻辑处理，比如 SYN 就创建一个新的 session 记录，以后普通包直接命中这个 session 就快了；同样 FIN 需要走高层逻辑去释放这条 session 记录)</p>
<p>影响：因为 ack 比 FIN 先到，导致应用连接已被释放，但是后面的 FIN 被重传，从而可能使得应用记录的连接断开时间要晚甚至超时</p>
</blockquote>
<p>原作者怎么分析定位，花了几周，这个过程大家可以去看上面的原因，本篇的目的是对这个问题用Scapy 来重现，目标掌握好 Scapy 这个工具，以后对各种其他问题大家自己都能快速定位</p>
<p>用scapy来模拟这个问题，server端用python实现，重点注意server端的断开方式有两个shutdown&#x2F;close:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">server_ip = <span class="string">&quot;0.0.0.0&quot;</span></span><br><span class="line">server_port = <span class="number">22345</span></span><br><span class="line"></span><br><span class="line">server_socket = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">server_socket.bind((server_ip, server_port))</span><br><span class="line">server_socket.listen(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">connection, client_address = server_socket.accept()</span><br><span class="line"></span><br><span class="line">connection.shutdown(socket.SHUT_RDWR) //比较shutdown和close的不同</span><br><span class="line"><span class="comment">#connection.close()</span></span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">3</span>)</span><br><span class="line">server_socket.close()</span><br></pre></td></tr></table></figure>

<p>对应的client 测试代码，引入了scapy，代码首先是和服务端3次握手，然后抓取(sniff)所有服务端的来包，看看是不是fin，是的话故意先回ack再回fin人为制造乱序：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.<span class="built_in">all</span> <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">target_ip = <span class="string">&quot;127.0.0.1&quot;</span></span><br><span class="line">target_port = <span class="number">22345</span></span><br><span class="line"><span class="comment">#src_port=random.randint(1024,65535)</span></span><br><span class="line">src_port=<span class="number">54322</span></span><br><span class="line"></span><br><span class="line">ip = IP(dst=target_ip)</span><br><span class="line">syn = TCP(sport=src_port, dport=target_port, flags=<span class="string">&quot;S&quot;</span>, seq=<span class="number">4294967293</span>)</span><br><span class="line">syn_ack = sr1(ip / syn)</span><br><span class="line"><span class="keyword">if</span> syn_ack <span class="keyword">and</span> TCP <span class="keyword">in</span> syn_ack <span class="keyword">and</span> syn_ack[TCP].flags == <span class="string">&quot;SA&quot;</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Received SYN-ACK&quot;</span>)</span><br><span class="line">    ack = TCP(sport=src_port, dport=target_port,</span><br><span class="line">              flags=<span class="string">&quot;A&quot;</span>, seq=<span class="number">4322</span>, ack=syn_ack.seq+<span class="number">1</span>)</span><br><span class="line">    send(ip / ack)</span><br><span class="line">    data=<span class="string">&quot;rrrrrrrrrrrrrrrrrrrr&quot;</span></span><br><span class="line">    payload=TCP(sport=src_port, dport=<span class="number">22345</span>, flags=<span class="string">&#x27;S&#x27;</span>, seq=<span class="number">4294967294</span>)</span><br><span class="line">    send(ip/payload()/Raw(load=data))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Send ACK&quot;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Failed to establish TCP connection&quot;</span>)     </span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_packet</span>(<span class="params">packet</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;handle fin packet&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(Ether(raw(packet)))</span><br><span class="line">    <span class="keyword">if</span>  TCP <span class="keyword">in</span> packet <span class="keyword">and</span> packet[TCP].flags &amp; <span class="number">0x011</span> <span class="keyword">and</span> packet[TCP].sport == <span class="number">22345</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Received FIN packet&quot;</span>)</span><br><span class="line">        ack = TCP(sport=src_port, dport=target_port,</span><br><span class="line">		  flags=<span class="string">&quot;A&quot;</span>, seq=packet.ack+<span class="number">1</span>, ack=packet.seq+<span class="number">1</span>)</span><br><span class="line">        send(ip / ack)</span><br><span class="line"></span><br><span class="line">        time.sleep(<span class="number">0.1</span>)</span><br><span class="line">        fin = TCP(sport=src_port, dport=target_port,</span><br><span class="line">                  flags=<span class="string">&quot;FA&quot;</span>, seq=packet.ack, ack=packet.seq)</span><br><span class="line">        send(ip / fin)</span><br><span class="line">        sys.exit(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#抓包，抓到的包给handle_packet处理</span></span><br><span class="line"><span class="comment">#sniff(filter=&quot;tcp port 22345&quot;, prn=handle_packet)</span></span><br><span class="line">sniff(<span class="built_in">filter</span>=<span class="string">&quot;tcp port 22345&quot;</span>, iface=<span class="string">&quot;lo&quot;</span>,prn=handle_packet)</span><br></pre></td></tr></table></figure>

<p>下图是服务端 shutdown时模拟挥手断开时ack包和fin包乱序了，也就是先回ack，sleep一段时间后再回fin包，如图：</p>
<p><img src="/images/951413iMgBlog/image-20231009101444587.png" alt="image-20231009101444587"></p>
<p>如果server端代码中将shutdown改成close 并做个对比，关键是上面绿框回复ack是4322(challenge_ack 表示seq&#x3D;4322的fin包被忽略了)，而下面close时的seq&#x3D;4322的fin包会被正确接收并回复ack 4323 确认，那么这时client 可以断开了。而上图绿框表示fin 被忽略了，那么内核要继续等200ms 再次发 fin，等收到ack后client 才能断开</p>
<p><img src="/images/951413iMgBlog/image-20231008175355835.png" alt="image-20231008175355835"></p>
<p>server上通过 netstat 观察连接的状态变化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//shutdown，可以看到server 发fin进入FIN_WAIT1，然后收到ack 进入 FIN_WAIT2，此时收到fin了，但是被扔掉了，无法断开进入TIME_WAIT</span><br><span class="line"># sh test.sh</span><br><span class="line">tcp        0      0 192.168.0.2:22345       192.168.0.1:54322       SYN_RECV</span><br><span class="line">tcp        0      1 192.168.0.2:22345       192.168.0.1:54322       FIN_WAIT1</span><br><span class="line">tcp        0      0 192.168.0.2:22345       192.168.0.1:54322       FIN_WAIT2</span><br><span class="line">tcp        0      0 192.168.0.2:22345       192.168.0.1:54322       FIN_WAIT2</span><br><span class="line">tcp        0      0 192.168.0.2:22345       192.168.0.1:54322       FIN_WAIT2</span><br><span class="line">tcp        0      0 192.168.0.2:22345       192.168.0.1:54322       FIN_WAIT2</span><br><span class="line">tcp        0      0 192.168.0.2:22345       192.168.0.1:54322       FIN_WAIT2</span><br><span class="line"></span><br><span class="line">//close 可以看到server 发fin进入FIN_WAIT1，然后收到ack 进入 FIN_WAIT2，此时收到fin了没有被扔掉，所以很快连接断开进入了TIME_WAIT </span><br><span class="line">tcp        0      0 192.168.0.2:22345       192.168.0.1:54322       SYN_RECV</span><br><span class="line">tcp        0      1 192.168.0.2:22345       192.168.0.1:54322       FIN_WAIT1</span><br><span class="line">tcp        0      0 192.168.0.2:22345       192.168.0.1:54322       FIN_WAIT2</span><br><span class="line">tcp        0      0 192.168.0.2:22345       192.168.0.1:54322       TIME_WAIT</span><br><span class="line">tcp        0      0 192.168.0.2:22345       192.168.0.1:54322       TIME_WAIT</span><br></pre></td></tr></table></figure>

<h2 id="seq-回绕到0-会导致丢包吗？"><a href="#seq-回绕到0-会导致丢包吗？" class="headerlink" title="seq 回绕到0 会导致丢包吗？"></a>seq 回绕到0 会导致丢包吗？</h2><p>首先学习下 seq 是一个无符号32位的整数，最大值是4294967295 </p>
<p>如图，有人发现探活连接不通，导致了一次非正常切换，所以需要分析连接为什么断开，抓包发现重传的时候正好seq 为0，于是他就奇怪了是不是这个seq溢出搞的鬼？怎么这么巧seq 刚好为0了？</p>
<p><img src="/images/951413iMgBlog/image-20231130113732507.png" alt="image-20231130113732507"></p>
<p>要想正好巧合在 seq 回绕的时候刚好回绕到 0 还是非常不容易的，不过好在用 scapy 来模拟这事就简单了</p>
<p>重现代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">from scapy.all import *</span><br><span class="line">import time</span><br><span class="line">import sys</span><br><span class="line"></span><br><span class="line">target_ip = &quot;server_host_ip&quot;</span><br><span class="line">target_port = 22345</span><br><span class="line">src_port=random.randint(1024,65535)</span><br><span class="line"></span><br><span class="line">#接近最大值 4294967295</span><br><span class="line">start_seq=4294967292 </span><br><span class="line"></span><br><span class="line">ip = IP(dst=target_ip)</span><br><span class="line">syn = TCP(sport=src_port, dport=target_port, flags=&quot;S&quot;, seq=start_seq)</span><br><span class="line">syn_ack = sr1(ip / syn)</span><br><span class="line">if syn_ack and TCP in syn_ack and syn_ack[TCP].flags == &quot;SA&quot;:</span><br><span class="line">    print(&quot;Received SYN-ACK&quot;)</span><br><span class="line">    ack = TCP(sport=src_port, dport=target_port,</span><br><span class="line">              flags=&quot;A&quot;, seq=syn_ack.ack, ack=syn_ack.seq+1)</span><br><span class="line">    print(syn_ack.seq)</span><br><span class="line">    print(syn_ack.ack)</span><br><span class="line">    print(ack)</span><br><span class="line">    send(ip/ack)</span><br><span class="line">    print(&quot;Send ACK&quot;)</span><br><span class="line">else:</span><br><span class="line">    print(&quot;Failed to establish TCP connection&quot;)</span><br><span class="line"></span><br><span class="line">print(&quot;send payload&quot;)</span><br><span class="line">#4294967293+3(3个r) 正好是无符号整数溢出(最大 4294967295)，回绕到0</span><br><span class="line">data=&quot;rrr&quot;</span><br><span class="line">payload=TCP(sport=src_port, dport=22345,flags=&quot;AP&quot;, seq=syn_ack.ack,  ack=syn_ack.seq+1)</span><br><span class="line">payload2=TCP(sport=src_port, dport=22345,flags=&quot;AP&quot;, seq=0,  ack=syn_ack.seq+1)</span><br><span class="line">syn_ack=send(ip/payload/Raw(load=data))</span><br><span class="line">syn_ack=send(ip/payload2/Raw(load=data))</span><br></pre></td></tr></table></figure>

<p>对应的抓包：</p>
<p><img src="/images/951413iMgBlog/image-20231130114200515.png" alt="image-20231130114200515"></p>
<p>从上面的实验来看内核能正确处理这种 seq 回绕到 0 的场景，所以问题不在内核处理上。进一步分析发现是交换机的 bug 导致的</p>
<h3 id="最终确认原因：交换机bug-丢掉-seq-0的包"><a href="#最终确认原因：交换机bug-丢掉-seq-0的包" class="headerlink" title="最终确认原因：交换机bug 丢掉 seq&#x3D;0的包"></a>最终确认原因：交换机bug 丢掉 seq&#x3D;0的包</h3><p>最后发现这个问题是中兴 9900系列交换机存在seq&#x3D;0 push 发送模式下报文存在丢失缺陷， 丢包原因是中兴交换机从安全角度考量是支持antidos防攻击功能，该功能开启后会将 TCP seq 为 0 的报文作为非法报文并丢弃。中兴 9900交换机上该功能默认是关闭的但是未生效，需要重新触发关闭（现场看配置是关闭的，实际是开启的，现在执行将配置先打开再关闭）。<br>临时规避方案：（中兴内部验证测试针对此报文有效，现场环境可能有差异，需要现场验证确认）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">先执行 (config)#anti-dos abnormal enable</span><br><span class="line">再执行 (config)#anti-dos abnormal disable  </span><br></pre></td></tr></table></figure>

<p>现场实施完毕后，发包验证恢复正常，后续持续观察业务。</p>
<p>彻底解决方案：将该版本升级至V2.00.00R8P16  </p>
<h4 id="华为交换机针对默认连接丢包-bug"><a href="#华为交换机针对默认连接丢包-bug" class="headerlink" title="华为交换机针对默认连接丢包 bug"></a>华为交换机针对默认连接丢包 bug</h4><p>借着中兴这个交换机问题，说一下华为交换机的的 bug，华为 CE12800系列，V200R022C00SPC500之前的版本</p>
<p>当大规格路由反复震荡场景下会小概率</p>
<ol>
<li>出现优先级更高的(子网掩码范围更小)路由表项残留，导致整个子网不通</li>
<li>某个接口下发的路由表和其他接口(芯片)不一致，导致某条连接一直丢包</li>
</ol>
<p>可以重启单板修复表项异常问题，该问题在新版本上（V200R022C00SPC500）已经补丁修复（SPH220）</p>
<p>根因：残留表项或表项异常导致，老版本在大规格路由反复震荡场景下会小概率触发，是软件多线程处理路由下发或删除时，出现线程读取数据异常，导致芯片表项错误。</p>
<h2 id="scapy-构造全连接队列溢出"><a href="#scapy-构造全连接队列溢出" class="headerlink" title="scapy 构造全连接队列溢出"></a>scapy 构造全连接队列溢出</h2><p>server 端用python 起一个WEB 服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup python3 -m http.server 22345 &amp;</span><br></pre></td></tr></table></figure>

<p>然后client端用如下scapy 代码不断去3次握手建立连接，试几次后就抓到如下现象：</p>
<p><img src="/images/951413iMgBlog/image-20231130111028268.png" alt="image-20231130111028268"></p>
<p>抓包效果：</p>
<p><img src="/images/951413iMgBlog/image-20231130133248747.png" alt="image-20231130133248747"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我觉得scapy还是挺好用的，比packetdrill好用一万倍，直观明了，还有命令行可以交互测试</p>
<p>但是要注意 scapy 是绕过内核在模拟发包，收包靠 sniff，所以内核收到这些回包会认为连接不存在，直接reset，需要在iptables 里处理一下</p>
<p>这个问题是别人推荐给我看的，一般10分钟就看完了，但是我差不多花了2天时间，不断地想和去实验重现</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a target="_blank" rel="noopener" href="https://wizardforcel.gitbooks.io/scapy-docs/content/3.html">https://wizardforcel.gitbooks.io/scapy-docs/content/3.html</a></p>
<p><a target="_blank" rel="noopener" href="https://www.osgeo.cn/scapy/usage.html">https://www.osgeo.cn/scapy/usage.html</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/51002301">https://zhuanlan.zhihu.com/p/51002301</a></p>
<h2 id="如果你觉得看完对你很有帮助可以通过如下方式找到我"><a href="#如果你觉得看完对你很有帮助可以通过如下方式找到我" class="headerlink" title="如果你觉得看完对你很有帮助可以通过如下方式找到我"></a>如果你觉得看完对你很有帮助可以通过如下方式找到我</h2><p>find me on twitter: <a target="_blank" rel="noopener" href="https://twitter.com/plantegg">@plantegg</a></p>
<p>知识星球：<a target="_blank" rel="noopener" href="https://t.zsxq.com/0cSFEUh2J">https://t.zsxq.com/0cSFEUh2J</a></p>
<p>开了一个星球，在里面讲解一些案例、知识、学习方法，肯定没法让大家称为顶尖程序员(我自己都不是)，只是希望用我的方法、知识、经验、案例作为你的垫脚石，帮助你快速、早日成为一个基本合格的程序员。</p>
<p>争取在星球内：</p>
<ul>
<li>养成基本动手能力</li>
<li>拥有起码的分析推理能力–按我接触的程序员，大多都是没有逻辑的</li>
<li>知识上教会你几个关键的知识点</li>
</ul>
<img src="/images/951413iMgBlog/image-20240324161113874.png" alt="image-20240324161113874" style="zoom:50%;" />


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2023/04/16/%E6%AF%94%E8%BE%83%E4%B8%8D%E5%90%8CCPU%E4%B8%8B%E7%9A%84%E5%88%86%E6%94%AF%E9%A2%84%E6%B5%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="twitter @plantegg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
      <meta itemprop="description" content="java mysql tcp performance network docker Linux">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | plantegg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/16/%E6%AF%94%E8%BE%83%E4%B8%8D%E5%90%8CCPU%E4%B8%8B%E7%9A%84%E5%88%86%E6%94%AF%E9%A2%84%E6%B5%8B/" class="post-title-link" itemprop="url">比较不同CPU下的分支预测</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-16 12:30:03" itemprop="dateCreated datePublished" datetime="2023-04-16T12:30:03+08:00">2023-04-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-11-16 19:58:49" itemprop="dateModified" datetime="2025-11-16T19:58:49+08:00">2025-11-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/CPU/" itemprop="url" rel="index"><span itemprop="name">CPU</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="比较不同CPU下的分支预测"><a href="#比较不同CPU下的分支预测" class="headerlink" title="比较不同CPU下的分支预测"></a>比较不同CPU下的分支预测</h1><h2 id="目的"><a href="#目的" class="headerlink" title="目的"></a>目的</h2><p>本文通过一段对分支预测是否友好的代码来验证 branch load miss 差异，已经最终带来的 性能差异。同时在x86和aarch64 下各选几款CPU共5款进行差异性对比</p>
<h2 id="CPU-情况"><a href="#CPU-情况" class="headerlink" title="CPU 情况"></a>CPU 情况</h2><h3 id="intel-x86"><a href="#intel-x86" class="headerlink" title="intel x86"></a>intel x86</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">#lscpu</span><br><span class="line">Architecture:          x86_64</span><br><span class="line">CPU op-mode(s):        32-bit, 64-bit</span><br><span class="line">Byte Order:            Little Endian</span><br><span class="line">CPU(s):                48</span><br><span class="line">On-line CPU(s) list:   0-47</span><br><span class="line">Thread(s) per core:    1</span><br><span class="line">Core(s) per socket:    24</span><br><span class="line">Socket(s):             2</span><br><span class="line">NUMA node(s):          2</span><br><span class="line">Vendor ID:             GenuineIntel</span><br><span class="line">CPU family:            6</span><br><span class="line">Model:                 85</span><br><span class="line">Model name:            Intel(R) Xeon(R) Platinum 8163 CPU @ 2.50GHz</span><br><span class="line">Stepping:              4</span><br><span class="line">CPU MHz:               2500.195</span><br><span class="line">CPU max MHz:           3100.0000</span><br><span class="line">CPU min MHz:           1000.0000</span><br><span class="line">BogoMIPS:              4998.89</span><br><span class="line">Virtualization:        VT-x</span><br><span class="line">L1d cache:             32K</span><br><span class="line">L1i cache:             32K</span><br><span class="line">L2 cache:              1024K</span><br><span class="line">L3 cache:              33792K</span><br><span class="line">NUMA node0 CPU(s):     0-23</span><br><span class="line">NUMA node1 CPU(s):     24-47</span><br><span class="line">Flags:                 fpu vme de pse tsc msr pae mce cx8 apic sep mtrr pge mca cmov pat pse36 clflush dts acpi mmx fxsr sse sse2 ss ht tm pbe syscall nx pdpe1gb rdtscp lm constant_tsc arch_perfmon pebs bts rep_good nopl xtopology nonstop_tsc aperfmperf eagerfpu pni pclmulqdq dtes64 monitor ds_cpl vmx smx est tm2 ssse3 fma cx16 xtpr pdcm pcid dca sse4_1 sse4_2 x2apic movbe popcnt tsc_deadline_timer aes xsave avx f16c rdrand lahf_lm abm 3dnowprefetch ida arat epb invpcid_single pln pts dtherm spec_ctrl ibpb_support tpr_shadow vnmi flexpriority ept vpid fsgsbase tsc_adjust bmi1 hle avx2 smep bmi2 erms invpcid rtm cqm mpx rdt avx512f avx512dq rdseed adx smap clflushopt avx512cd avx512bw avx512vl xsaveopt xsavec xgetbv1 cqm_llc cqm_occup_llc cqm_mbm_total cqm_mbm_local cat_l3 mba</span><br></pre></td></tr></table></figure>

<h3 id="hygon-7260"><a href="#hygon-7260" class="headerlink" title="hygon 7260"></a>hygon 7260</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">#lscpu</span><br><span class="line">Architecture:        x86_64</span><br><span class="line">CPU op-mode(s):      32-bit, 64-bit</span><br><span class="line">Byte Order:          Little Endian</span><br><span class="line">Address sizes:       43 bits physical, 48 bits virtual</span><br><span class="line">CPU(s):              48</span><br><span class="line">On-line CPU(s) list: 0-47</span><br><span class="line">Thread(s) per core:  1</span><br><span class="line">Core(s) per socket:  24</span><br><span class="line">Socket(s):           2</span><br><span class="line">NUMA node(s):        8</span><br><span class="line">Vendor ID:           HygonGenuine</span><br><span class="line">CPU family:          24</span><br><span class="line">Model:               1</span><br><span class="line">Model name:          Hygon C86 7260 24-core Processor</span><br><span class="line">Stepping:            1</span><br><span class="line">Frequency boost:     enabled</span><br><span class="line">CPU MHz:             1069.534</span><br><span class="line">CPU max MHz:         2200.0000</span><br><span class="line">CPU min MHz:         1200.0000</span><br><span class="line">BogoMIPS:            4399.38</span><br><span class="line">Virtualization:      AMD-V</span><br><span class="line">L1d cache:           32K</span><br><span class="line">L1i cache:           64K</span><br><span class="line">L2 cache:            512K</span><br><span class="line">L3 cache:            8192K</span><br><span class="line">NUMA node0 CPU(s):   0-5</span><br><span class="line">NUMA node1 CPU(s):   6-11</span><br><span class="line">NUMA node2 CPU(s):   12-17</span><br><span class="line">NUMA node3 CPU(s):   18-23</span><br><span class="line">NUMA node4 CPU(s):   24-29</span><br><span class="line">NUMA node5 CPU(s):   30-35</span><br><span class="line">NUMA node6 CPU(s):   36-41</span><br><span class="line">NUMA node7 CPU(s):   42-47</span><br></pre></td></tr></table></figure>

<h3 id="ARM-鲲鹏920"><a href="#ARM-鲲鹏920" class="headerlink" title="ARM 鲲鹏920"></a>ARM 鲲鹏920</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">#lscpu</span><br><span class="line">Architecture:          aarch64</span><br><span class="line">Byte Order:            Little Endian</span><br><span class="line">CPU(s):                96</span><br><span class="line">On-line CPU(s) list:   0-95</span><br><span class="line">Thread(s) per core:    1</span><br><span class="line">Core(s) per socket:    48</span><br><span class="line">Socket(s):             2</span><br><span class="line">NUMA node(s):          4</span><br><span class="line">Model:                 0</span><br><span class="line">CPU max MHz:           2600.0000</span><br><span class="line">CPU min MHz:           200.0000</span><br><span class="line">BogoMIPS:              200.00</span><br><span class="line">L1d cache:             64K</span><br><span class="line">L1i cache:             64K</span><br><span class="line">L2 cache:              512K</span><br><span class="line">L3 cache:              24576K</span><br><span class="line">NUMA node0 CPU(s):     0-23</span><br><span class="line">NUMA node1 CPU(s):     24-47</span><br><span class="line">NUMA node2 CPU(s):     48-71</span><br><span class="line">NUMA node3 CPU(s):     72-95</span><br><span class="line">Flags:                 fp asimd evtstrm aes pmull sha1 sha2 crc32 atomics fphp asimdhp cpuid asimdrdm jscvt fcma dcpop asimddp asimdfhm</span><br></pre></td></tr></table></figure>

<h3 id="ARM-M710"><a href="#ARM-M710" class="headerlink" title="ARM M710"></a>ARM M710</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#lscpu</span><br><span class="line">Architecture:          aarch64</span><br><span class="line">Byte Order:            Little Endian</span><br><span class="line">CPU(s):                128</span><br><span class="line">On-line CPU(s) list:   0-127</span><br><span class="line">Thread(s) per core:    1</span><br><span class="line">Core(s) per socket:    128</span><br><span class="line">Socket(s):             1</span><br><span class="line">NUMA node(s):          2</span><br><span class="line">Model:                 0</span><br><span class="line">BogoMIPS:              100.00</span><br><span class="line">L1d cache:             64K</span><br><span class="line">L1i cache:             64K</span><br><span class="line">L2 cache:              1024K</span><br><span class="line">L3 cache:              65536K</span><br><span class="line">NUMA node0 CPU(s):     0-63</span><br><span class="line">NUMA node1 CPU(s):     64-127</span><br><span class="line">Flags:                 fp asimd evtstrm aes pmull sha1 sha2 crc32 atomics fphp asimdhp cpuid asimdrdm jscvt fcma lrcpc dcpop sha3 sm3 sm4 asimddp sha512 sve asimdfhm dit uscat ilrcpc flagm ssbs sb dcpodp sve2 sveaes svepmull svebitperm svesha3 svesm4 flagm2 frint svei8mm svebf16 i8mm bf16 dgh</span><br></pre></td></tr></table></figure>

<h3 id="ARM-FT-S2500"><a href="#ARM-FT-S2500" class="headerlink" title="ARM FT S2500"></a>ARM FT S2500</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">#lscpu</span><br><span class="line">Architecture:          aarch64</span><br><span class="line">Byte Order:            Little Endian</span><br><span class="line">CPU(s):                128</span><br><span class="line">On-line CPU(s) list:   0-127</span><br><span class="line">Thread(s) per core:    1</span><br><span class="line">Core(s) per socket:    64</span><br><span class="line">Socket(s):             2</span><br><span class="line">NUMA node(s):          16</span><br><span class="line">Model:                 3</span><br><span class="line">BogoMIPS:              100.00</span><br><span class="line">L1d cache:             32K</span><br><span class="line">L1i cache:             32K</span><br><span class="line">L2 cache:              2048K</span><br><span class="line">L3 cache:              65536K</span><br><span class="line">NUMA node0 CPU(s):     0-7</span><br><span class="line">NUMA node1 CPU(s):     8-15</span><br><span class="line">NUMA node2 CPU(s):     16-23</span><br><span class="line">NUMA node3 CPU(s):     24-31</span><br><span class="line">NUMA node4 CPU(s):     32-39</span><br><span class="line">NUMA node5 CPU(s):     40-47</span><br><span class="line">NUMA node6 CPU(s):     48-55</span><br><span class="line">NUMA node7 CPU(s):     56-63</span><br><span class="line">NUMA node8 CPU(s):     64-71</span><br><span class="line">NUMA node9 CPU(s):     72-79</span><br><span class="line">NUMA node10 CPU(s):    80-87</span><br><span class="line">NUMA node11 CPU(s):    88-95</span><br><span class="line">NUMA node12 CPU(s):    96-103</span><br><span class="line">NUMA node13 CPU(s):    104-111</span><br><span class="line">NUMA node14 CPU(s):    112-119</span><br><span class="line">NUMA node15 CPU(s):    120-127</span><br><span class="line">Flags:                 fp asimd evtstrm aes pmull sha1 sha2 crc32 cpuid</span><br></pre></td></tr></table></figure>

<h2 id="测试代码"><a href="#测试代码" class="headerlink" title="测试代码"></a><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/11227809/why-is-processing-a-sorted-array-faster-than-processing-an-unsorted-array">测试代码</a></h2><p>对一个数组中较大的一半的值累加：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctime&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// 随机产生整数，用分区函数填充，以避免出现分桶不均</span></span><br><span class="line">    <span class="type">const</span> <span class="type">unsigned</span> arraySize = <span class="number">32768</span>;</span><br><span class="line">    <span class="type">int</span> data[arraySize];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> c = <span class="number">0</span>; c &lt; arraySize; ++c)</span><br><span class="line">        data[c] = std::<span class="built_in">rand</span>() % <span class="number">256</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//排序后数据有序，CPU可以准确预测到if的分支</span></span><br><span class="line">    std::<span class="built_in">sort</span>(data, data + arraySize); <span class="comment">//预先排序，也可以注释掉，注释掉表示随机乱序几乎无法预测</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 测试部分</span></span><br><span class="line">    <span class="type">clock_t</span> start = <span class="built_in">clock</span>();</span><br><span class="line">    <span class="type">long</span> <span class="type">long</span> sum = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">unsigned</span> i = <span class="number">0</span>; i &lt; <span class="number">100000</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// 主要计算部分，选一半元素参与计算</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">unsigned</span> c = <span class="number">0</span>; c &lt; arraySize; ++c)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span> (data[c] &gt;= <span class="number">128</span>)</span><br><span class="line">                sum += data[c];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">double</span> elapsedTime = <span class="built_in">static_cast</span>&lt;<span class="type">double</span>&gt;(<span class="built_in">clock</span>() - start) / CLOCKS_PER_SEC;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; elapsedTime &lt;&lt; std::endl;</span><br><span class="line">    std::cout &lt;&lt; <span class="string">&quot;sum = &quot;</span> &lt;&lt; sum &lt;&lt; std::endl;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>以上代码可以注释掉第15行，也就是不对代码排序直接累加，不排序的话 if (data[c] &gt;&#x3D; 128) 有50% 概率成立，排序后前一半元素if都不成立，后一半元素if都成立，导致CPU流水线很好预测后面的代码，可以提前加载运算打高IPC</p>
<h2 id="测试结果"><a href="#测试结果" class="headerlink" title="测试结果"></a>测试结果</h2><h3 id="aarch64-鲲鹏920"><a href="#aarch64-鲲鹏920" class="headerlink" title="aarch64 鲲鹏920"></a>aarch64 鲲鹏920</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-store-misses,L1-dcache-stores,L1-icache-load-misses,L1-icache-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads ./aftersort</span><br><span class="line">11.44</span><br><span class="line">sum = 314931600000</span><br><span class="line"></span><br><span class="line">           470,740      branch-misses                                                 (59.99%)</span><br><span class="line">    29,716,627,485      bus-cycles                # 2595.890 M/sec                    (60.03%)</span><br><span class="line">        96,469,435      cache-misses              #    0.420 % of all cache refs      (60.03%)</span><br><span class="line">    22,984,316,728      cache-references          # 2007.791 M/sec                    (60.03%)</span><br><span class="line">    29,716,018,641      cpu-cycles                #    2.596 GHz                      (65.02%)</span><br><span class="line">    83,666,813,837      instructions              #    2.82  insn per cycle</span><br><span class="line">                                                  #    0.10  stalled cycles per insn  (65.02%)</span><br><span class="line">     8,765,807,804      stalled-cycles-backend    #   29.50% backend cycles idle      (65.02%)</span><br><span class="line">         8,917,112      stalled-cycles-frontend   #    0.03% frontend cycles idle     (65.02%)</span><br><span class="line">                 0      alignment-faults          #    0.000 K/sec</span><br><span class="line">                 0      bpf-output                #    0.000 K/sec</span><br><span class="line">                 5      context-switches          #    0.000 K/sec</span><br><span class="line">         11,447.57 msec cpu-clock                 #    1.000 CPUs utilized</span><br><span class="line">                 0      cpu-migrations            #    0.000 K/sec</span><br><span class="line">                 0      dummy                     #    0.000 K/sec</span><br><span class="line">                 0      emulation-faults          #    0.000 K/sec</span><br><span class="line">                 0      major-faults              #    0.000 K/sec</span><br><span class="line">               132      minor-faults              #    0.012 K/sec</span><br><span class="line">               132      page-faults               #    0.012 K/sec</span><br><span class="line">         11,447.57 msec task-clock                #    1.000 CPUs utilized</span><br><span class="line">        96,471,779      L1-dcache-load-misses     #    0.42% of all L1-dcache accesses  (65.02%)</span><br><span class="line">    22,985,408,745      L1-dcache-loads           # 2007.886 M/sec                    (65.02%)</span><br><span class="line">        96,472,614      L1-dcache-store-misses    #    8.427 M/sec                    (65.02%)</span><br><span class="line">    22,986,056,706      L1-dcache-stores          # 2007.943 M/sec                    (65.02%)</span><br><span class="line">           184,402      L1-icache-load-misses     #    0.00% of all L1-icache accesses  (65.02%)</span><br><span class="line">    14,779,996,797      L1-icache-loads           # 1291.104 M/sec                    (64.99%)</span><br><span class="line">           330,651      branch-load-misses        #    0.029 M/sec                    (64.96%)</span><br><span class="line">     6,561,353,921      branch-loads              #  573.166 M/sec                    (64.96%)</span><br><span class="line">         3,464,612      dTLB-load-misses          #    0.02% of all dTLB cache accesses  (64.96%)</span><br><span class="line">    23,008,097,187      dTLB-loads                # 2009.868 M/sec                    (59.96%)</span><br><span class="line">               745      iTLB-load-misses          #    0.00% of all iTLB cache accesses  (59.96%)</span><br><span class="line">    14,779,577,851      iTLB-loads                # 1291.067 M/sec                    (59.96%)</span><br><span class="line">    </span><br><span class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-store-misses,L1-dcache-stores,L1-icache-load-misses,L1-icache-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads ./beforesort</span><br><span class="line">30.92</span><br><span class="line">sum = 314931600000</span><br><span class="line"></span><br><span class="line">     1,639,558,981      branch-misses                                                 (59.96%)</span><br><span class="line">    80,284,783,419      bus-cycles                # 2595.949 M/sec                    (59.96%)</span><br><span class="line">       118,459,436      cache-misses              #    0.356 % of all cache refs      (59.96%)</span><br><span class="line">    33,285,701,200      cache-references          # 1076.269 M/sec                    (59.96%)</span><br><span class="line">    80,283,427,379      cpu-cycles                #    2.596 GHz                      (64.96%)</span><br><span class="line">    83,694,841,472      instructions              #    1.04  insn per cycle</span><br><span class="line">                                                  #    0.11  stalled cycles per insn  (64.98%)</span><br><span class="line">     8,849,746,372      stalled-cycles-backend    #   11.02% backend cycles idle      (64.99%)</span><br><span class="line">     8,064,207,583      stalled-cycles-frontend   #   10.04% frontend cycles idle     (65.00%)</span><br><span class="line">                 0      alignment-faults          #    0.000 K/sec</span><br><span class="line">                 0      bpf-output                #    0.000 K/sec</span><br><span class="line">                10      context-switches          #    0.000 K/sec</span><br><span class="line">         30,926.95 msec cpu-clock                 #    1.000 CPUs utilized</span><br><span class="line">                 0      cpu-migrations            #    0.000 K/sec</span><br><span class="line">                 0      dummy                     #    0.000 K/sec</span><br><span class="line">                 0      emulation-faults          #    0.000 K/sec</span><br><span class="line">                 0      major-faults              #    0.000 K/sec</span><br><span class="line">               133      minor-faults              #    0.004 K/sec</span><br><span class="line">               133      page-faults               #    0.004 K/sec</span><br><span class="line">         30,926.95 msec task-clock                #    1.000 CPUs utilized</span><br><span class="line">       118,445,576      L1-dcache-load-misses     #    0.36% of all L1-dcache accesses  (65.02%)</span><br><span class="line">    33,286,586,418      L1-dcache-loads           # 1076.297 M/sec                    (65.03%)</span><br><span class="line">       118,441,599      L1-dcache-store-misses    #    3.830 M/sec                    (65.04%)</span><br><span class="line">    33,286,751,407      L1-dcache-stores          # 1076.302 M/sec                    (65.05%)</span><br><span class="line">           410,040      L1-icache-load-misses     #    0.00% of all L1-icache accesses  (65.05%)</span><br><span class="line">    51,611,031,810      L1-icache-loads           # 1668.805 M/sec                    (65.04%)</span><br><span class="line">     1,639,731,725      branch-load-misses        #   53.020 M/sec                    (65.03%)</span><br><span class="line">     7,520,634,791      branch-loads              #  243.174 M/sec                    (65.02%)</span><br><span class="line">         3,536,061      dTLB-load-misses          #    0.01% of all dTLB cache accesses  (65.00%)</span><br><span class="line">    47,898,134,543      dTLB-loads                # 1548.751 M/sec                    (59.99%)</span><br><span class="line">             2,529      iTLB-load-misses          #    0.00% of all iTLB cache accesses  (59.97%)</span><br><span class="line">    51,612,575,118      iTLB-loads                # 1668.854 M/sec                    (59.96%)    </span><br></pre></td></tr></table></figure>

<p>以上在相同CPU下数据对比可以看到核心差异是branch-load-misses和branch-misses，当然最终也体现在 IPC 数值上，排序后IPC更高不是因为数据有序取起来更快，而是因为执行逻辑更容易提前预测，也就是可以提前加载if代码到cache中。符合预期</p>
<h3 id="aarch64-M710"><a href="#aarch64-M710" class="headerlink" title="aarch64 M710"></a>aarch64 M710</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-icache-load-misses,L1-icache-loads,LLC-load-misses,LLC-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads ./aftersort</span><br><span class="line">8.20237</span><br><span class="line">sum = 314931600000</span><br><span class="line"></span><br><span class="line">           912,836      branch-misses                                                 (29.86%)</span><br><span class="line">    22,560,165,604      bus-cycles                # 2748.461 M/sec                    (29.91%)</span><br><span class="line">       205,068,961      cache-misses              #    0.892 % of all cache refs      (29.96%)</span><br><span class="line">    22,998,186,284      cache-references          # 2801.824 M/sec                    (30.01%)</span><br><span class="line">    22,559,518,941      cpu-cycles                #    2.748 GHz                      (35.03%)</span><br><span class="line">    77,068,271,833      instructions              #    3.42  insn per cycle</span><br><span class="line">                                                  #    0.06  stalled cycles per insn  (35.08%)</span><br><span class="line">     4,892,933,264      stalled-cycles-backend    #   21.69% backend cycles idle      (35.13%)</span><br><span class="line">     1,103,203,963      stalled-cycles-frontend   #    4.89% frontend cycles idle     (35.13%)</span><br><span class="line">                 0      alignment-faults          #    0.000 K/sec</span><br><span class="line">                 0      bpf-output                #    0.000 K/sec</span><br><span class="line">                17      context-switches          #    0.002 K/sec</span><br><span class="line">          8,208.29 msec cpu-clock                 #    1.000 CPUs utilized</span><br><span class="line">                 3      cpu-migrations            #    0.000 K/sec</span><br><span class="line">                 0      dummy                     #    0.000 K/sec</span><br><span class="line">                 0      emulation-faults          #    0.000 K/sec</span><br><span class="line">                 0      major-faults              #    0.000 K/sec</span><br><span class="line">               227      minor-faults              #    0.028 K/sec</span><br><span class="line">               227      page-faults               #    0.028 K/sec</span><br><span class="line">          8,208.30 msec task-clock                #    1.000 CPUs utilized</span><br><span class="line">       205,384,990      L1-dcache-load-misses     #    0.89% of all L1-dcache accesses  (35.13%)</span><br><span class="line">    22,997,494,522      L1-dcache-loads           # 2801.739 M/sec                    (35.13%)</span><br><span class="line">            66,804      L1-icache-load-misses     #    0.00% of all L1-icache accesses  (35.13%)</span><br><span class="line">    15,486,704,750      L1-icache-loads           # 1886.715 M/sec                    (30.12%)</span><br><span class="line">            76,066      LLC-load-misses           #    0.00% of all LL-cache accesses  (30.09%)</span><br><span class="line">                 0      LLC-loads                 #    0.000 K/sec                    (30.03%)</span><br><span class="line">           672,231      branch-load-misses        #    0.082 M/sec                    (29.98%)</span><br><span class="line">     9,844,109,024      branch-loads              # 1199.288 M/sec                    (29.93%)</span><br><span class="line">           107,198      dTLB-load-misses          #    0.00% of all dTLB cache accesses  (29.89%)</span><br><span class="line">    22,998,647,232      dTLB-loads                # 2801.880 M/sec                    (29.84%)</span><br><span class="line">             9,497      iTLB-load-misses          #    0.08% of all iTLB cache accesses  (29.81%)</span><br><span class="line">        11,755,825      iTLB-loads                #    1.432 M/sec                    (29.82%)</span><br><span class="line"></span><br><span class="line">       8.210235171 seconds time elapsed</span><br><span class="line"></span><br><span class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-icache-load-misses,L1-icache-loads,LLC-load-misses,LLC-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads ./beforesort</span><br><span class="line">16.8872</span><br><span class="line">sum = 314931600000</span><br><span class="line"></span><br><span class="line">     1,229,182,485      branch-misses                                                 (29.93%)</span><br><span class="line">    46,401,675,872      bus-cycles                # 2747.200 M/sec                    (29.95%)</span><br><span class="line">       206,116,950      cache-misses              #    0.546 % of all cache refs      (29.97%)</span><br><span class="line">    37,773,036,315      cache-references          # 2236.343 M/sec                    (30.01%)</span><br><span class="line">    46,410,071,081      cpu-cycles                #    2.748 GHz                      (35.03%)</span><br><span class="line">    77,083,625,280      instructions              #    1.66  insn per cycle</span><br><span class="line">                                                  #    0.06  stalled cycles per insn  (35.07%)</span><br><span class="line">     1,961,071,890      stalled-cycles-backend    #    4.23% backend cycles idle      (35.11%)</span><br><span class="line">     4,988,241,014      stalled-cycles-frontend   #   10.75% frontend cycles idle     (35.11%)</span><br><span class="line">                 0      alignment-faults          #    0.000 K/sec</span><br><span class="line">                 0      bpf-output                #    0.000 K/sec</span><br><span class="line">             1,100      context-switches          #    0.065 K/sec</span><br><span class="line">         16,890.39 msec cpu-clock                 #    0.997 CPUs utilized</span><br><span class="line">                 7      cpu-migrations            #    0.000 K/sec</span><br><span class="line">                 0      dummy                     #    0.000 K/sec</span><br><span class="line">                 0      emulation-faults          #    0.000 K/sec</span><br><span class="line">                 0      major-faults              #    0.000 K/sec</span><br><span class="line">               229      minor-faults              #    0.014 K/sec</span><br><span class="line">               229      page-faults               #    0.014 K/sec</span><br><span class="line">         16,890.69 msec task-clock                #    0.997 CPUs utilized</span><br><span class="line">       205,761,970      L1-dcache-load-misses     #    0.54% of all L1-dcache accesses  (35.09%)</span><br><span class="line">    37,832,336,945      L1-dcache-loads           # 2239.854 M/sec                    (35.06%)</span><br><span class="line">           207,158      L1-icache-load-misses     #    0.00% of all L1-icache accesses  (35.04%)</span><br><span class="line">    41,944,228,741      L1-icache-loads           # 2483.298 M/sec                    (30.00%)</span><br><span class="line">           135,144      LLC-load-misses           #    0.00% of all LL-cache accesses  (29.97%)</span><br><span class="line">                 0      LLC-loads                 #    0.000 K/sec                    (29.97%)</span><br><span class="line">     1,232,325,180      branch-load-misses        #   72.960 M/sec                    (29.96%)</span><br><span class="line">    14,776,289,690      branch-loads              #  874.827 M/sec                    (29.96%)</span><br><span class="line">           177,790      dTLB-load-misses          #    0.00% of all dTLB cache accesses  (29.97%)</span><br><span class="line">    37,839,288,998      dTLB-loads                # 2240.266 M/sec                    (29.95%)</span><br><span class="line">            46,301      iTLB-load-misses          #    0.00% of all iTLB cache accesses  (29.94%)</span><br><span class="line">    12,631,307,441      iTLB-loads                #  747.833 M/sec                    (29.92%)</span><br><span class="line"></span><br><span class="line">      16.943678377 seconds time elapsed</span><br></pre></td></tr></table></figure>

<p>M710上排序与否和鲲鹏差不多，但是 M710比 鲲鹏要快一些，差别只要有主频高一点点(6%)，另外M710编译后的指令数量也略少(8%)。</p>
<p>最大的差别是没有排序的话 branch-load-misses(1,232,325,180)&#x2F;branch-loads(14,776,289,690) 比例只有鲲鹏的50%，导致整体 IPC 比鲲鹏高不少(1.66 VS 1.04)</p>
<p>如果是排序后的数据来看 M710比鲲鹏好40%，IPC 好了20%，iTLB-loads 差异特别大</p>
<h3 id="aarch64-FT-S2500"><a href="#aarch64-FT-S2500" class="headerlink" title="aarch64 FT S2500"></a>aarch64 FT S2500</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,alignment-faults,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-store-misses,L1-dcache-stores,L1-icache-load-misses,L1-icache-loads,branch-load-misses,branch-loads,dTLB-load-misses,iTLB-load-misses ./aftersort</span><br><span class="line">16.63</span><br><span class="line">sum = 314931600000</span><br><span class="line"></span><br><span class="line">         1,298,873      branch-misses             #    0.078 M/sec                    (37.49%)</span><br><span class="line">    34,893,306,641      bus-cycles                # 2096.049 M/sec                    (37.51%)</span><br><span class="line">       211,447,452      cache-misses              #    0.913 % of all cache refs      (37.53%)</span><br><span class="line">    23,154,909,673      cache-references          # 1390.921 M/sec                    (37.54%)</span><br><span class="line">    34,891,766,353      cpu-cycles                #    2.096 GHz                      (43.79%)</span><br><span class="line">    83,918,069,835      instructions              #    2.41  insns per cycle          (43.79%)</span><br><span class="line">                 0      alignment-faults          #    0.000 K/sec</span><br><span class="line">               102      context-switches          #    0.006 K/sec</span><br><span class="line">      16647.131540      cpu-clock (msec)</span><br><span class="line">                35      cpu-migrations            #    0.002 K/sec</span><br><span class="line">                 0      dummy                     #    0.000 K/sec</span><br><span class="line">                 0      emulation-faults          #    0.000 K/sec</span><br><span class="line">                 0      major-faults              #    0.000 K/sec</span><br><span class="line">               384      minor-faults              #    0.023 K/sec</span><br><span class="line">               384      page-faults               #    0.023 K/sec</span><br><span class="line">      16647.178560      task-clock (msec)         #    1.000 CPUs utilized</span><br><span class="line">       211,277,069      L1-dcache-load-misses     #    0.91% of all L1-dcache hits    (43.79%)</span><br><span class="line">    23,168,806,437      L1-dcache-loads           # 1391.756 M/sec                    (43.77%)</span><br><span class="line">       211,376,611      L1-dcache-store-misses    #   12.697 M/sec                    (43.75%)</span><br><span class="line">    23,172,492,978      L1-dcache-stores          # 1391.977 M/sec                    (43.73%)</span><br><span class="line">         6,060,438      L1-icache-load-misses     #    0.364 M/sec                    (43.72%)</span><br><span class="line">    23,283,174,318      L1-icache-loads           # 1398.626 M/sec                    (37.48%)</span><br><span class="line">         1,201,268      branch-load-misses        #    0.072 M/sec                    (37.47%)</span><br><span class="line">     6,626,003,512      branch-loads              #  398.026 M/sec                    (37.47%)</span><br><span class="line">         4,417,981      dTLB-load-misses          #    0.265 M/sec                    (37.47%)</span><br><span class="line">            58,242      iTLB-load-misses          #    0.003 M/sec                    (37.47%)</span><br><span class="line"></span><br><span class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,alignment-faults,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-store-misses,L1-dcache-stores,L1-icache-load-misses,L1-icache-loads,branch-load-misses,branch-loads,dTLB-load-misses,iTLB-load-misses ./beforesort</span><br><span class="line">39.8</span><br><span class="line">sum = 314931600000</span><br><span class="line"></span><br><span class="line">     1,641,714,982      branch-misses             #   41.244 M/sec                    (37.50%)</span><br><span class="line">    83,450,971,727      bus-cycles                # 2096.514 M/sec                    (37.51%)</span><br><span class="line">       209,942,920      cache-misses              #    0.625 % of all cache refs      (37.51%)</span><br><span class="line">    33,584,108,027      cache-references          #  843.724 M/sec                    (37.51%)</span><br><span class="line">    83,446,991,284      cpu-cycles                #    2.096 GHz                      (43.76%)</span><br><span class="line">    83,872,213,462      instructions              #    1.01  insns per cycle          (43.75%)</span><br><span class="line">                 0      alignment-faults          #    0.000 K/sec</span><br><span class="line">               165      context-switches          #    0.004 K/sec</span><br><span class="line">      39804.395840      cpu-clock (msec)</span><br><span class="line">               104      cpu-migrations            #    0.003 K/sec</span><br><span class="line">                 0      dummy                     #    0.000 K/sec</span><br><span class="line">                 0      emulation-faults          #    0.000 K/sec</span><br><span class="line">                 0      major-faults              #    0.000 K/sec</span><br><span class="line">               728      minor-faults              #    0.018 K/sec</span><br><span class="line">               728      page-faults               #    0.018 K/sec</span><br><span class="line">      39804.626860      task-clock (msec)         #    1.000 CPUs utilized</span><br><span class="line">       209,884,485      L1-dcache-load-misses     #    0.62% of all L1-dcache hits    (43.75%)</span><br><span class="line">    33,591,847,895      L1-dcache-loads           #  843.918 M/sec                    (43.75%)</span><br><span class="line">       209,796,158      L1-dcache-store-misses    #    5.271 M/sec                    (43.75%)</span><br><span class="line">    33,595,628,139      L1-dcache-stores          #  844.013 M/sec                    (43.75%)</span><br><span class="line">         5,575,802      L1-icache-load-misses     #    0.140 M/sec                    (43.75%)</span><br><span class="line">    68,272,798,305      L1-icache-loads           # 1715.198 M/sec                    (37.50%)</span><br><span class="line">     1,642,653,627      branch-load-misses        #   41.268 M/sec                    (37.50%)</span><br><span class="line">     6,846,418,902      branch-loads              #  172.001 M/sec                    (37.50%)</span><br><span class="line">         4,162,728      dTLB-load-misses          #    0.105 M/sec                    (37.50%)</span><br><span class="line">            57,375      iTLB-load-misses          #    0.001 M/sec                    (37.50%)</span><br></pre></td></tr></table></figure>

<h3 id="Intel-x86-8163"><a href="#Intel-x86-8163" class="headerlink" title="Intel x86 8163"></a>Intel x86 8163</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">#perf stat -e branch-instructions,branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,ref-cycles,alignment-faults,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-stores,L1-icache-load-misses,LLC-load-misses,LLC-loads,LLC-store-misses,LLC-stores,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,dTLB-store-misses,dTLB-stores,iTLB-load-misses,iTLB-loads,node-load-misses,node-loads,node-store-misses,node-stores ./aftersort</span><br><span class="line">9.77</span><br><span class="line">sum = 314931600000</span><br><span class="line"></span><br><span class="line">     6,541,060,672      branch-instructions       #  669.204 M/sec                    (10.72%)</span><br><span class="line">           727,847      branch-misses             #    0.01% of all branches          (14.30%)</span><br><span class="line">       241,730,862      bus-cycles                #   24.731 M/sec                    (17.88%)</span><br><span class="line">           275,443      cache-misses              #   44.685 % of all cache refs      (21.45%)</span><br><span class="line">           616,413      cache-references          #    0.063 M/sec                    (25.03%)</span><br><span class="line">    24,186,369,646      cpu-cycles                #    2.474 GHz                      (28.60%)</span><br><span class="line">    29,491,804,977      instructions              #    1.22  insns per cycle          (32.18%)</span><br><span class="line">    24,198,780,299      ref-cycles                # 2475.731 M/sec                    (35.75%)</span><br><span class="line">                 0      alignment-faults          #    0.000 K/sec</span><br><span class="line">                16      context-switches          #    0.002 K/sec</span><br><span class="line">       9774.393202      cpu-clock (msec)</span><br><span class="line">                 8      cpu-migrations            #    0.001 K/sec</span><br><span class="line">                 0      dummy                     #    0.000 K/sec</span><br><span class="line">                 0      emulation-faults          #    0.000 K/sec</span><br><span class="line">                 0      major-faults              #    0.000 K/sec</span><br><span class="line">               490      minor-faults              #    0.050 K/sec</span><br><span class="line">               490      page-faults               #    0.050 K/sec</span><br><span class="line">       9774.396556      task-clock (msec)         #    1.001 CPUs utilized</span><br><span class="line">        74,078,676      L1-dcache-load-misses     #    1.64% of all L1-dcache hits    (189256748561.94%)</span><br><span class="line">     4,515,522,850      L1-dcache-loads           #  461.975 M/sec                    (189237344482.16%)</span><br><span class="line">         3,798,032      L1-dcache-stores          #    0.389 M/sec                    (189217941721.85%)</span><br><span class="line">         1,077,146      L1-icache-load-misses     #    0.110 M/sec                    (189198537875.18%)</span><br><span class="line">            89,144      LLC-load-misses           #   74.54% of all LL-cache hits     (189179139811.86%)</span><br><span class="line">           119,586      LLC-loads                 #    0.012 M/sec                    (189159737036.24%)</span><br><span class="line">             3,450      LLC-store-misses          #    0.353 K/sec                    (189140342885.02%)</span><br><span class="line">           105,021      LLC-stores                #    0.011 M/sec                    (7.15%)</span><br><span class="line">           458,465      branch-load-misses        #    0.047 M/sec                    (10.73%)</span><br><span class="line">     6,557,558,579      branch-loads              #  670.891 M/sec                    (14.30%)</span><br><span class="line">               733      dTLB-load-misses          #    0.00% of all dTLB cache hits   (17.87%)</span><br><span class="line">    12,039,967,837      dTLB-loads                # 1231.786 M/sec                    (21.44%)</span><br><span class="line">               104      dTLB-store-misses         #    0.011 K/sec                    (25.01%)</span><br><span class="line">         7,040,783      dTLB-stores               #    0.720 M/sec                    (28.58%)</span><br><span class="line">               763      iTLB-load-misses          #   62.80% of all iTLB cache hits   (28.56%)</span><br><span class="line">             1,215      iTLB-loads                #    0.124 K/sec                    (28.55%)</span><br><span class="line">           168,588      node-load-misses          #    0.017 M/sec                    (28.55%)</span><br><span class="line">           131,578      node-loads                #    0.013 M/sec                    (28.55%)</span><br><span class="line">             4,484      node-store-misses         #    0.459 K/sec                    (7.14%)</span><br><span class="line">                42      node-stores               #    0.004 K/sec                    (7.14%)</span><br><span class="line">                </span><br><span class="line">#perf stat -e branch-instructions,branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,ref-cycles,alignment-faults,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-stores,L1-icache-load-misses,LLC-load-misses,LLC-loads,LLC-store-misses,LLC-stores,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,dTLB-store-misses,dTLB-stores,iTLB-load-misses,iTLB-loads,node-load-misses,node-loads,node-store-misses,node-stores ./beforesort</span><br><span class="line">29.52</span><br><span class="line">sum = 314931600000</span><br><span class="line"></span><br><span class="line">     6,565,036,614      branch-instructions       #  222.370 M/sec                    (10.72%)</span><br><span class="line">     1,599,826,737      branch-misses             #   24.37% of all branches          (14.29%)</span><br><span class="line">       730,977,010      bus-cycles                #   24.760 M/sec                    (17.86%)</span><br><span class="line">           920,858      cache-misses              #   48.057 % of all cache refs      (21.43%)</span><br><span class="line">         1,916,178      cache-references          #    0.065 M/sec                    (25.00%)</span><br><span class="line">    73,123,904,158      cpu-cycles                #    2.477 GHz                      (28.57%)</span><br><span class="line">    29,618,485,912      instructions              #    0.41  insns per cycle          (32.14%)</span><br><span class="line">    73,152,861,566      ref-cycles                # 2477.828 M/sec                    (35.72%)</span><br><span class="line">                 0      alignment-faults          #    0.000 K/sec</span><br><span class="line">                26      context-switches          #    0.001 K/sec</span><br><span class="line">      29522.972689      cpu-clock (msec)</span><br><span class="line">                13      cpu-migrations            #    0.000 K/sec</span><br><span class="line">                 0      dummy                     #    0.000 K/sec</span><br><span class="line">                 0      emulation-faults          #    0.000 K/sec</span><br><span class="line">                 0      major-faults              #    0.000 K/sec</span><br><span class="line">               593      minor-faults              #    0.020 K/sec</span><br><span class="line">               593      page-faults               #    0.020 K/sec</span><br><span class="line">      29522.976661      task-clock (msec)         #    1.001 CPUs utilized</span><br><span class="line">        76,164,025      L1-dcache-load-misses     #    1.68% of all L1-dcache hits    (62596004730.92%)</span><br><span class="line">     4,521,935,099      L1-dcache-loads           #  153.167 M/sec                    (62593882213.79%)</span><br><span class="line">         1,170,288      L1-dcache-stores          #    0.040 M/sec                    (62591759384.11%)</span><br><span class="line">         2,975,318      L1-icache-load-misses     #    0.101 M/sec                    (62591281765.29%)</span><br><span class="line">           178,510      LLC-load-misses           #   66.98% of all LL-cache hits     (62591281765.30%)</span><br><span class="line">           266,514      LLC-loads                 #    0.009 M/sec                    (62591281765.18%)</span><br><span class="line">             6,841      LLC-store-misses          #    0.232 K/sec                    (62591578887.87%)</span><br><span class="line">           335,369      LLC-stores                #    0.011 M/sec                    (7.15%)</span><br><span class="line">     1,600,893,693      branch-load-misses        #   54.225 M/sec                    (10.72%)</span><br><span class="line">     6,565,516,562      branch-loads              #  222.387 M/sec                    (14.29%)</span><br><span class="line">            33,070      dTLB-load-misses          #    0.00% of all dTLB cache hits   (17.87%)</span><br><span class="line">    12,043,088,689      dTLB-loads                #  407.923 M/sec                    (21.44%)</span><br><span class="line">               180      dTLB-store-misses         #    0.006 K/sec                    (25.01%)</span><br><span class="line">         2,359,365      dTLB-stores               #    0.080 M/sec                    (28.58%)</span><br><span class="line">             9,399      iTLB-load-misses          #  849.82% of all iTLB cache hits   (28.58%)</span><br><span class="line">             1,106      iTLB-loads                #    0.037 K/sec                    (28.58%)</span><br><span class="line">           439,052      node-load-misses          #    0.015 M/sec                    (28.58%)</span><br><span class="line">           367,546      node-loads                #    0.012 M/sec                    (28.58%)</span><br><span class="line">             7,539      node-store-misses         #    0.255 K/sec                    (7.15%)</span><br><span class="line">             1,736      node-stores               #    0.059 K/sec                    (7.14%)            </span><br></pre></td></tr></table></figure>

<p>从 x86 和 aarch 对比来看，x86 编译后的指令数是 aarch 的35%，ARM 是精简指令，数量多比较好理解。主频2.5 GHz 较 M710低了11%。</p>
<p>IPC 差异比较大，有一部分是因为 ARM 精简指令本来有较高的 IPC。</p>
<p>从排序前的差异来看除了指令集外导致 IPC 较高的原因主要也是 branch-load-misses(1,232,325,180)&#x2F;branch-loads(14,776,289,690)  比 intel的 1,602,020,038&#x2F;6,568,921,480, 也就是 M710的 branch miss 率比 intel 低了一倍。</p>
<p>排序后去掉了 branch miss 差异，M710 比 intel 快了 10%，只要是因为主频的差异</p>
<p>on 8269 3.2GHz</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">#perf stat -e branch-instructions,branch-misses,cpu-cycles,instructions,branch-load-misses,branch-loads,task-clock,cpu-clock ./beforesort</span><br><span class="line">22.96</span><br><span class="line">sum = 314931600000</span><br><span class="line"></span><br><span class="line"> Performance counter stats for &#x27;./beforesort&#x27;:</span><br><span class="line"></span><br><span class="line">     6,573,626,859      branch-instructions       #  286.177 M/sec                    (83.33%)</span><br><span class="line">     1,602,898,541      branch-misses             #   24.38% of all branches          (83.33%)</span><br><span class="line">    73,189,204,878      cpu-cycles                #    3.186 GHz                      (66.67%)</span><br><span class="line">    29,627,520,323      instructions              #    0.40  insns per cycle          (83.33%)</span><br><span class="line">     1,602,848,454      branch-load-misses        #   69.779 M/sec                    (83.33%)</span><br><span class="line">     6,572,915,651      branch-loads              #  286.146 M/sec                    (83.33%)</span><br><span class="line">      22970.482491      task-clock (msec)         #    1.001 CPUs utilized</span><br><span class="line">      22970.482557      cpu-clock (msec)</span><br></pre></td></tr></table></figure>

<h3 id="hygon-7260-1"><a href="#hygon-7260-1" class="headerlink" title="hygon 7260"></a>hygon 7260</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">#perf stat -e branch-instructions,branch-misses,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-prefetches,L1-icache-load-misses,L1-icache-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads ./aftersort</span><br><span class="line">10.9479</span><br><span class="line">sum = 314931600000</span><br><span class="line">     9,848,123,830      branch-instructions       #  898.161 M/sec                    (26.26%)</span><br><span class="line">           496,734      branch-misses             #    0.01% of all branches          (26.30%)</span><br><span class="line">           713,235      cache-misses              #    0.336 % of all cache refs      (26.34%)</span><br><span class="line">       212,455,257      cache-references          #   19.376 M/sec                    (26.37%)</span><br><span class="line">    27,277,461,559      cpu-cycles                #    2.488 GHz                      (26.41%)</span><br><span class="line">    32,785,270,866      instructions              #    1.20  insn per cycle</span><br><span class="line">                                                  #    0.58  stalled cycles per insn  (26.43%)</span><br><span class="line">    19,069,766,918      stalled-cycles-backend    #   69.91% backend cycles idle      (26.43%)</span><br><span class="line">         6,560,109      stalled-cycles-frontend   #    0.02% frontend cycles idle     (26.42%)</span><br><span class="line">                 0      alignment-faults          #    0.000 K/sec</span><br><span class="line">                 0      bpf-output                #    0.000 K/sec</span><br><span class="line">             1,086      context-switches          #    0.099 K/sec</span><br><span class="line">         10,964.61 msec cpu-clock                 #    0.999 CPUs utilized</span><br><span class="line">                 0      cpu-migrations            #    0.000 K/sec</span><br><span class="line">                 0      dummy                     #    0.000 K/sec</span><br><span class="line">                 0      emulation-faults          #    0.000 K/sec</span><br><span class="line">                 0      major-faults              #    0.000 K/sec</span><br><span class="line">               154      minor-faults              #    0.014 K/sec</span><br><span class="line">               154      page-faults               #    0.014 K/sec</span><br><span class="line">         10,964.91 msec task-clock                #    0.999 CPUs utilized</span><br><span class="line">       206,294,123      L1-dcache-load-misses     #    1.14% of all L1-dcache hits    (26.38%)</span><br><span class="line">    18,083,269,173      L1-dcache-loads           # 1649.217 M/sec                    (26.35%)</span><br><span class="line">       205,499,292      L1-dcache-prefetches      #   18.742 M/sec                    (26.31%)</span><br><span class="line">           749,548      L1-icache-load-misses     #    8.67% of all L1-icache hits    (26.27%)</span><br><span class="line">         8,643,478      L1-icache-loads           #    0.788 M/sec                    (26.25%)</span><br><span class="line">           305,577      branch-load-misses        #    0.028 M/sec                    (26.25%)</span><br><span class="line">     9,850,674,490      branch-loads              #  898.394 M/sec                    (26.25%)</span><br><span class="line">             6,736      dTLB-load-misses          #    6.85% of all dTLB cache hits   (26.25%)</span><br><span class="line">            98,327      dTLB-loads                #    0.009 M/sec                    (26.25%)</span><br><span class="line">               114      iTLB-load-misses          #   78.62% of all iTLB cache hits   (26.25%)</span><br><span class="line">               145      iTLB-loads                #    0.013 K/sec                    (26.25%)</span><br><span class="line">               </span><br><span class="line">#perf stat -e branch-instructions,branch-misses,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-prefetches,L1-icache-load-misses,L1-icache-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads ./beforesort</span><br><span class="line">23.3648</span><br><span class="line">sum = 314931600000</span><br><span class="line"></span><br><span class="line">     9,843,358,378      branch-instructions       #  421.186 M/sec                    (26.26%)</span><br><span class="line">     1,156,804,801      branch-misses             #   11.75% of all branches          (26.28%)</span><br><span class="line">           754,542      cache-misses              #    0.351 % of all cache refs      (26.29%)</span><br><span class="line">       215,234,724      cache-references          #    9.210 M/sec                    (26.31%)</span><br><span class="line">    58,274,116,562      cpu-cycles                #    2.493 GHz                      (26.33%)</span><br><span class="line">    32,850,416,330      instructions              #    0.56  insn per cycle</span><br><span class="line">                                                  #    0.06  stalled cycles per insn  (26.34%)</span><br><span class="line">     1,838,222,200      stalled-cycles-backend    #    3.15% backend cycles idle      (26.34%)</span><br><span class="line">     1,187,291,146      stalled-cycles-frontend   #    2.04% frontend cycles idle     (26.34%)</span><br><span class="line">                 0      alignment-faults          #    0.000 K/sec</span><br><span class="line">                 0      bpf-output                #    0.000 K/sec</span><br><span class="line">             2,326      context-switches          #    0.100 K/sec</span><br><span class="line">         23,370.23 msec cpu-clock                 #    0.999 CPUs utilized</span><br><span class="line">                 0      cpu-migrations            #    0.000 K/sec</span><br><span class="line">                 0      dummy                     #    0.000 K/sec</span><br><span class="line">                 0      emulation-faults          #    0.000 K/sec</span><br><span class="line">                 0      major-faults              #    0.000 K/sec</span><br><span class="line">               150      minor-faults              #    0.006 K/sec</span><br><span class="line">               150      page-faults               #    0.006 K/sec</span><br><span class="line">         23,370.97 msec task-clock                #    0.999 CPUs utilized</span><br><span class="line">       207,451,839      L1-dcache-load-misses     #    0.82% of all L1-dcache hits    (26.34%)</span><br><span class="line">    25,180,673,249      L1-dcache-loads           # 1077.451 M/sec                    (26.34%)</span><br><span class="line">       205,669,557      L1-dcache-prefetches      #    8.800 M/sec                    (26.34%)</span><br><span class="line">         1,725,971      L1-icache-load-misses     #    8.12% of all L1-icache hits    (26.34%)</span><br><span class="line">        21,265,604      L1-icache-loads           #    0.910 M/sec                    (26.34%)</span><br><span class="line">     1,157,454,249      branch-load-misses        #   49.526 M/sec                    (26.34%)</span><br><span class="line">     9,843,015,406      branch-loads              #  421.171 M/sec                    (26.33%)</span><br><span class="line">            22,287      dTLB-load-misses          #    7.08% of all dTLB cache hits   (26.31%)</span><br><span class="line">           314,618      dTLB-loads                #    0.013 M/sec                    (26.29%)</span><br><span class="line">               445      iTLB-load-misses          #   44.95% of all iTLB cache hits   (26.28%)</span><br><span class="line">               990      iTLB-loads                #    0.042 K/sec                    (26.26%)</span><br></pre></td></tr></table></figure>

<p>hygon 在这两个场景中排序前比 intel 好了 20%，IPC 好30%，但是指令数多了10%，最关键的也是因为hygon的 branch-load-misses 率较低。</p>
<p>排序后 hygon 略慢10%，主要是指令数多了将近10%。</p>
<p>如果直接将 intel 下 编译好的二进制放到 hygon 下运行，完全可以跑通，指令数也显示和 intel 一样了，但是总时间较在hygon下编译的二进制没有变化</p>
<p><img src="/images/951413iMgBlog/image-20230308145915585.png" alt="image-20230308145915585"></p>
<h2 id="开启-gcc-O3-优化"><a href="#开启-gcc-O3-优化" class="headerlink" title="开启 gcc O3 优化"></a>开启 gcc O3 优化</h2><h3 id="intel-8163"><a href="#intel-8163" class="headerlink" title="intel 8163"></a>intel 8163</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">#perf stat -e branch-instructions,branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,ref-cycles,alignment-faults,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-stores,L1-icache-load-misses,LLC-load-misses,LLC-loads,LLC-store-misses,LLC-stores,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,dTLB-store-misses,dTLB-stores,iTLB-load-misses,iTLB-loads,node-load-misses,node-loads,node-store-misses,node-stores ./beforesort</span><br><span class="line">2.94</span><br><span class="line">sum = 314931600000</span><br><span class="line"></span><br><span class="line">     3,268,501,946      branch-instructions       # 1109.263 M/sec                    (10.74%)</span><br><span class="line">           226,833      branch-misses             #    0.01% of all branches          (14.33%)</span><br><span class="line">        72,998,727      bus-cycles                #   24.774 M/sec                    (17.90%)</span><br><span class="line">            89,636      cache-misses              #   34.026 % of all cache refs      (21.47%)</span><br><span class="line">           263,434      cache-references          #    0.089 M/sec                    (25.03%)</span><br><span class="line">     7,301,839,495      cpu-cycles                #    2.478 GHz                      (28.59%)</span><br><span class="line">    26,180,809,574      instructions              #    3.59  insns per cycle          (32.16%)</span><br><span class="line">     7,304,150,283      ref-cycles                # 2478.880 M/sec                    (35.73%)</span><br><span class="line">                 0      alignment-faults          #    0.000 K/sec</span><br><span class="line">                10      context-switches          #    0.003 K/sec</span><br><span class="line">       2946.550492      cpu-clock (msec)</span><br><span class="line">                 7      cpu-migrations            #    0.002 K/sec</span><br><span class="line">                 0      dummy                     #    0.000 K/sec</span><br><span class="line">                 0      emulation-faults          #    0.000 K/sec</span><br><span class="line">                 0      major-faults              #    0.000 K/sec</span><br><span class="line">               370      minor-faults              #    0.126 K/sec</span><br><span class="line">               370      page-faults               #    0.126 K/sec</span><br><span class="line">       2946.552985      task-clock (msec)         #    1.001 CPUs utilized</span><br><span class="line">        73,550,829      L1-dcache-load-misses     #    8.97% of all L1-dcache hits    (627063379426.55%)</span><br><span class="line">       820,264,255      L1-dcache-loads           #  278.381 M/sec                    (627063379426.55%)</span><br><span class="line">             6,301      L1-dcache-stores          #    0.002 M/sec                    (627063379426.52%)</span><br><span class="line">           344,639      L1-icache-load-misses     #    0.117 M/sec                    (627063379426.51%)</span><br><span class="line">            70,181      LLC-load-misses           #   84.80% of all LL-cache hits     (630745019998.59%)</span><br><span class="line">            82,757      LLC-loads                 #    0.028 M/sec                    (630529428492.86%)</span><br><span class="line">               592      LLC-store-misses          #    0.201 K/sec                    (630313967916.99%)</span><br><span class="line">            33,362      LLC-stores                #    0.011 M/sec                    (7.17%)</span><br><span class="line">           153,522      branch-load-misses        #    0.052 M/sec                    (10.75%)</span><br><span class="line">     3,263,884,498      branch-loads              # 1107.696 M/sec                    (14.33%)</span><br><span class="line">               274      dTLB-load-misses          #    0.00% of all dTLB cache hits   (17.90%)</span><br><span class="line">     2,179,821,780      dTLB-loads                #  739.787 M/sec                    (21.47%)</span><br><span class="line">                 8      dTLB-store-misses         #    0.003 K/sec                    (25.04%)</span><br><span class="line">            12,708      dTLB-stores               #    0.004 M/sec                    (28.61%)</span><br><span class="line">                59      iTLB-load-misses          #   52.68% of all iTLB cache hits   (28.60%)</span><br><span class="line">               112      iTLB-loads                #    0.038 K/sec                    (28.59%)</span><br><span class="line">             5,919      node-load-misses          #    0.002 M/sec                    (28.59%)</span><br><span class="line">             1,648      node-loads                #    0.559 K/sec                    (28.58%)</span><br><span class="line">               560      node-store-misses         #    0.190 K/sec                    (7.15%)</span><br><span class="line">                14      node-stores               #    0.005 K/sec                    (7.14%)</span><br><span class="line">                </span><br><span class="line">#perf stat -e branch-instructions,branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,ref-cycles,alignment-faults,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-dcache-stores,L1-icache-load-misses,LLC-load-misses,LLC-loads,LLC-store-misses,LLC-stores,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,dTLB-store-misses,dTLB-stores,iTLB-load-misses,iTLB-loads,node-load-misses,node-loads,node-store-misses,node-stores ./aftersort</span><br><span class="line">2.95</span><br><span class="line">sum = 314931600000</span><br><span class="line"></span><br><span class="line">     3,255,184,180      branch-instructions       # 1102.320 M/sec                    (10.74%)</span><br><span class="line">           791,180      branch-misses             #    0.02% of all branches          (14.35%)</span><br><span class="line">        73,001,075      bus-cycles                #   24.721 M/sec                    (17.93%)</span><br><span class="line">           520,140      cache-misses              #   82.262 % of all cache refs      (21.52%)</span><br><span class="line">           632,298      cache-references          #    0.214 M/sec                    (25.11%)</span><br><span class="line">     7,309,286,959      cpu-cycles                #    2.475 GHz                      (28.69%)</span><br><span class="line">    26,120,077,275      instructions              #    3.57  insns per cycle          (32.28%)</span><br><span class="line">     7,316,568,954      ref-cycles                # 2477.649 M/sec                    (35.86%)</span><br><span class="line">                 0      alignment-faults          #    0.000 K/sec</span><br><span class="line">                10      context-switches          #    0.003 K/sec</span><br><span class="line">       2953.027151      cpu-clock (msec)</span><br><span class="line">                 3      cpu-migrations            #    0.001 K/sec</span><br><span class="line">                 0      dummy                     #    0.000 K/sec</span><br><span class="line">                 0      emulation-faults          #    0.000 K/sec</span><br><span class="line">                 0      major-faults              #    0.000 K/sec</span><br><span class="line">               370      minor-faults              #    0.125 K/sec</span><br><span class="line">               370      page-faults               #    0.125 K/sec</span><br><span class="line">       2953.029425      task-clock (msec)         #    1.001 CPUs utilized</span><br><span class="line">        73,778,174      L1-dcache-load-misses     #    8.94% of all L1-dcache hits    (625801033059.49%)</span><br><span class="line">       825,038,324      L1-dcache-loads           #  279.387 M/sec                    (625693600466.98%)</span><br><span class="line">             6,137      L1-dcache-stores          #    0.002 M/sec                    (625693600466.94%)</span><br><span class="line">           339,275      L1-icache-load-misses     #    0.115 M/sec                    (625693600466.87%)</span><br><span class="line">             7,611      LLC-load-misses           #   52.34% of all LL-cache hits     (625693600466.22%)</span><br><span class="line">            14,542      LLC-loads                 #    0.005 M/sec                    (625693600466.18%)</span><br><span class="line">               975      LLC-store-misses          #    0.330 K/sec                    (625718826721.74%)</span><br><span class="line">            28,542      LLC-stores                #    0.010 M/sec                    (7.17%)</span><br><span class="line">           150,256      branch-load-misses        #    0.051 M/sec                    (10.75%)</span><br><span class="line">     3,260,765,171      branch-loads              # 1104.210 M/sec                    (14.33%)</span><br><span class="line">                84      dTLB-load-misses          #    0.00% of all dTLB cache hits   (17.91%)</span><br><span class="line">     2,177,927,665      dTLB-loads                #  737.523 M/sec                    (21.48%)</span><br><span class="line">                 0      dTLB-store-misses         #    0.000 K/sec                    (25.05%)</span><br><span class="line">            12,502      dTLB-stores               #    0.004 M/sec                    (28.62%)</span><br><span class="line">                10      iTLB-load-misses          #    5.62% of all iTLB cache hits   (28.61%)</span><br><span class="line">               178      iTLB-loads                #    0.060 K/sec                    (28.60%)</span><br><span class="line">            14,538      node-load-misses          #    0.005 M/sec                    (28.59%)</span><br><span class="line">             1,527      node-loads                #    0.517 K/sec                    (28.62%)</span><br><span class="line">             2,339      node-store-misses         #    0.792 K/sec                    (7.18%)</span><br><span class="line">                 0      node-stores               #    0.000 K/sec                    (7.14%)                </span><br></pre></td></tr></table></figure>

<p>可以看到 O3 优化后是否排序执行时间差不多，并且都比没有 O3 前的快几倍，指令数较优化前基本不变。</p>
<p>最明显的是排序前的 branch-load-misses 几乎都被优化掉了，这也导致 IPC 从0.41 提升到了3.59</p>
<h3 id="aarch64-M710-1"><a href="#aarch64-M710-1" class="headerlink" title="aarch64 M710"></a>aarch64 M710</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-icache-load-misses,L1-icache-loads,LLC-load-misses,LLC-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads  ./beforesort</span><br><span class="line">1.19468</span><br><span class="line">sum = 314931600000</span><br><span class="line"></span><br><span class="line">           178,045      branch-misses                                                 (29.84%)</span><br><span class="line">     3,290,281,574      bus-cycles                # 2748.321 M/sec                    (29.84%)</span><br><span class="line">       204,017,139      cache-misses              #   24.768 % of all cache refs      (29.84%)</span><br><span class="line">       823,700,482      cache-references          #  688.024 M/sec                    (29.84%)</span><br><span class="line">     3,290,247,311      cpu-cycles                #    2.748 GHz                      (34.85%)</span><br><span class="line">     5,730,855,778      instructions              #    1.74  insn per cycle</span><br><span class="line">                                                  #    0.26  stalled cycles per insn  (34.85%)</span><br><span class="line">     1,485,014,712      stalled-cycles-backend    #   45.13% backend cycles idle      (35.03%)</span><br><span class="line">           980,441      stalled-cycles-frontend   #    0.03% frontend cycles idle     (35.08%)</span><br><span class="line">                 0      alignment-faults          #    0.000 K/sec</span><br><span class="line">                 0      bpf-output                #    0.000 K/sec</span><br><span class="line">                 2      context-switches          #    0.002 K/sec</span><br><span class="line">          1,197.20 msec cpu-clock                 #    1.000 CPUs utilized</span><br><span class="line">                 0      cpu-migrations            #    0.000 K/sec</span><br><span class="line">                 0      dummy                     #    0.000 K/sec</span><br><span class="line">                 0      emulation-faults          #    0.000 K/sec</span><br><span class="line">                 0      major-faults              #    0.000 K/sec</span><br><span class="line">               140      minor-faults              #    0.117 K/sec</span><br><span class="line">               140      page-faults               #    0.117 K/sec</span><br><span class="line">          1,197.20 msec task-clock                #    1.000 CPUs utilized</span><br><span class="line">       205,399,817      L1-dcache-load-misses     #   25.00% of all L1-dcache accesses  (35.08%)</span><br><span class="line">       821,607,081      L1-dcache-loads           #  686.276 M/sec                    (35.08%)</span><br><span class="line">            10,361      L1-icache-load-misses     #    0.00% of all L1-icache accesses  (35.08%)</span><br><span class="line">     1,150,511,080      L1-icache-loads           #  961.004 M/sec                    (30.07%)</span><br><span class="line">             6,275      LLC-load-misses           #    0.00% of all LL-cache accesses  (30.07%)</span><br><span class="line">                 0      LLC-loads                 #    0.000 K/sec                    (30.07%)</span><br><span class="line">           103,368      branch-load-misses        #    0.086 M/sec                    (30.07%)</span><br><span class="line">       821,524,106      branch-loads              #  686.206 M/sec                    (30.07%)</span><br><span class="line">            15,315      dTLB-load-misses          #    0.00% of all dTLB cache accesses  (30.07%)</span><br><span class="line">       821,589,564      dTLB-loads                #  686.261 M/sec                    (30.07%)</span><br><span class="line">             1,084      iTLB-load-misses          #    0.07% of all iTLB cache accesses  (30.07%)</span><br><span class="line">         1,613,786      iTLB-loads                #    1.348 M/sec                    (29.89%)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#perf stat -e branch-misses,bus-cycles,cache-misses,cache-references,cpu-cycles,instructions,stalled-cycles-backend,stalled-cycles-frontend,alignment-faults,bpf-output,context-switches,cpu-clock,cpu-migrations,dummy,emulation-faults,major-faults,minor-faults,page-faults,task-clock,L1-dcache-load-misses,L1-dcache-loads,L1-icache-load-misses,L1-icache-loads,LLC-load-misses,LLC-loads,branch-load-misses,branch-loads,dTLB-load-misses,dTLB-loads,iTLB-load-misses,iTLB-loads  ./aftersort</span><br><span class="line">1.1949</span><br><span class="line">sum = 314931600000</span><br><span class="line"></span><br><span class="line">           656,175      branch-misses                                                 (29.91%)</span><br><span class="line">     3,293,615,450      bus-cycles                # 2748.397 M/sec                    (29.91%)</span><br><span class="line">       203,683,518      cache-misses              #   24.631 % of all cache refs      (29.91%)</span><br><span class="line">       826,934,774      cache-references          #  690.046 M/sec                    (29.91%)</span><br><span class="line">     3,293,560,111      cpu-cycles                #    2.748 GHz                      (34.92%)</span><br><span class="line">     5,732,241,288      instructions              #    1.74  insn per cycle</span><br><span class="line">                                                  #    0.29  stalled cycles per insn  (34.91%)</span><br><span class="line">     1,645,938,192      stalled-cycles-backend    #   49.97% backend cycles idle      (35.00%)</span><br><span class="line">         1,757,056      stalled-cycles-frontend   #    0.05% frontend cycles idle     (35.05%)</span><br><span class="line">                 0      alignment-faults          #    0.000 K/sec</span><br><span class="line">                 0      bpf-output                #    0.000 K/sec</span><br><span class="line">                 2      context-switches          #    0.002 K/sec</span><br><span class="line">          1,198.38 msec cpu-clock                 #    1.000 CPUs utilized</span><br><span class="line">                 0      cpu-migrations            #    0.000 K/sec</span><br><span class="line">                 0      dummy                     #    0.000 K/sec</span><br><span class="line">                 0      emulation-faults          #    0.000 K/sec</span><br><span class="line">                 0      major-faults              #    0.000 K/sec</span><br><span class="line">               137      minor-faults              #    0.114 K/sec</span><br><span class="line">               137      page-faults               #    0.114 K/sec</span><br><span class="line">          1,198.38 msec task-clock                #    1.000 CPUs utilized</span><br><span class="line">       205,557,180      L1-dcache-load-misses     #   25.00% of all L1-dcache accesses  (35.05%)</span><br><span class="line">       822,366,213      L1-dcache-loads           #  686.233 M/sec                    (35.04%)</span><br><span class="line">            12,708      L1-icache-load-misses     #    0.00% of all L1-icache accesses  (35.05%)</span><br><span class="line">       987,422,733      L1-icache-loads           #  823.967 M/sec                    (30.04%)</span><br><span class="line">             6,234      LLC-load-misses           #    0.00% of all LL-cache accesses  (30.04%)</span><br><span class="line">                 0      LLC-loads                 #    0.000 K/sec                    (30.04%)</span><br><span class="line">           103,635      branch-load-misses        #    0.086 M/sec                    (30.04%)</span><br><span class="line">       822,357,251      branch-loads              #  686.226 M/sec                    (30.04%)</span><br><span class="line">            13,961      dTLB-load-misses          #    0.00% of all dTLB cache accesses  (30.04%)</span><br><span class="line">       822,374,897      dTLB-loads                #  686.241 M/sec                    (30.04%)</span><br><span class="line">               709      iTLB-load-misses          #    0.05% of all iTLB cache accesses  (30.04%)</span><br><span class="line">         1,562,083      iTLB-loads                #    1.303 M/sec                    (29.96%)</span><br></pre></td></tr></table></figure>

<p>可以看到在M710上开启 O3 优化后是否排序执行时间差不多，并且都比没有 O3 前</p>
<p>的快几倍，最明显的是指令数只有之前的7%。另外就是排序前的 branch-load-misses 几乎都被优化掉了，虽然这里 IPC 提升不大但主要在指令数的减少上。</p>
<p>O3意味着代码尽可能展开，更长的代码意味着对 L1i（以及 L2和更高级别）高速缓存的压力更高。这会导致性能降低。更短的代码可以运行得更快。幸运的是，gcc 有一个优化选项可以指定此项。如果使用-Os，则编译器将优化代码大小。使用后，能够增加代码大小的哪些优化将被禁用。使用此选项通常会产生令人惊讶的结果。特别是循环展开和内联没有实质优势时，那么此选项将是一个很好的选择。</p>
<h2 id="分支预测原理介绍"><a href="#分支预测原理介绍" class="headerlink" title="分支预测原理介绍"></a>分支预测原理介绍</h2><p><img src="/images/951413iMgBlog/v2-475f184ea376484878515491a120bf49_1440w.png" alt="img"></p>
<p>如上图的上面部分代表通常情况下的简单代码布局。如果区域 B（这里是内联函数 inlfct 生成的代码）经常由于条件 I 被跳过，而不会执行，处理器的预取将拉入很少使用的包含块 B 的高速缓存行。使用块重新排序可以改变这种局面，改变之后的效果可以在图的下半部分看到。经常执行的代码在内存中是线性的，而很少执行的代码被移动到不会损害预取和 L1i 效率的位置。</p>
<h2 id="Linux内核流水线优化案例"><a href="#Linux内核流水线优化案例" class="headerlink" title="Linux内核流水线优化案例"></a>Linux内核流水线优化案例</h2><p>在Linux Kernel中有大量的 likely&#x2F;unlikely</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ip 层收到消息后，如果是tcp就调用tcp_v4_rcv作为tcp协议的入口</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">tcp_v4_rcv</span><span class="params">(<span class="keyword">struct</span> sk_buff *skb)</span></span><br><span class="line">&#123;</span><br><span class="line">  ...</span><br><span class="line">	<span class="keyword">if</span> (unlikely(th-&gt;doff &lt; <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tcphdr) / <span class="number">4</span>))</span><br><span class="line">		<span class="keyword">goto</span> bad_packet; <span class="comment">//概率很小</span></span><br><span class="line">	<span class="keyword">if</span> (!pskb_may_pull(skb, th-&gt;doff * <span class="number">4</span>))</span><br><span class="line">		<span class="keyword">goto</span> discard_it;</span><br><span class="line">  </span><br><span class="line"><span class="comment">//file: net/ipv4/tcp_input.c</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">tcp_rcv_established</span><span class="params">(<span class="keyword">struct</span> sock *sk, ...)</span></span><br><span class="line">&#123;</span><br><span class="line"> <span class="keyword">if</span> (unlikely(sk-&gt;sk_rx_dst == <span class="literal">NULL</span>))</span><br><span class="line">  ......</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//file: include/linux/compiler.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> likely(x)   __builtin_expect(!!(x),1)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> unlikely(x) __builtin_expect(!!(x),0)</span></span><br></pre></td></tr></table></figure>

<p>__builtin_expect 这个指令是 gcc 引入的。该函数作用是允许程序员将最有可能执行的分支告诉编译器，来辅助系统进行分支预测。(参见 <a target="_blank" rel="noopener" href="https://gcc.gnu.org/onlinedocs/gcc/Other-Builtins.html">https://gcc.gnu.org/onlinedocs/gcc/Other-Builtins.html</a>)</p>
<p>它的用法为：__builtin_expect(EXP, N)。意思是：EXP &#x3D;&#x3D; N的概率很大。那么上面 likely 和 unlikely 这两句的具体含义就是：</p>
<ul>
<li>__builtin_expect(!!(x),1) x 为真的可能性更大  &#x2F;&#x2F;0两次取反还是0，非0两次取反都是1，这样可以适配__builtin_expect(EXP, N)的N，要不N的参数没法传</li>
<li>__builtin_expect(!!(x),0) x 为假的可能性更大</li>
</ul>
<p>当正确地使用了__builtin_expect后，编译器在编译过程中会根据程序员的指令，将可能性更大的代码紧跟着前面的代码，从而减少指令跳转带来的性能上的下降。让L1i中加载的代码尽量有效紧凑</p>
<p>这样可以让 CPU流水线分支预测的时候默认走可能性更大的分支。如果分支预测错误所有流水线都要取消重新计算。</p>
<p>如果程序员利用这些宏，然后使用 <code>-freorder-blocks</code> 优化选项，则 gcc 将对块进行重新排序，如原理解图所示。该选项在 -O 2中启用，但在-Os 中禁用。还有另一种对块进行重新排序的选项（<code>-freorder-blocks-and-partition</code> ），但是它的用处有限，因为它不适用于异常处理。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>不排序的代码(分支极难预测正确)运行数据对比：</p>
<table>
<thead>
<tr>
<th></th>
<th>branch-load-misses&#x2F;branch-loads</th>
<th>instructions</th>
<th>IPC</th>
<th>耗时(秒)</th>
<th>排序后耗时(秒)</th>
</tr>
</thead>
<tbody><tr>
<td>鲲鹏920</td>
<td>21.7%</td>
<td>83,694,841,472</td>
<td>1.04</td>
<td>30.92</td>
<td>11.44</td>
</tr>
<tr>
<td>M710</td>
<td>8.3%</td>
<td>77,083,625,280</td>
<td>1.66</td>
<td>16.89</td>
<td>8.20</td>
</tr>
<tr>
<td>Intel 8163</td>
<td>24.4%</td>
<td>29,618,485,912</td>
<td>0.41</td>
<td>29.52</td>
<td>9.77</td>
</tr>
<tr>
<td>hygon 7260</td>
<td>11.8%</td>
<td>32,850,416,330</td>
<td>0.56</td>
<td>23.36</td>
<td>10.95</td>
</tr>
<tr>
<td>FT S2500</td>
<td>24%</td>
<td>83,872,213,462</td>
<td>1.01</td>
<td>39.8</td>
<td>16.63</td>
</tr>
</tbody></table>
<p>排序后的代码(分支预测容易)运行数据对比：</p>
<table>
<thead>
<tr>
<th></th>
<th>instructions</th>
<th>instructions(排序前)</th>
<th>IPC</th>
<th>耗时(秒)</th>
</tr>
</thead>
<tbody><tr>
<td>鲲鹏920</td>
<td>83,666,813,837</td>
<td>83,694,841,472</td>
<td>2.82</td>
<td>11.44</td>
</tr>
<tr>
<td>M710</td>
<td>77,068,271,833</td>
<td>77,083,625,280</td>
<td>3.42</td>
<td>8.20</td>
</tr>
<tr>
<td>Intel 8163</td>
<td>29,491,804,977</td>
<td>29,618,485,912</td>
<td>1.22</td>
<td>9.77</td>
</tr>
<tr>
<td>hygon 7260</td>
<td>32,785,270,866</td>
<td>32,850,416,330</td>
<td>1.20</td>
<td>10.95</td>
</tr>
<tr>
<td>FT S2500</td>
<td>83,918,069,835</td>
<td>83,872,213,462</td>
<td>2.41</td>
<td>16.63</td>
</tr>
</tbody></table>
<ul>
<li>所有 CPU 都期望对分支预测友好的代码</li>
<li>分支预测重点关注 perf branch-load-misses&#x2F;branch-loads</li>
<li>aarch64 较 x86_64 指令数是2.6倍，同时对流水线更友好，也就是 IPC 更高(2.6倍)，测试代码单线程、无锁</li>
<li>M710的分支预测正确率是鲲鹏920、intel的3倍，hygon 是鲲鹏 、intel的分支预测率的2倍</li>
<li>10% 的分支load miss 会带来一倍的性能差异</li>
<li>gcc O3 优化效果很明显，代价就是代码展开后很大，容易造成icache不够，对小段测试代码效果最好，实践不一定</li>
<li>测试代码只是极简场景，实际生产环境更复杂，也就是预测效果不会这么明显</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2023/04/06/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%A0%E4%B8%8D%E5%8E%BB%E7%9C%8B%E6%96%87%E6%A1%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="twitter @plantegg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
      <meta itemprop="description" content="java mysql tcp performance network docker Linux">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | plantegg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/06/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%A0%E4%B8%8D%E5%8E%BB%E7%9C%8B%E6%96%87%E6%A1%A3/" class="post-title-link" itemprop="url">为什么你不去看文档</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-06 20:30:03" itemprop="dateCreated datePublished" datetime="2023-04-06T20:30:03+08:00">2023-04-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-11-16 19:58:49" itemprop="dateModified" datetime="2025-11-16T19:58:49+08:00">2025-11-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E5%B7%A7/" itemprop="url" rel="index"><span itemprop="name">技巧</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="为什么你不去看文档"><a href="#为什么你不去看文档" class="headerlink" title="为什么你不去看文档"></a>为什么你不去看文档</h1><h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>在推特上看到这张图片，我觉得很好，但是评论里面都在说：这是国内特有的现状。</p>
<p>好像国外就不会这样一样，实际我的看法是国外也是这个鸟样子</p>
<p><img src="/images/951413iMgBlog/two_queue-0761423.png" alt="two_queue"></p>
<h2 id="我的看法"><a href="#我的看法" class="headerlink" title="我的看法"></a>我的看法</h2><p>这可不只是国内的问题，medium&#x2F;reddit 上最受欢迎的都是10个坑、5个技巧、3个必知这类文章。其实原因我反倒是很理解，官方文档通篇读下来感觉都看了但是有点不得要领，典型就是看完还是解决不了问题。XX系列简明直接要害，多搞清楚几个XX系列后再看官方手册那感觉完全不一样</p>
<h2 id="为什么会这样"><a href="#为什么会这样" class="headerlink" title="为什么会这样"></a>为什么会这样</h2><p>大多人没有能力只看知识就会掌握并解决问题，这就是为什么我们学数理化，知道了那些公式还是不会解题(有极少数人会)，而是需要老师手把手多讲解几道习题，把习题里面如何套用公式给大家示范并解决问题。</p>
<p>我们学程序相关知识也是这样，只看官方手册大多数人也解决不了问题，但是如果看10个坑、8个技巧后基本会解决一些问题了，如果这个时候我们再去看手册就会发现看起来有感觉多了。</p>
<p>读书的时候有老师带我们解题，做程序员后就只能靠自己了，实际这些XX系列就是我们最好的老师，但最终要记住靠XX系列入门后还是要回到文档、手册、帮助上来。</p>
<p>究其原因总结下来可以把学习分成<strong>工程效率、知识效率</strong></p>
<p>但是我们最容易犯的错误就是：没有知识效率能力确犯了知识效率的毛病。看到知识一看就懂，但实际一用就懵这才是我们的常态</p>
<p><img src="/images/951413iMgBlog/image-20230406203738548.png" alt="image-20230406203738548"></p>
<h2 id="什么是工程效率，什么是知识效率"><a href="#什么是工程效率，什么是知识效率" class="headerlink" title="什么是工程效率，什么是知识效率"></a>什么是工程效率，什么是知识效率</h2><p>有些人纯看理论就能掌握好一门技能，不实践还能在脑海里举一反三，这是知识效率，这种人非常少；</p>
<p>大多数普通人都是看点知识然后结合实践来强化理论，要经过反反复复才能比较好地掌握一个知识，这就是工程效率，讲究技巧、工具来达到目的。</p>
<p>肯定知识效率最牛逼，但是拥有这种技能的人毕竟非常少（天生的高智商吧）。从小我们周边那种不怎么学的学霸型基本都是这类，这种学霸都还能触类旁通非常快的掌握一个新知识，非常气人。剩下的绝大部分只能拼时间+方法+总结等也能掌握一些知识</p>
<p>我自己就是工程效率型，只能羡慕那些知识效率型的学霸。所以我花了长时间去总结他们的差异，在程序员这个领域学会了用案例去学习，也就是深度学习深挖一个案例，通过案例来学习背后的知识，这种方式极大的好处就是学得牢固，并且通过案例掌握的知识点就像一根长长的钉子一样，深深地插入你的记忆里。再然后去看XX官方手册就会发现轻松多了。同时经过多个案例锤炼后举一反三也是积极自然。</p>
<p>使劲挖掘自己在知识效率型方面的能力吧，两者之间当然没有明显的界限，知识积累多了逻辑训练好了在别人看来你的智商就高了</p>
<h2 id="其他想说的"><a href="#其他想说的" class="headerlink" title="其他想说的"></a>其他想说的</h2><p>看完故事升华一下方法论：<a href="https://plantegg.github.io/2018/05/23/%E5%A6%82%E4%BD%95%E5%9C%A8%E5%B7%A5%E4%BD%9C%E4%B8%AD%E5%AD%A6%E4%B9%A0/">如何在工作中学习</a></p>
<h2 id="如果你觉得看完对你很有帮助可以通过如下方式找到我"><a href="#如果你觉得看完对你很有帮助可以通过如下方式找到我" class="headerlink" title="如果你觉得看完对你很有帮助可以通过如下方式找到我"></a>如果你觉得看完对你很有帮助可以通过如下方式找到我</h2><p>find me on twitter: <a target="_blank" rel="noopener" href="https://twitter.com/plantegg">@plantegg</a></p>
<p>知识星球：<a target="_blank" rel="noopener" href="https://t.zsxq.com/0cSFEUh2J">https://t.zsxq.com/0cSFEUh2J</a></p>
<p>开了一个星球，在里面讲解一些案例、知识、学习方法，肯定没法让大家称为顶尖程序员(我自己都不是)，只是希望用我的方法、知识、经验、案例作为你的垫脚石，帮助你快速、早日成为一个基本合格的程序员。</p>
<p>争取在星球内：</p>
<ul>
<li>养成基本动手能力</li>
<li>拥有起码的分析推理能力–按我接触的程序员，大多都是没有逻辑的</li>
<li>知识上教会你几个关键的知识点</li>
</ul>
<img src="/images/951413iMgBlog/image-20230407232314969.png" alt="image-20230407232314969" style="zoom:50%;" />


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2023/04/02/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%A0%E6%9C%89%E7%9F%A5%E8%AF%86%E4%BD%86%E6%B2%A1%E6%9C%89%E8%83%BD%E5%8A%9B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="twitter @plantegg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
      <meta itemprop="description" content="java mysql tcp performance network docker Linux">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | plantegg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2023/04/02/%E4%B8%BA%E4%BB%80%E4%B9%88%E4%BD%A0%E6%9C%89%E7%9F%A5%E8%AF%86%E4%BD%86%E6%B2%A1%E6%9C%89%E8%83%BD%E5%8A%9B/" class="post-title-link" itemprop="url">为什么你有知识但没有能力</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-04-02 20:30:03" itemprop="dateCreated datePublished" datetime="2023-04-02T20:30:03+08:00">2023-04-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-11-16 19:58:49" itemprop="dateModified" datetime="2025-11-16T19:58:49+08:00">2025-11-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%8A%80%E5%B7%A7/" itemprop="url" rel="index"><span itemprop="name">技巧</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="为什么你有知识但没有能力"><a href="#为什么你有知识但没有能力" class="headerlink" title="为什么你有知识但没有能力"></a>为什么你有知识但没有能力</h1><h2 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h2><p>有同学想抓一下访问 baidu.com 的流量，然后分析学习，抓完包后想过滤只看 baidu.com 的流量，减少干扰，于是他在 Wireshark 里面用上了过滤条件： http.host eq “baidu.com” 但是没有过滤到任何包，所以他带着这个问题来问我了</p>
<p>如下图是他的过滤结果：</p>
<p><img src="/images/951413iMgBlog/http.host.png" alt="img"></p>
<p>多说一句，要是我我就只留一个条件来提问：http.host eq “baidu.com” </p>
<p>看到这个问题，虽然我从来没有用过 http.host 这种过滤方式，但我大概猜到了原因，所以我先找了一个政府网站(他们是为数不多还在用 http 的网站)，然后我轻松用同样的方式正确过滤到了我要的包：</p>
<p><img src="/images/951413iMgBlog/image-20230402200619645.png" alt="image-20230402200619645"></p>
<p>于是我回复他：</p>
<blockquote>
<p>第一，你不应该搞一堆条件，不好调试；最简单用一个条件过滤验证 </p>
<p>第二，为什么你百度过滤不了，我想留给你自己去看书、想一想，如果不行一周后我再告诉你答案。自己琢磨出来会让你的正向激励跟吸du一样更嗨，唾手可得的答案不符合本星球希望帮助成员达到无招胜有招的目的，知识是学不完的，总有你不会，但是分析能力、解决问题的能力才是我们要可以去训练，最终你要达到把你丢到一个不懂的领域你很快可以解决问题</p>
</blockquote>
<p>其实我是想引导他自己分析解决问题。</p>
<p>我认为这个同学能动手去抓包分析，学习的劲头已经有了，居然会 http.host 这种用法，这是我第一次看到这么用(我平时不和 http 打交道，别鄙视我)，我想他肯定知道https</p>
<p>但是为什么他知道这些知识但是在实践中什么阻碍了他把学到的知识和他碰到这个头疼的问题联系不起来呢？</p>
<h2 id="有知识但没有能力"><a href="#有知识但没有能力" class="headerlink" title="有知识但没有能力"></a>有知识但没有能力</h2><p>我以前在《<a href="https://plantegg.github.io/2018/05/23/%E5%A6%82%E4%BD%95%E5%9C%A8%E5%B7%A5%E4%BD%9C%E4%B8%AD%E5%AD%A6%E4%B9%A0/">如何在工作中学习</a>》就讨论过这种情况，如图</p>
<p><img src="/images/951413iMgBlog/image-20230402201307165.png" alt="image-20230402201307165"></p>
<p>显然，这次这位同学的只是具备了，但是没有转化成能力，也就虽然我们都学了TCP、HTTP、HTTPS这些信息，但是没有理解透彻，更具体一点没有把 HTTPS，这层 TLS 工作结构就没理解清楚，TLS 把你原来的 http host 都给加密了，你自然没法按原来的方式过滤。</p>
<p>如下图，这是加密后的结构，你是没法知道TCP 里面是http&#x2F;redis还是MySQL协议的，如果你要理解了TLS直接作用在TCP（四层），而http这种七层协议哪还有说话的空间啊？</p>
<p><img src="/images/951413iMgBlog/image-20230402201725641.png" alt="image-20230402201725641"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>不要总是抱怨学不会、学不懂，你就是思考的稍微少一点、浅一点。</p>
<p>不要总是抱怨自己10年工作经验实践下来还不如一年的新手，同上！</p>
<p>思维方式是最难改变的，但是是最重要的。</p>
<h2 id="如果你觉得看完对你很有帮助可以通过如下方式找到我"><a href="#如果你觉得看完对你很有帮助可以通过如下方式找到我" class="headerlink" title="如果你觉得看完对你很有帮助可以通过如下方式找到我"></a>如果你觉得看完对你很有帮助可以通过如下方式找到我</h2><p>find me on twitter: <a target="_blank" rel="noopener" href="https://twitter.com/plantegg">@plantegg</a></p>
<p>知识星球：<a target="_blank" rel="noopener" href="https://t.zsxq.com/0cSFEUh2J">https://t.zsxq.com/0cSFEUh2J</a></p>
<p>开了一个星球，在里面讲解一些案例、知识、学习方法，肯定没法让大家称为顶尖程序员(我自己都不是)，只是希望用我的方法、知识、经验、案例作为你的垫脚石，帮助你快速、早日成为一个基本合格的程序员。</p>
<p>争取在星球内：</p>
<ul>
<li>养成基本动手能力</li>
<li>拥有起码的分析推理能力–按我接触的程序员，大多都是没有逻辑的</li>
<li>知识上教会你几个关键的知识点</li>
</ul>
<img src="/images/951413iMgBlog/image-20230407232314969.png" alt="image-20230407232314969" style="zoom:50%;" />


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="上一页" aria-label="上一页" href="/page/3/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/5/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2026</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">twitter @plantegg</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
