<!DOCTYPE html>
<html lang="zh-Hans">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="robots" content="noodp" /><title>疑难问题汇总 - plantegg</title><meta name="Description" content=""><meta property="og:url" content="https://plantegg.github.io/posts/%E7%96%91%E9%9A%BE%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/">
  <meta property="og:site_name" content="plantegg">
  <meta property="og:title" content="疑难问题汇总">
  <meta property="og:description" content="疑难问题汇总 一网通客户 vxlan 网络始终不通，宿主机能抓到发出去的包，但是抓不到回复包。对端容器所在的宿主机抓不到进来的包 一定是网络上把这个包扔掉了
证明问题 先选择两台宿主机，停掉上面的 ovs 容器(腾出4789端口) 一台宿主机上执行： nc -l -u 4789 //在4789端口上启动udp服务 另外一台主机上执行： nc -u 第一台宿主机的IP 4789 //从第二台宿主机连第一台的4789端口 nc -u -z -v ip 4789 从两边都发送一些内容看看，看是否能到达对方 如果通过nc发送的东西也无法到达对方（跟方舟没有关系了）那么就是链路上的问题">
  <meta property="og:locale" content="zh_Hans">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2018-10-24T17:30:03+00:00">
    <meta property="article:modified_time" content="2018-10-24T17:30:03+00:00">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="TCP">
    <meta property="article:tag" content="Network">
    <meta property="article:tag" content="Performance">
    <meta property="article:tag" content="Docker">
    <meta property="article:tag" content="Debug">

  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="疑难问题汇总">
  <meta name="twitter:description" content="疑难问题汇总 一网通客户 vxlan 网络始终不通，宿主机能抓到发出去的包，但是抓不到回复包。对端容器所在的宿主机抓不到进来的包 一定是网络上把这个包扔掉了
证明问题 先选择两台宿主机，停掉上面的 ovs 容器(腾出4789端口) 一台宿主机上执行： nc -l -u 4789 //在4789端口上启动udp服务 另外一台主机上执行： nc -u 第一台宿主机的IP 4789 //从第二台宿主机连第一台的4789端口 nc -u -z -v ip 4789 从两边都发送一些内容看看，看是否能到达对方 如果通过nc发送的东西也无法到达对方（跟方舟没有关系了）那么就是链路上的问题">
      <meta name="twitter:site" content="@plantegg">
<meta name="application-name" content="plantegg">
<meta name="apple-mobile-web-app-title" content="plantegg">

<meta name="theme-color" content="#f8f8f8"><meta name="twitter:creator" content="@plantegg" /><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">

<link rel="canonical" href="https://plantegg.github.io/posts/%E7%96%91%E9%9A%BE%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/" /><link rel="prev" href="https://plantegg.github.io/posts/high_load/" /><link rel="next" href="https://plantegg.github.io/posts/%E4%B8%80%E4%B8%AA%E6%B2%A1%E6%9C%89%E9%81%B5%E5%AE%88tcp%E8%A7%84%E5%88%99%E5%AF%BC%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98/" />
<link rel="stylesheet" href="/css/main.min.css"><link rel="stylesheet" href="/css/style.min.css"><script type="application/ld+json">{"@context": "https://schema.org","@type": "BlogPosting",
        "headline": "疑难问题汇总",
        "inLanguage": "zh-Hans",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "https://plantegg.github.io/posts/%E7%96%91%E9%9A%BE%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/"
        },"genre": "posts","keywords":["Linux","TCP","network","performance","docker","debug"],"wordcount":  5300 ,
        "url": "https://plantegg.github.io/posts/%E7%96%91%E9%9A%BE%E9%97%AE%E9%A2%98%E6%B1%87%E6%80%BB/","datePublished": "2018-10-24T17:30:03+00:00","dateModified": "2018-10-24T17:30:03+00:00","publisher": {
            "@type": "Organization",
            "name": "作者"},"author": {
                "@type": "Person",
                "name": "作者",
                "url": "/"
            },"description": ""
    }</script></head>


<body data-instant-intensity="viewport" ><script type="text/javascript">
        function setTheme(theme) {
          document.body.setAttribute('theme', theme); 
          document.documentElement.className = theme;
          document.documentElement.style.setProperty('color-scheme', theme === 'light' ? 'light' : 'dark');
          if (theme === 'light') {
            document.documentElement.classList.remove('tw-dark')
          } else {
            document.documentElement.classList.add('tw-dark')
          }
          window.theme = theme;   
          window.isDark = window.theme !== 'light' 
        }
        function saveTheme(theme) {window.localStorage && localStorage.setItem('theme', theme);}
        function getMeta(metaName) {const metas = document.getElementsByTagName('meta'); for (let i = 0; i < metas.length; i++) if (metas[i].getAttribute('name') === metaName) return metas[i]; return '';}
        if (window.localStorage && localStorage.getItem('theme')) {
            let theme = localStorage.getItem('theme');
            if (theme === 'light' || theme === 'dark') {
            setTheme(theme);
            } else {
                if ((window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                    setTheme('dark');
                } else {
                    setTheme('light');
                }
            }
         } else { 
            if ('' === 'light' || '' === 'dark') 
                setTheme(''), saveTheme(''); 
            else saveTheme('auto'), window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches ? setTheme('dark') : setTheme('light');
        }
        let metaColors = {'light': '#f8f8f8','dark': '#161b22'}
        getMeta('theme-color').content = metaColors[document.body.getAttribute('theme')];
        window.switchThemeEventSet = new Set()
    </script>
    <div id="back-to-top"></div>
    <div id="mask"></div><div class="wrapper"><header class="desktop print:!tw-hidden" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/" title="plantegg">plantegg</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item"
                    href="/posts/" > 文章 </a><a class="menu-item"
                    href="/categories/" > 分类 </a><a class="menu-item"
                    href="/tags/" > 标签 </a><span class="menu-item delimiter"></span><button class="menu-item theme-switch" aria-label="切换主题">
                    <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705 0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></svg>
                </button></div>
        </div>
    </div>
</header><header class="mobile print:!tw-hidden" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/" title="plantegg">plantegg</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/posts/" title="" >文章</a><a class="menu-item" href="/categories/" title="" >分类</a><a class="menu-item" href="/tags/" title="" >标签</a><button class="menu-item theme-switch tw-w-full" aria-label="切换主题">
                <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705 0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></svg>
            </button></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div><main class="main">
            <div class="container"><div class="toc print:!tw-hidden" id="toc-auto">
        <h2 class="toc-title">目录</h2>
        <div class="toc-content always-active" id="toc-content-auto"><nav id="TableOfContents">
  <ul>
    <li><a href="#一网通客户-vxlan-网络始终不通宿主机能抓到发出去的包但是抓不到回复包对端容器所在的宿主机抓不到进来的包">一网通客户 vxlan 网络始终不通，宿主机能抓到发出去的包，但是抓不到回复包。对端容器所在的宿主机抓不到进来的包</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#一网通客户-vxlan-网络能通但是pca容器初始化的时候失败">一网通客户 vxlan 网络能通，但是pca容器初始化的时候失败</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#新零售客户通过vpn部署好中间件后修改笔记本的dns设置后通过浏览器来访问中间件的console但是报找不到server同时在cmd中ping-这个域名能通但是nslookup解析不了这个域名">新零售客户通过vpn部署好中间件后，修改笔记本的dns设置后通过浏览器来访问中间件的console，但是报找不到server。同时在cmd中ping 这个域名能通，但是nslookup解析不了这个域名</a></li>
    <li><a href="#某航空客户-windows下通过方舟dns域名解析不了方舟域名但是宿主机上可以windows机器能ping通dns-server-ip-但是nslookup-解析不了域名显示request-time-out">某航空客户 windows下通过方舟dns域名解析不了方舟域名，但是宿主机上可以。windows机器能ping通dns server ip, 但是nslookup 解析不了域名，显示request time out</a></li>
    <li><a href="#方舟环境在ecs底座上dns会继承rotate模式导致域名解析不正常ping-域名不通但是nslookup能通">方舟环境在ECS底座上DNS会继承rotate模式，导致域名解析不正常，ping 域名不通，但是nslookup能通</a></li>
    <li><a href="#某银行-poc-环境物理机搬迁到新机房后网络不通通过在物理机上抓包抓不到任何容器的包">某银行 POC 环境物理机搬迁到新机房后网络不通，通过在物理机上抓包，抓不到任何容器的包</a></li>
    <li><a href="#一台应用服务器无法访问部分drds-serverhttpsaonealibaba-inccomtask9753887"><a href="https://aone.alibaba-inc.com/task/9753887">一台应用服务器无法访问部分drds-server</a></a>
      <ul>
        <li><a href="#当时交换机上发现的两条记录">当时交换机上发现的两条记录：</a></li>
      </ul>
    </li>
    <li><a href="#某个客户默认修改了umask导致黑屏脚本权限不够部署中途不断卡壳直接在黑屏脚本中修复了admin这个用户的umask">某个客户默认修改了umask导致黑屏脚本权限不够，部署中途不断卡壳，直接在黑屏脚本中修复了admin这个用户的umask</a></li>
    <li><a href="#修复centos下udp和批量处理脚本因为环境变量的确实不能执行modprobe和ping等等命令的问题同时将alios的这块修复逻辑放到了方舟安装脚本中init的时候会先把这个问题修复">修复centos下udp和批量处理脚本因为环境变量的确实不能执行modprobe和ping等等命令的问题，同时将alios的这块修复逻辑放到了方舟安装脚本中，init的时候会先把这个问题修复</a></li>
    <li><a href="#centos系统重启后-etcresolvconf总是被还原开始以为是系统bug研究后发现是可以配置的dhcp默认会每次重启后拉取dns自动更新-etcresolvconf">Centos系统重启后 /etc/resolv.conf总是被还原，开始以为是系统Bug，研究后发现是可以配置的，dhcp默认会每次重启后拉取DNS自动更新 /etc/resolv.conf</a></li>
    <li><a href="#monkeyking-burn-cpu--mkt-burncpush-脚本在方舟服务器上运行一段时间后进程不见了mk团队认为是方舟杀掉了他们">MonkeyKing burn cpu:  mkt-burncpu.sh 脚本在方舟服务器上运行一段时间后，进程不见了，MK团队认为是方舟杀掉了他们。</a></li>
    <li><a href="#某汽车客户-部署过程中愚公不能正常启动怀疑是依赖的zk问题zk网络访问正常">某汽车客户 部署过程中愚公不能正常启动，怀疑是依赖的zk问题，zk网络访问正常</a></li>
    <li><a href="#开发反应两个容器之间的网络不稳定偶尔报连不上某些容器httpsaonealibaba-inccomissue10403085"><a href="https://aone.alibaba-inc.com/issue/10403085">开发反应两个容器之间的网络不稳定，偶尔报连不上某些容器</a></a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#某化工私有云drds扩容总是报资源不足主要是因为有些drds-server容器指定了--cpu-shares128相当于4core--1024物理核数-等于每个核对应的cpu-shares--导致物理机cpu不够现场将所有容器的--cpu-shares改成2后修复这个问题但是最终需要产品方">某化工私有云DRDS扩容总是报资源不足，主要是因为有些drds-server容器指定了&ndash;cpu-shares=128(相当于4Core&ndash;1024/物理核数 等于每个核对应的cpu-shares ), 导致物理机CPU不够。现场将所有容器的&ndash;cpu-shares改成2后修复这个问题，但是最终需要产品方</a></li>
    <li><a href="#mq-diamond的异常日志总是打爆磁盘mq-diamond-容器一天输出500g日志的问题本质是调用的依赖不可用了导致mq-diamond-频繁输出日志两天就用掉了1t磁盘">mq-diamond的异常日志总是打爆磁盘。mq-diamond 容器一天输出500G日志的问题，本质是调用的依赖不可用了，导致mq-diamond 频繁输出日志，两天就用掉了1T磁盘.</a></li>
    <li><a href="#内核migration进程bug导致宿主机load非常高同时cpu-idle也很高两者矛盾">内核migration进程bug导致宿主机Load非常高，同时CPU idle也很高（两者矛盾）</a></li>
    <li><a href="#某银行客户raid阵列坏掉导致物理机重启后容器的net-alias域名解析不到">某银行客户RAID阵列坏掉，导致物理机重启后容器的net-alias域名解析不到</a></li>
    <li><a href="#某快递客户php短连接httpsaonealibaba-inccomtask10409778访问drds会导致极低概率出现连接被reset货运快递客户事务没生效导致数据库写入的金额对不上账"><a href="https://aone.alibaba-inc.com/task/10409778">某快递客户PHP短连接</a>访问DRDS会导致极低概率出现连接被reset、货运快递客户事务没生效导致数据库写入的金额对不上账</a></li>
    <li><a href="#参考文章">参考文章</a></li>
  </ul>
</nav></div>
    </div><script>document.getElementsByTagName("main")[0].setAttribute("autoTOC", "true")</script><article class="page single print:!tw-w-full print:!tw-max-w-none print:!tw-m-0 print:!tw-p-0"><h1 class="single-title" data-pagefind-meta="date:2018-10-24" data-pagefind-body>疑难问题汇总</h1><div class="post-meta">
            <div class="post-meta-line">
                <span class="post-author"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6 0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7 0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4 0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9 14.3 0 28-2.7 40.9-6.9 2.3-.7 4.7-1.1 7.1-1.1 42.9 0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><a href="/" title="Author" rel=" author" class="author">作者</a>
                </span>&nbsp;<span class="post-category">收录于 </span>&nbsp;<span class="post-category">类别 <a href="/categories/linux/"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M464 128H272l-54.63-54.63c-6-6-14.14-9.37-22.63-9.37H48C21.49 64 0 85.49 0 112v288c0 26.51 21.49 48 48 48h416c26.51 0 48-21.49 48-48V176c0-26.51-21.49-48-48-48zm0 272H48V112h140.12l54.63 54.63c6 6 14.14 9.37 22.63 9.37H464v224z"/></svg>Linux</a></span></div>
            <div class="post-meta-line"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M148 288h-40c-6.6 0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6 0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6 0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6 0 12 5.4 12 12v52h48c26.5 0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3 0 6-2.7 6-6z"/></svg>&nbsp;<time datetime="2018-10-24">2018-10-24</time>&nbsp;<svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1 0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7 0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174L402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7l-43.2-43.2c-4.1-4.1-10.8-4.1-14.8 0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg>&nbsp;<time datetime="2018-10-24">2018-10-24</time>&nbsp;<svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3 0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9 0l60.1 60.1c18.8 18.7 18.8 49.1 0 67.9zM284.2 99.8L21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3 0-17l-111-111c-4.8-4.7-12.4-4.7-17.1 0zM124.1 339.9c-5.5-5.5-5.5-14.3 0-19.8l154-154c5.5-5.5 14.3-5.5 19.8 0s5.5 14.3 0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8 0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;约 5300 字&nbsp;
                    <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5 0-200-89.5-200-200S145.5 56 256 56s200 89.5 200 200-89.5 200-200 200zm61.8-104.4l-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6 0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;预计阅读 24 分钟&nbsp;<i class="fas fa-eye fa-fw"></i>
                    <span id="busuanzi_container_page_pv">本文阅读量 <span id="busuanzi_value_page_pv"></span> 次</span></div>
        </div><div class="details toc print:!tw-block" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>目录</span>
                    <span class="details-icon"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#一网通客户-vxlan-网络始终不通宿主机能抓到发出去的包但是抓不到回复包对端容器所在的宿主机抓不到进来的包">一网通客户 vxlan 网络始终不通，宿主机能抓到发出去的包，但是抓不到回复包。对端容器所在的宿主机抓不到进来的包</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#一网通客户-vxlan-网络能通但是pca容器初始化的时候失败">一网通客户 vxlan 网络能通，但是pca容器初始化的时候失败</a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#新零售客户通过vpn部署好中间件后修改笔记本的dns设置后通过浏览器来访问中间件的console但是报找不到server同时在cmd中ping-这个域名能通但是nslookup解析不了这个域名">新零售客户通过vpn部署好中间件后，修改笔记本的dns设置后通过浏览器来访问中间件的console，但是报找不到server。同时在cmd中ping 这个域名能通，但是nslookup解析不了这个域名</a></li>
    <li><a href="#某航空客户-windows下通过方舟dns域名解析不了方舟域名但是宿主机上可以windows机器能ping通dns-server-ip-但是nslookup-解析不了域名显示request-time-out">某航空客户 windows下通过方舟dns域名解析不了方舟域名，但是宿主机上可以。windows机器能ping通dns server ip, 但是nslookup 解析不了域名，显示request time out</a></li>
    <li><a href="#方舟环境在ecs底座上dns会继承rotate模式导致域名解析不正常ping-域名不通但是nslookup能通">方舟环境在ECS底座上DNS会继承rotate模式，导致域名解析不正常，ping 域名不通，但是nslookup能通</a></li>
    <li><a href="#某银行-poc-环境物理机搬迁到新机房后网络不通通过在物理机上抓包抓不到任何容器的包">某银行 POC 环境物理机搬迁到新机房后网络不通，通过在物理机上抓包，抓不到任何容器的包</a></li>
    <li><a href="#一台应用服务器无法访问部分drds-serverhttpsaonealibaba-inccomtask9753887"><a href="https://aone.alibaba-inc.com/task/9753887">一台应用服务器无法访问部分drds-server</a></a>
      <ul>
        <li><a href="#当时交换机上发现的两条记录">当时交换机上发现的两条记录：</a></li>
      </ul>
    </li>
    <li><a href="#某个客户默认修改了umask导致黑屏脚本权限不够部署中途不断卡壳直接在黑屏脚本中修复了admin这个用户的umask">某个客户默认修改了umask导致黑屏脚本权限不够，部署中途不断卡壳，直接在黑屏脚本中修复了admin这个用户的umask</a></li>
    <li><a href="#修复centos下udp和批量处理脚本因为环境变量的确实不能执行modprobe和ping等等命令的问题同时将alios的这块修复逻辑放到了方舟安装脚本中init的时候会先把这个问题修复">修复centos下udp和批量处理脚本因为环境变量的确实不能执行modprobe和ping等等命令的问题，同时将alios的这块修复逻辑放到了方舟安装脚本中，init的时候会先把这个问题修复</a></li>
    <li><a href="#centos系统重启后-etcresolvconf总是被还原开始以为是系统bug研究后发现是可以配置的dhcp默认会每次重启后拉取dns自动更新-etcresolvconf">Centos系统重启后 /etc/resolv.conf总是被还原，开始以为是系统Bug，研究后发现是可以配置的，dhcp默认会每次重启后拉取DNS自动更新 /etc/resolv.conf</a></li>
    <li><a href="#monkeyking-burn-cpu--mkt-burncpush-脚本在方舟服务器上运行一段时间后进程不见了mk团队认为是方舟杀掉了他们">MonkeyKing burn cpu:  mkt-burncpu.sh 脚本在方舟服务器上运行一段时间后，进程不见了，MK团队认为是方舟杀掉了他们。</a></li>
    <li><a href="#某汽车客户-部署过程中愚公不能正常启动怀疑是依赖的zk问题zk网络访问正常">某汽车客户 部署过程中愚公不能正常启动，怀疑是依赖的zk问题，zk网络访问正常</a></li>
    <li><a href="#开发反应两个容器之间的网络不稳定偶尔报连不上某些容器httpsaonealibaba-inccomissue10403085"><a href="https://aone.alibaba-inc.com/issue/10403085">开发反应两个容器之间的网络不稳定，偶尔报连不上某些容器</a></a>
      <ul>
        <li></li>
      </ul>
    </li>
    <li><a href="#某化工私有云drds扩容总是报资源不足主要是因为有些drds-server容器指定了--cpu-shares128相当于4core--1024物理核数-等于每个核对应的cpu-shares--导致物理机cpu不够现场将所有容器的--cpu-shares改成2后修复这个问题但是最终需要产品方">某化工私有云DRDS扩容总是报资源不足，主要是因为有些drds-server容器指定了&ndash;cpu-shares=128(相当于4Core&ndash;1024/物理核数 等于每个核对应的cpu-shares ), 导致物理机CPU不够。现场将所有容器的&ndash;cpu-shares改成2后修复这个问题，但是最终需要产品方</a></li>
    <li><a href="#mq-diamond的异常日志总是打爆磁盘mq-diamond-容器一天输出500g日志的问题本质是调用的依赖不可用了导致mq-diamond-频繁输出日志两天就用掉了1t磁盘">mq-diamond的异常日志总是打爆磁盘。mq-diamond 容器一天输出500G日志的问题，本质是调用的依赖不可用了，导致mq-diamond 频繁输出日志，两天就用掉了1T磁盘.</a></li>
    <li><a href="#内核migration进程bug导致宿主机load非常高同时cpu-idle也很高两者矛盾">内核migration进程bug导致宿主机Load非常高，同时CPU idle也很高（两者矛盾）</a></li>
    <li><a href="#某银行客户raid阵列坏掉导致物理机重启后容器的net-alias域名解析不到">某银行客户RAID阵列坏掉，导致物理机重启后容器的net-alias域名解析不到</a></li>
    <li><a href="#某快递客户php短连接httpsaonealibaba-inccomtask10409778访问drds会导致极低概率出现连接被reset货运快递客户事务没生效导致数据库写入的金额对不上账"><a href="https://aone.alibaba-inc.com/task/10409778">某快递客户PHP短连接</a>访问DRDS会导致极低概率出现连接被reset、货运快递客户事务没生效导致数据库写入的金额对不上账</a></li>
    <li><a href="#参考文章">参考文章</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content" data-pagefind-body><h1 id="疑难问题汇总" class="headerLink">
    <a href="#%e7%96%91%e9%9a%be%e9%97%ae%e9%a2%98%e6%b1%87%e6%80%bb" class="header-mark"></a>疑难问题汇总</h1><h2 id="一网通客户-vxlan-网络始终不通宿主机能抓到发出去的包但是抓不到回复包对端容器所在的宿主机抓不到进来的包" class="headerLink">
    <a href="#%e4%b8%80%e7%bd%91%e9%80%9a%e5%ae%a2%e6%88%b7-vxlan-%e7%bd%91%e7%bb%9c%e5%a7%8b%e7%bb%88%e4%b8%8d%e9%80%9a%e5%ae%bf%e4%b8%bb%e6%9c%ba%e8%83%bd%e6%8a%93%e5%88%b0%e5%8f%91%e5%87%ba%e5%8e%bb%e7%9a%84%e5%8c%85%e4%bd%86%e6%98%af%e6%8a%93%e4%b8%8d%e5%88%b0%e5%9b%9e%e5%a4%8d%e5%8c%85%e5%af%b9%e7%ab%af%e5%ae%b9%e5%99%a8%e6%89%80%e5%9c%a8%e7%9a%84%e5%ae%bf%e4%b8%bb%e6%9c%ba%e6%8a%93%e4%b8%8d%e5%88%b0%e8%bf%9b%e6%9d%a5%e7%9a%84%e5%8c%85" class="header-mark"></a>一网通客户 vxlan 网络始终不通，宿主机能抓到发出去的包，但是抓不到回复包。对端容器所在的宿主机抓不到进来的包</h2><blockquote>
  <p>一定是网络上把这个包扔掉了</p>

</blockquote><h4 id="证明问题" class="headerLink">
    <a href="#%e8%af%81%e6%98%8e%e9%97%ae%e9%a2%98" class="header-mark"></a>证明问题</h4><ul>
<li>先选择两台宿主机，停掉上面的 ovs 容器(腾出4789端口)</li>
<li>一台宿主机上执行： nc -l -u 4789 //在4789端口上启动udp服务</li>
<li>另外一台主机上执行： nc -u 第一台宿主机的IP 4789 //从第二台宿主机连第一台的4789端口 nc -u -z -v ip 4789</li>
<li>从两边都发送一些内容看看，看是否能到达对方</li>
</ul>
<p><strong>如果通过nc发送的东西也无法到达对方（跟方舟没有关系了）那么就是链路上的问题</strong></p>
<hr>
<h2 id="一网通客户-vxlan-网络能通但是pca容器初始化的时候失败" class="headerLink">
    <a href="#%e4%b8%80%e7%bd%91%e9%80%9a%e5%ae%a2%e6%88%b7-vxlan-%e7%bd%91%e7%bb%9c%e8%83%bd%e9%80%9a%e4%bd%86%e6%98%afpca%e5%ae%b9%e5%99%a8%e5%88%9d%e5%a7%8b%e5%8c%96%e7%9a%84%e6%97%b6%e5%80%99%e5%a4%b1%e8%b4%a5" class="header-mark"></a>一网通客户 vxlan 网络能通，但是pca容器初始化的时候失败</h2><p>通过报错信息发现pca容器访问数据库SocketTimeout，同时看到异常信息都是Timeout大于15分钟以上了。</p>
<h4 id="需找问题" class="headerLink">
    <a href="#%e9%9c%80%e6%89%be%e9%97%ae%e9%a2%98" class="header-mark"></a>需找问题</h4><ul>
<li>先在 pca容器和数据库容器互相 ping 证明网络没有问题，能够互通</li>
<li>在 pca 容器中通过mysql 命令行连上 mysql，并创建table，insert一些记录，结果也没有问题</li>
<li>抓包发现pca容器访问数据库的时候在重传包（以往经验）</li>
</ul>
<p><img class="tw-inline" loading="lazy" src=http://img4.tbcdn.cn/L1/461/1/1d010b9937198aee9e798bb02913603874f19ddc   alt="screenshot"  ></p>
<h4 id="细化证明问题" class="headerLink">
    <a href="#%e7%bb%86%e5%8c%96%e8%af%81%e6%98%8e%e9%97%ae%e9%a2%98" class="header-mark"></a>细化证明问题</h4><ul>
<li>ping -s -M 尝试发送1460大小的包</li>
<li>检查宿主机、容器MTU设置</li>
</ul>
<p><strong>确认问题在宿主机网卡MTU设置为1350</strong>，从而导致容器发出的包被宿主机网卡丢掉</p>
<h2 id="新零售客户通过vpn部署好中间件后修改笔记本的dns设置后通过浏览器来访问中间件的console但是报找不到server同时在cmd中ping-这个域名能通但是nslookup解析不了这个域名" class="headerLink">
    <a href="#%e6%96%b0%e9%9b%b6%e5%94%ae%e5%ae%a2%e6%88%b7%e9%80%9a%e8%bf%87vpn%e9%83%a8%e7%bd%b2%e5%a5%bd%e4%b8%ad%e9%97%b4%e4%bb%b6%e5%90%8e%e4%bf%ae%e6%94%b9%e7%ac%94%e8%ae%b0%e6%9c%ac%e7%9a%84dns%e8%ae%be%e7%bd%ae%e5%90%8e%e9%80%9a%e8%bf%87%e6%b5%8f%e8%a7%88%e5%99%a8%e6%9d%a5%e8%ae%bf%e9%97%ae%e4%b8%ad%e9%97%b4%e4%bb%b6%e7%9a%84console%e4%bd%86%e6%98%af%e6%8a%a5%e6%89%be%e4%b8%8d%e5%88%b0server%e5%90%8c%e6%97%b6%e5%9c%a8cmd%e4%b8%adping-%e8%bf%99%e4%b8%aa%e5%9f%9f%e5%90%8d%e8%83%bd%e9%80%9a%e4%bd%86%e6%98%afnslookup%e8%a7%a3%e6%9e%90%e4%b8%8d%e4%ba%86%e8%bf%99%e4%b8%aa%e5%9f%9f%e5%90%8d" class="header-mark"></a>新零售客户通过vpn部署好中间件后，修改笔记本的dns设置后通过浏览器来访问中间件的console，但是报找不到server。同时在cmd中ping 这个域名能通，但是nslookup解析不了这个域名</h2><p>ping 这个域名能通，但是nslookup不行，基本可以确认网络没有大问题，之所以ping可以nslookup不行，是因为他们底层取dns server的逻辑不一样。</p>
<p>先检查dns设置：</p>
<p><img class="tw-inline" loading="lazy" src=/Users/ren/case/ossimg/d4634f74c0b0b38f784a1657864d5089.png   alt="image.png"  >
如上图，配置的填写</p>
<p><img class="tw-inline" loading="lazy" src=/Users/ren/case/ossimg/d4a9cddf56d23059f98850c7c0bcf067.png   alt="image.png"  ></p>
<p>多出来一个127.0.0.1肯定有问题，明明配置的时候只填了114.114.114.114. nslookup、浏览器默认把域名解析丢给了127.0.0.1，但是 ping丢给了114.114.114.114，所以看到如上描述的结果。</p>
<p>经过思考发现应该是本机同时运行了easyconnect（vpn软件），127.0.0.1 是他强行塞进来的。马上停掉easyconnect再ipconfig /all 验证一下这个时候的dns server，果然127.0.0.1不见了, nslookup 也正常了。</p>
<h2 id="某航空客户-windows下通过方舟dns域名解析不了方舟域名但是宿主机上可以windows机器能ping通dns-server-ip-但是nslookup-解析不了域名显示request-time-out" class="headerLink">
    <a href="#%e6%9f%90%e8%88%aa%e7%a9%ba%e5%ae%a2%e6%88%b7-windows%e4%b8%8b%e9%80%9a%e8%bf%87%e6%96%b9%e8%88%9fdns%e5%9f%9f%e5%90%8d%e8%a7%a3%e6%9e%90%e4%b8%8d%e4%ba%86%e6%96%b9%e8%88%9f%e5%9f%9f%e5%90%8d%e4%bd%86%e6%98%af%e5%ae%bf%e4%b8%bb%e6%9c%ba%e4%b8%8a%e5%8f%af%e4%bb%a5windows%e6%9c%ba%e5%99%a8%e8%83%bdping%e9%80%9adns-server-ip-%e4%bd%86%e6%98%afnslookup-%e8%a7%a3%e6%9e%90%e4%b8%8d%e4%ba%86%e5%9f%9f%e5%90%8d%e6%98%be%e7%a4%barequest-time-out" class="header-mark"></a>某航空客户 windows下通过方舟dns域名解析不了方舟域名，但是宿主机上可以。windows机器能ping通dns server ip, 但是nslookup 解析不了域名，显示request time out</h2><p><img class="tw-inline" loading="lazy" src=/Users/ren/case/ossimg/548975c04a8587e0fb33b5722b1a38f2.png   alt="image.png"  ></p>
<p>能ping通说明网络能通，但是dns域名要能解析依赖于：</p>
<ul>
<li>网络能通</li>
<li>dns server上有dns服务（53udp端口）</li>
<li>中间的防火墙对这个udp53端口限制了</li>
</ul>
<p>如上图，这里的问题非常明显是中间的防火墙没放行 udp 53端口</p>
<h2 id="方舟环境在ecs底座上dns会继承rotate模式导致域名解析不正常ping-域名不通但是nslookup能通" class="headerLink">
    <a href="#%e6%96%b9%e8%88%9f%e7%8e%af%e5%a2%83%e5%9c%a8ecs%e5%ba%95%e5%ba%a7%e4%b8%8adns%e4%bc%9a%e7%bb%a7%e6%89%bfrotate%e6%a8%a1%e5%bc%8f%e5%af%bc%e8%87%b4%e5%9f%9f%e5%90%8d%e8%a7%a3%e6%9e%90%e4%b8%8d%e6%ad%a3%e5%b8%b8ping-%e5%9f%9f%e5%90%8d%e4%b8%8d%e9%80%9a%e4%bd%86%e6%98%afnslookup%e8%83%bd%e9%80%9a" class="header-mark"></a>方舟环境在ECS底座上DNS会继承rotate模式，导致域名解析不正常，ping 域名不通，但是nslookup能通</h2><p><a href="https://www.atatech.org/articles/93688" target="_blank" rel="noopener noreferrer">nslookup 域名结果正确，但是 ping 域名失败</a></p>
<h2 id="某银行-poc-环境物理机搬迁到新机房后网络不通通过在物理机上抓包抓不到任何容器的包" class="headerLink">
    <a href="#%e6%9f%90%e9%93%b6%e8%a1%8c-poc-%e7%8e%af%e5%a2%83%e7%89%a9%e7%90%86%e6%9c%ba%e6%90%ac%e8%bf%81%e5%88%b0%e6%96%b0%e6%9c%ba%e6%88%bf%e5%90%8e%e7%bd%91%e7%bb%9c%e4%b8%8d%e9%80%9a%e9%80%9a%e8%bf%87%e5%9c%a8%e7%89%a9%e7%90%86%e6%9c%ba%e4%b8%8a%e6%8a%93%e5%8c%85%e6%8a%93%e4%b8%8d%e5%88%b0%e4%bb%bb%e4%bd%95%e5%ae%b9%e5%99%a8%e7%9a%84%e5%8c%85" class="header-mark"></a>某银行 POC 环境物理机搬迁到新机房后网络不通，通过在物理机上抓包，抓不到任何容器的包</h2><p><img class="tw-inline" loading="lazy" src=/Users/ren/case/ossimg/896f8f14d3be725515f192ed64542cb0.png   alt="image.png"  ></p>
<p><strong>如图所示容器中发了 arp包（IP 10.100.2.2 寻找10.100.2.1 的mac地址），这个包从bond0 网卡发出去了，也是带的正确的 vlanid 1011，但是交换机没有回复，那么就一定是交换机上vlan配置不对，需要找分配这个vlan的网工来检查交换机的配置</strong></p>
<p><!-- raw HTML omitted --><strong>能抓到进出的容器包&ndash;外部环境正确，方舟底座的问题</strong><!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted --><strong>不能抓到出去的容器包&ndash;方舟底座的问题</strong><!-- raw HTML omitted --></p>
<p><!-- raw HTML omitted --><strong>能抓到出去的容器包，抓不到回来的包&ndash;外部环境的问题</strong><!-- raw HTML omitted --></p>
<p>所以这里是方舟底座的问题。检查ovs、vlan插件一切都正常，见鬼了</p>
<p>检查宿主机网卡状态，发现没插网线，<strong>如果容器所用的宿主机网卡没有插网线，那么ovs就不会转发任何包到宿主机网卡</strong>。</p>
<h2 id="一台应用服务器无法访问部分drds-serverhttpsaonealibaba-inccomtask9753887" class="headerLink">
    <a href="#%e4%b8%80%e5%8f%b0%e5%ba%94%e7%94%a8%e6%9c%8d%e5%8a%a1%e5%99%a8%e6%97%a0%e6%b3%95%e8%ae%bf%e9%97%ae%e9%83%a8%e5%88%86drds-serverhttpsaonealibaba-inccomtask9753887" class="header-mark"></a><a href="https://aone.alibaba-inc.com/task/9753887" target="_blank" rel="noopener noreferrer">一台应用服务器无法访问部分drds-server</a></h2><p>应用机器： 10.100.10.201 这台机器抛502异常比较多，进一步诊断发现 ping youku.tddl.tbsite.net 的时候解析到 10.100.53.15/16就不通</p>
<p>直接ping 10.100.53.15/16 也不通，经过诊断发现是交换机上记录了两个 10.100.10.201的mac地址导致网络不通。</p>
<p><img class="tw-inline" loading="lazy" src=/Users/ren/case/ossimg/9deff3045e3213df81c3ad785cfddefa.gif   alt="youku-mac-ip.gif"  ></p>
<p><strong>上图是不通的IP，下图是正常IP</strong></p>
<p>经过调查发现是土豆业务也用了10.100.10.201这个IP导致交换机的ARP mac table冲突，土豆删除这个IP后故障就恢复了。</p>
<h3 id="当时交换机上发现的两条记录" class="headerLink">
    <a href="#%e5%bd%93%e6%97%b6%e4%ba%a4%e6%8d%a2%e6%9c%ba%e4%b8%8a%e5%8f%91%e7%8e%b0%e7%9a%84%e4%b8%a4%e6%9d%a1%e8%ae%b0%e5%bd%95" class="header-mark"></a>当时交换机上发现的两条记录：</h3><pre><code>00:18:51:38:b1:cd 10.100.10.201 
8c:dc:d4:b3:af:14 10.100.10.201
</code></pre>
<h2 id="某个客户默认修改了umask导致黑屏脚本权限不够部署中途不断卡壳直接在黑屏脚本中修复了admin这个用户的umask" class="headerLink">
    <a href="#%e6%9f%90%e4%b8%aa%e5%ae%a2%e6%88%b7%e9%bb%98%e8%ae%a4%e4%bf%ae%e6%94%b9%e4%ba%86umask%e5%af%bc%e8%87%b4%e9%bb%91%e5%b1%8f%e8%84%9a%e6%9c%ac%e6%9d%83%e9%99%90%e4%b8%8d%e5%a4%9f%e9%83%a8%e7%bd%b2%e4%b8%ad%e9%80%94%e4%b8%8d%e6%96%ad%e5%8d%a1%e5%a3%b3%e7%9b%b4%e6%8e%a5%e5%9c%a8%e9%bb%91%e5%b1%8f%e8%84%9a%e6%9c%ac%e4%b8%ad%e4%bf%ae%e5%a4%8d%e4%ba%86admin%e8%bf%99%e4%b8%aa%e7%94%a8%e6%88%b7%e7%9a%84umask" class="header-mark"></a>某个客户默认修改了umask导致黑屏脚本权限不够，部署中途不断卡壳，直接在黑屏脚本中修复了admin这个用户的umask</h2><ol>
<li>客户环境的 umask 是 0027 会导致所有copy文件的权限都不对了</li>
<li>因为admin没权限执行 /bin/jq 导致daemon.json是空的</li>
<li>/etc/docker/daemon.json 文件是空的，docker启动报错</li>
</ol>
<h2 id="修复centos下udp和批量处理脚本因为环境变量的确实不能执行modprobe和ping等等命令的问题同时将alios的这块修复逻辑放到了方舟安装脚本中init的时候会先把这个问题修复" class="headerLink">
    <a href="#%e4%bf%ae%e5%a4%8dcentos%e4%b8%8budp%e5%92%8c%e6%89%b9%e9%87%8f%e5%a4%84%e7%90%86%e8%84%9a%e6%9c%ac%e5%9b%a0%e4%b8%ba%e7%8e%af%e5%a2%83%e5%8f%98%e9%87%8f%e7%9a%84%e7%a1%ae%e5%ae%9e%e4%b8%8d%e8%83%bd%e6%89%a7%e8%a1%8cmodprobe%e5%92%8cping%e7%ad%89%e7%ad%89%e5%91%bd%e4%bb%a4%e7%9a%84%e9%97%ae%e9%a2%98%e5%90%8c%e6%97%b6%e5%b0%86alios%e7%9a%84%e8%bf%99%e5%9d%97%e4%bf%ae%e5%a4%8d%e9%80%bb%e8%be%91%e6%94%be%e5%88%b0%e4%ba%86%e6%96%b9%e8%88%9f%e5%ae%89%e8%a3%85%e8%84%9a%e6%9c%ac%e4%b8%adinit%e7%9a%84%e6%97%b6%e5%80%99%e4%bc%9a%e5%85%88%e6%8a%8a%e8%bf%99%e4%b8%aa%e9%97%ae%e9%a2%98%e4%bf%ae%e5%a4%8d" class="header-mark"></a>修复centos下udp和批量处理脚本因为环境变量的确实不能执行modprobe和ping等等命令的问题，同时将alios的这块修复逻辑放到了方舟安装脚本中，init的时候会先把这个问题修复</h2><p><a href="https://www.atatech.org/articles/105673" target="_blank" rel="noopener noreferrer">Linux环境变量问题汇总</a></p>
<h2 id="centos系统重启后-etcresolvconf总是被还原开始以为是系统bug研究后发现是可以配置的dhcp默认会每次重启后拉取dns自动更新-etcresolvconf" class="headerLink">
    <a href="#centos%e7%b3%bb%e7%bb%9f%e9%87%8d%e5%90%af%e5%90%8e-etcresolvconf%e6%80%bb%e6%98%af%e8%a2%ab%e8%bf%98%e5%8e%9f%e5%bc%80%e5%a7%8b%e4%bb%a5%e4%b8%ba%e6%98%af%e7%b3%bb%e7%bb%9fbug%e7%a0%94%e7%a9%b6%e5%90%8e%e5%8f%91%e7%8e%b0%e6%98%af%e5%8f%af%e4%bb%a5%e9%85%8d%e7%bd%ae%e7%9a%84dhcp%e9%bb%98%e8%ae%a4%e4%bc%9a%e6%af%8f%e6%ac%a1%e9%87%8d%e5%90%af%e5%90%8e%e6%8b%89%e5%8f%96dns%e8%87%aa%e5%8a%a8%e6%9b%b4%e6%96%b0-etcresolvconf" class="header-mark"></a>Centos系统重启后 /etc/resolv.conf总是被还原，开始以为是系统Bug，研究后发现是可以配置的，dhcp默认会每次重启后拉取DNS自动更新 /etc/resolv.conf</h2><h2 id="monkeyking-burn-cpu--mkt-burncpush-脚本在方舟服务器上运行一段时间后进程不见了mk团队认为是方舟杀掉了他们" class="headerLink">
    <a href="#monkeyking-burn-cpu--mkt-burncpush-%e8%84%9a%e6%9c%ac%e5%9c%a8%e6%96%b9%e8%88%9f%e6%9c%8d%e5%8a%a1%e5%99%a8%e4%b8%8a%e8%bf%90%e8%a1%8c%e4%b8%80%e6%ae%b5%e6%97%b6%e9%97%b4%e5%90%8e%e8%bf%9b%e7%a8%8b%e4%b8%8d%e8%a7%81%e4%ba%86mk%e5%9b%a2%e9%98%9f%e8%ae%a4%e4%b8%ba%e6%98%af%e6%96%b9%e8%88%9f%e6%9d%80%e6%8e%89%e4%ba%86%e4%bb%96%e4%bb%ac" class="header-mark"></a>MonkeyKing burn cpu:  mkt-burncpu.sh 脚本在方舟服务器上运行一段时间后，进程不见了，MK团队认为是方舟杀掉了他们。</h2><p>好奇心迫使我去看代码、<strong>看openssl测试输出日志</strong>（MonkeyKing burn cpu内部调用 openssl speed 测试cpu的速度），这个测试一轮跑完了opessl就结束了，本身就不是死循环一直跑, 不是方舟杀掉的。</p>
<p>另外说明这个问题一直存在开发、测试MonkeyKing功能的团队就没有发现，或者之前一直只需要跑不到10分钟就自己主动把它杀掉让出CPU。</p>
<p><img class="tw-inline" loading="lazy" src=/Users/ren/case/ossimg/7860a67e52c0de0febd7ec944a4b1517.png   alt="image.png"  ></p>
<h2 id="某汽车客户-部署过程中愚公不能正常启动怀疑是依赖的zk问题zk网络访问正常" class="headerLink">
    <a href="#%e6%9f%90%e6%b1%bd%e8%bd%a6%e5%ae%a2%e6%88%b7-%e9%83%a8%e7%bd%b2%e8%bf%87%e7%a8%8b%e4%b8%ad%e6%84%9a%e5%85%ac%e4%b8%8d%e8%83%bd%e6%ad%a3%e5%b8%b8%e5%90%af%e5%8a%a8%e6%80%80%e7%96%91%e6%98%af%e4%be%9d%e8%b5%96%e7%9a%84zk%e9%97%ae%e9%a2%98zk%e7%bd%91%e7%bb%9c%e8%ae%bf%e9%97%ae%e6%ad%a3%e5%b8%b8" class="header-mark"></a>某汽车客户 部署过程中愚公不能正常启动，怀疑是依赖的zk问题，zk网络访问正常</h2><p>尝试telnet zk发现不通，客户现场安装了kerberos导致telnet测试有问题（telnet被kerberos替换过）,换一个其他环境的telnet 二进制文件就可以了（md5sum、telnet &ndash;help）</p>
<h2 id="开发反应两个容器之间的网络不稳定偶尔报连不上某些容器httpsaonealibaba-inccomissue10403085" class="headerLink">
    <a href="#%e5%bc%80%e5%8f%91%e5%8f%8d%e5%ba%94%e4%b8%a4%e4%b8%aa%e5%ae%b9%e5%99%a8%e4%b9%8b%e9%97%b4%e7%9a%84%e7%bd%91%e7%bb%9c%e4%b8%8d%e7%a8%b3%e5%ae%9a%e5%81%b6%e5%b0%94%e6%8a%a5%e8%bf%9e%e4%b8%8d%e4%b8%8a%e6%9f%90%e4%ba%9b%e5%ae%b9%e5%99%a8httpsaonealibaba-inccomissue10403085" class="header-mark"></a><a href="https://aone.alibaba-inc.com/issue/10403085" target="_blank" rel="noopener noreferrer">开发反应两个容器之间的网络不稳定，偶尔报连不上某些容器</a></h2><p>主要是出现在tlog-console访问hbase容器的时候报连接异常</p>
<ol>
<li>在 task_1114_g0_tlog-console_tlog_1（10.16.11.131） 的56789 端口上启动了一个简单的http服务，然后从 task_1114_g0_tlog-hbase_tlog（10.16.11.108） 每秒钟去访问一下10.16.11.131:56789 , 如果丢包率很高的时候服务 10.16.11.131:56789 也很慢或者访问不到就是网络问题，否则就有可能是hbase服务不响应导致的丢包、网络不通（仅仅是影响hbase服务）</li>
<li>反过来在hbase上同样启动http服务，tlog-console不停地去get</li>
<li>整个过程我的http服务响应非常迅速稳定，从没出现过异常</li>
<li>在重现问题侯，贺飞发现 是tlog线程数目先增多，retran才逐渐增高的， retran升高，并没有影响在那台机器上ping 或者telnet hbase的服务</li>
<li>通过以上方式证明跟容器、网络无关，是应用本身的问题，交由产品开发继续解决</li>
</ol>
<h4 id="最终开发确认网络没有问题后一门心思闷头自查得出结论" class="headerLink">
    <a href="#%e6%9c%80%e7%bb%88%e5%bc%80%e5%8f%91%e7%a1%ae%e8%ae%a4%e7%bd%91%e7%bb%9c%e6%b2%a1%e6%9c%89%e9%97%ae%e9%a2%98%e5%90%8e%e4%b8%80%e9%97%a8%e5%bf%83%e6%80%9d%e9%97%b7%e5%a4%b4%e8%87%aa%e6%9f%a5%e5%be%97%e5%87%ba%e7%bb%93%e8%ae%ba" class="header-mark"></a>最终开发确认网络没有问题后一门心思闷头自查得出结论：</h4><p>信息更新：</p>
<p>问题：
tlog-console进程线程数多，卡在连接hbase上的问题</p>
<p>直接原因：</p>
<ol>
<li>tlog-console有巡检程序，每m分钟会检查运行超过n秒的线程，并且中断这个线程； 这个操作直接导致hbase客户端在等待hbaseserver返回数据的时候被中断，这种中断会经常发生，累积久了，就会打爆tlog-console服务的线程数目，这时候，tlogconsole机器的retran就会变多，连接hbaseserver就会出问题， 具体的机理不明</li>
</ol>
<p>解决问题的有效操作：</p>
<ol>
<li>停止对tlog-console的巡检程序后，问题没有发生过</li>
</ol>
<p>其他潜在问题，这些问题是检查问题的时候，发现的其他潜在问题，已经反馈给tlog团队：</p>
<ol>
<li>Htable实例不是线程安全,有逻辑多线程使用相同的htable实例</li>
<li>程序中有new HTable 不close的路径</li>
</ol>
<h2 id="某化工私有云drds扩容总是报资源不足主要是因为有些drds-server容器指定了--cpu-shares128相当于4core--1024物理核数-等于每个核对应的cpu-shares--导致物理机cpu不够现场将所有容器的--cpu-shares改成2后修复这个问题但是最终需要产品方" class="headerLink">
    <a href="#%e6%9f%90%e5%8c%96%e5%b7%a5%e7%a7%81%e6%9c%89%e4%ba%91drds%e6%89%a9%e5%ae%b9%e6%80%bb%e6%98%af%e6%8a%a5%e8%b5%84%e6%ba%90%e4%b8%8d%e8%b6%b3%e4%b8%bb%e8%a6%81%e6%98%af%e5%9b%a0%e4%b8%ba%e6%9c%89%e4%ba%9bdrds-server%e5%ae%b9%e5%99%a8%e6%8c%87%e5%ae%9a%e4%ba%86--cpu-shares128%e7%9b%b8%e5%bd%93%e4%ba%8e4core--1024%e7%89%a9%e7%90%86%e6%a0%b8%e6%95%b0-%e7%ad%89%e4%ba%8e%e6%af%8f%e4%b8%aa%e6%a0%b8%e5%af%b9%e5%ba%94%e7%9a%84cpu-shares--%e5%af%bc%e8%87%b4%e7%89%a9%e7%90%86%e6%9c%bacpu%e4%b8%8d%e5%a4%9f%e7%8e%b0%e5%9c%ba%e5%b0%86%e6%89%80%e6%9c%89%e5%ae%b9%e5%99%a8%e7%9a%84--cpu-shares%e6%94%b9%e6%88%902%e5%90%8e%e4%bf%ae%e5%a4%8d%e8%bf%99%e4%b8%aa%e9%97%ae%e9%a2%98%e4%bd%86%e6%98%af%e6%9c%80%e7%bb%88%e9%9c%80%e8%a6%81%e4%ba%a7%e5%93%81%e6%96%b9" class="header-mark"></a>某化工私有云DRDS扩容总是报资源不足，主要是因为有些drds-server容器指定了&ndash;cpu-shares=128(相当于4Core&ndash;1024/物理核数 等于每个核对应的cpu-shares ), 导致物理机CPU不够。现场将所有容器的&ndash;cpu-shares改成2后修复这个问题，但是最终需要产品方</h2><p>主要是swarm对cpu-shares的判断上有错误，swarm默认认定每台机器的总cpu-shares是1024，也就是 1024/物理核数 等于每个核对应的cpu-shares</p>
<p>如果需要精细化CPU控制，cpu-shares比cpu-set之类的要精确，利用率更高。但是也更容易出现问题</p>
<h2 id="mq-diamond的异常日志总是打爆磁盘mq-diamond-容器一天输出500g日志的问题本质是调用的依赖不可用了导致mq-diamond-频繁输出日志两天就用掉了1t磁盘" class="headerLink">
    <a href="#mq-diamond%e7%9a%84%e5%bc%82%e5%b8%b8%e6%97%a5%e5%bf%97%e6%80%bb%e6%98%af%e6%89%93%e7%88%86%e7%a3%81%e7%9b%98mq-diamond-%e5%ae%b9%e5%99%a8%e4%b8%80%e5%a4%a9%e8%be%93%e5%87%ba500g%e6%97%a5%e5%bf%97%e7%9a%84%e9%97%ae%e9%a2%98%e6%9c%ac%e8%b4%a8%e6%98%af%e8%b0%83%e7%94%a8%e7%9a%84%e4%be%9d%e8%b5%96%e4%b8%8d%e5%8f%af%e7%94%a8%e4%ba%86%e5%af%bc%e8%87%b4mq-diamond-%e9%a2%91%e7%b9%81%e8%be%93%e5%87%ba%e6%97%a5%e5%bf%97%e4%b8%a4%e5%a4%a9%e5%b0%b1%e7%94%a8%e6%8e%89%e4%ba%861t%e7%a3%81%e7%9b%98" class="header-mark"></a>mq-diamond的异常日志总是打爆磁盘。mq-diamond 容器一天输出500G日志的问题，本质是调用的依赖不可用了，导致mq-diamond 频繁输出日志，两天就用掉了1T磁盘.</h2><p>这里有两个问题需要处理：</p>
<ol>
<li>mq-diamond 依赖的服务可用；</li>
<li>mq-diamond 自身保护，不要被自己的日志把磁盘撑爆了</li>
</ol>
<p>对于问题二修改log4j来保护；对于问题1查看异常内容，mq-diamond尝试连接server：ip1,ip2,ip3 正常这里应该是一个ip而不是三个ip放一起。判断是mq-diamond从mq-cai获取diamond iplist有问题，这个iplist应该放在三行，但是实际被放到了1行，用逗号隔开</p>
<p>手工修改这个文件，放到三行，问题没完，还是异常，我自己崩溃没管。最后听mq-diamond的开发讲他们取iplist的url比较特殊，是自己定义的，所以我修改的地方不起作用。<strong>反思，为什么修改不起作用的时候不去看看Nginx的access日志？ 这样可以证明我修改的文件实际没有被使用，同时还能找到真正被使用的配置文件</strong></p>
<h2 id="内核migration进程bug导致宿主机load非常高同时cpu-idle也很高两者矛盾" class="headerLink">
    <a href="#%e5%86%85%e6%a0%b8migration%e8%bf%9b%e7%a8%8bbug%e5%af%bc%e8%87%b4%e5%ae%bf%e4%b8%bb%e6%9c%baload%e9%9d%9e%e5%b8%b8%e9%ab%98%e5%90%8c%e6%97%b6cpu-idle%e4%b9%9f%e5%be%88%e9%ab%98%e4%b8%a4%e8%80%85%e7%9f%9b%e7%9b%be" class="header-mark"></a>内核migration进程bug导致宿主机Load非常高，同时CPU idle也很高（两者矛盾）</h2><p><a href="https://aone.alibaba-inc.com/issue/12510664" target="_blank" rel="noopener noreferrer">内核migration进程bug导致对应的CPU核卡死</a>（图一），这个核上的所有进程得不到执行（Load高，CPU没有任何消耗， 图二），直到内核进程 watchdog 发现这个问题并恢复它。</p>
<p>出现这个bug后的症状，通过top命令看到CPU没有任何消耗但是Load偏高，如果应用进程恰好被调度到这个出问题的CPU核上，那么这个进程会卡住（大概20秒）没有任何响应，比如 ping 进程（图三图四），watchdog恢复这个问题后，多个网络包在同一时间全部通。其实所影响的不仅仅是网络卡顿，中间件容器里面的服务如果调度到这个CPU核上同样得不到执行，从外面就是感觉容器不响应了</p>
<p><img class="tw-inline" loading="lazy" src=/Users/ren/case/ossimg/f4843725cf82e257fa14fd3742c2f9ce.png   alt="image.png"  ></p>
<p><img class="tw-inline" loading="lazy" src=/Users/ren/case/ossimg/11d6db76c6de822385c0f63d2bf6eb03.png   alt="image.png"  ></p>
<p><img class="tw-inline" loading="lazy" src=/Users/ren/case/ossimg/ac9e2eb1b01976cefa1b74dcddd23885.png   alt="image.png"  ></p>
<p><img class="tw-inline" loading="lazy" src=/Users/ren/case/ossimg/371870b7db916e3edf515beec3a80bda.png   alt="image.png"  ></p>
<p>拿如上证据求助内核开发</p>
<p>关键信息在这里：
代码第297行
2017-09-15T06:52:37.820783+00:00 ascliveedas4.sgdc kernel: [598346.499872] WARNING: at net/sched/sch_generic.c:297 dev_watchdog+0x270/0x280()
2017-09-15T06:52:37.820784+00:00 ascliveedas4.sgdc kernel: [598346.499873] NETDEV WATCHDOG: ens2f0 (ixgbe): transmit queue 28 timed out</p>
<p>kernel version: kernel-3.10.0-327.22.2.el7.src.rpm</p>
<pre><code>265 static void dev_watchdog(unsigned long arg)
266 {
267 struct net_device *dev = (struct net_device *)arg;
268
269 netif_tx_lock(dev);
270 if (!qdisc_tx_is_noop(dev)) {
271 if (netif_device_present(dev) &amp;&amp;
272 netif_running(dev) &amp;&amp;
273 netif_carrier_ok(dev)) {
274 int some_queue_timedout = 0;
275 unsigned int i;
276 unsigned long trans_start;
277
278 for (i = 0; i &lt; dev-&gt;num_tx_queues; i++) {
279 struct netdev_queue *txq;
280
281 txq = netdev_get_tx_queue(dev, i);
282 /*
283  * old device drivers set dev-&gt;trans_start
284  */
285 trans_start = txq-&gt;trans_start ? : dev-&gt;trans_start;
286 if (netif_xmit_stopped(txq) &amp;&amp;
287 time_after(jiffies, (trans_start +
288  dev-&gt;watchdog_timeo))) {
289 some_queue_timedout = 1;
290 txq-&gt;trans_timeout++;
291 break;
292 }
293 }
294
295 if (some_queue_timedout) {
296 WARN_ONCE(1, KERN_INFO &quot;NETDEV WATCHDOG: %s (%s): transmit queue %u timed out\n&quot;,
297dev-&gt;name, netdev_drivername(dev), i);
298 dev-&gt;netdev_ops-&gt;ndo_tx_timeout(dev);
299 }
300 if (!mod_timer(&amp;dev-&gt;watchdog_timer,
301round_jiffies(jiffies +
302  dev-&gt;watchdog_timeo)))
303 dev_hold(dev);
304 }



$ cat  kernel_log.0915
2017-09-15T02:19:55.975310+00:00 ascliveedas4.sgdc kernel: [582026.288227] openvswitch: netlink: Key type 62 is out of range max 22
2017-09-15T03:49:41.312168+00:00 ascliveedas4.sgdc kernel: [587409.546584] md: md0: data-check interrupted.
2017-09-15T06:52:37.820782+00:00 ascliveedas4.sgdc kernel: [598346.499865] ------------[ cut here ]------------
2017-09-15T06:52:37.820783+00:00 ascliveedas4.sgdc kernel: [598346.499872] WARNING: at net/sched/sch_generic.c:297 dev_watchdog+0x270/0x280()
2017-09-15T06:52:37.820784+00:00 ascliveedas4.sgdc kernel: [598346.499873] NETDEV WATCHDOG: ens2f0 (ixgbe): transmit queue 28 timed out
2017-09-15T06:52:37.820784+00:00 ascliveedas4.sgdc kernel: [598346.499916] Modules linked in: 8021q garp mrp xt_nat veth xt_addrtype ipt_MASQUERADE nf_nat_masquerade_ipv4 iptable_nat nf_conntrack_ipv4 nf_defrag_ipv4 nf_nat_ipv4 iptable_filter xt_conntrack nf_nat nf_conntrack bridge stp llc tcp_diag udp_diag inet_diag binfmt_misc overlay() vfat fat intel_powerclamp coretemp intel_rapl kvm_intel kvm crc32_pclmul ghash_clmulni_intel aesni_intel lrw gf128mul glue_helper ablk_helper cryptd raid10 ipmi_devintf iTCO_wdt iTCO_vendor_support sb_edac lpc_ich hpwdt edac_core hpilo i2c_i801 ipmi_si sg mfd_core pcspkr ioatdma ipmi_msghandler acpi_power_meter shpchp wmi pcc_cpufreq openvswitch libcrc32c nfsd auth_rpcgss nfs_acl lockd grace sunrpc ip_tables ext4 mbcache jbd2 sd_mod crc_t10dif crct10dif_generic mgag200 syscopyarea sysfillrect sysimgblt drm_kms_helper ixgbe crct10dif_pclmul ahci ttm crct10dif_common igb crc32c_intel mdio libahci ptp drm pps_core i2c_algo_bit libata i2c_core dca dm_mirror dm_region_hash dm_log dm_mod
2017-09-15T06:52:37.820786+00:00 ascliveedas4.sgdc kernel: [598346.499928] CPU: 10 PID: 123 Comm: migration/10 Tainted: G L ------------ T 3.10.0-327.22.2.el7.x86_64#1
2017-09-15T06:52:37.820787+00:00 ascliveedas4.sgdc kernel: [598346.499929] Hardware name: HP ProLiant DL160 Gen9/ProLiant DL160 Gen9, BIOS U20 12/27/2015
2017-09-15T06:52:37.820788+00:00 ascliveedas4.sgdc kernel: [598346.499935]  ffff88207fc43d88 000000001cdfb0f1 ffff88207fc43d40 ffffffff816360fc
2017-09-15T06:52:37.820789+00:00 ascliveedas4.sgdc kernel: [598346.499939]  ffff88207fc43d78 ffffffff8107b200 000000000000001c ffff881024660000
2017-09-15T06:52:37.820790+00:00 ascliveedas4.sgdc kernel: [598346.499942]  ffff881024654f40 0000000000000040 000000000000000a ffff88207fc43de0
2017-09-15T06:52:37.820791+00:00 ascliveedas4.sgdc kernel: [598346.499943] Call Trace:
2017-09-15T06:52:37.820792+00:00 ascliveedas4.sgdc kernel: [598346.499952]  &lt;IRQ&gt;  [&lt;ffffffff816360fc&gt;] dump_stack+0x19/0x1b
2017-09-15T06:52:37.820794+00:00 ascliveedas4.sgdc kernel: [598346.499956]  [&lt;ffffffff8107b200&gt;] warn_slowpath_common+0x70/0xb0
2017-09-15T06:52:37.820795+00:00 ascliveedas4.sgdc kernel: [598346.499959]  [&lt;ffffffff8107b29c&gt;] warn_slowpath_fmt+0x5c/0x80
2017-09-15T06:52:37.820795+00:00 ascliveedas4.sgdc kernel: [598346.499964]  [&lt;ffffffff8154d4f0&gt;] dev_watchdog+0x270/0x280
2017-09-15T06:52:37.820796+00:00 ascliveedas4.sgdc kernel: [598346.499966]  [&lt;ffffffff8154d280&gt;] ? dev_graft_qdisc+0x80/0x80
2017-09-15T06:52:37.820797+00:00 ascliveedas4.sgdc kernel: [598346.499972]  [&lt;ffffffff8108b0a6&gt;] call_timer_fn+0x36/0x110
2017-09-15T06:52:37.820798+00:00 ascliveedas4.sgdc kernel: [598346.499974]  [&lt;ffffffff8154d280&gt;] ? dev_graft_qdisc+0x80/0x80
2017-09-15T06:52:37.820799+00:00 ascliveedas4.sgdc kernel: [598346.499977]  [&lt;ffffffff8108dd97&gt;] run_timer_softirq+0x237/0x340
2017-09-15T06:52:37.820800+00:00 ascliveedas4.sgdc kernel: [598346.499980]  [&lt;ffffffff81084b0f&gt;] __do_softirq+0xef/0x280
2017-09-15T06:52:37.820801+00:00 ascliveedas4.sgdc kernel: [598346.499985]  [&lt;ffffffff81103360&gt;] ? cpu_stop_should_run+0x50/0x50
2017-09-15T06:52:37.820801+00:00 ascliveedas4.sgdc kernel: [598346.499988]  [&lt;ffffffff8164819c&gt;] call_softirq+0x1c/0x30
2017-09-15T06:52:37.820802+00:00 ascliveedas4.sgdc kernel: [598346.499994]  [&lt;ffffffff81016fc5&gt;] do_softirq+0x65/0xa0
2017-09-15T06:52:37.820803+00:00 ascliveedas4.sgdc kernel: [598346.499996]  [&lt;ffffffff81084ea5&gt;] irq_exit+0x115/0x120
2017-09-15T06:52:37.820804+00:00 ascliveedas4.sgdc kernel: [598346.499999]  [&lt;ffffffff81648e15&gt;] smp_apic_timer_interrupt+0x45/0x60
2017-09-15T06:52:37.820805+00:00 ascliveedas4.sgdc kernel: [598346.500003]  [&lt;ffffffff816474dd&gt;] apic_timer_interrupt+0x6d/0x80
2017-09-15T06:52:37.820813+00:00 ascliveedas4.sgdc kernel: [598346.500007]  &lt;EOI&gt;  [&lt;ffffffff811033df&gt;] ? multi_cpu_stop+0x7f/0xf0
2017-09-15T06:52:37.820815+00:00 ascliveedas4.sgdc kernel: [598346.500010]  [&lt;ffffffff81103666&gt;] cpu_stopper_thread+0x96/0x170
</code></pre>
<h2 id="某银行客户raid阵列坏掉导致物理机重启后容器的net-alias域名解析不到" class="headerLink">
    <a href="#%e6%9f%90%e9%93%b6%e8%a1%8c%e5%ae%a2%e6%88%b7raid%e9%98%b5%e5%88%97%e5%9d%8f%e6%8e%89%e5%af%bc%e8%87%b4%e7%89%a9%e7%90%86%e6%9c%ba%e9%87%8d%e5%90%af%e5%90%8e%e5%ae%b9%e5%99%a8%e7%9a%84net-alias%e5%9f%9f%e5%90%8d%e8%a7%a3%e6%9e%90%e4%b8%8d%e5%88%b0" class="header-mark"></a>某银行客户RAID阵列坏掉，导致物理机重启后容器的net-alias域名解析不到</h2><p>docker daemon 的endpoint用的容器名存在zk中，如果创建一个重复名字的容器，那么会失败，然后回滚，回滚动作会把zk中别人的endpoint删掉，从而导致域名不通。</p>
<p>物理机异常后，我们的调度程序会在其它物理机重新调度生成这个容器，但是当原来的物理机回来后，这里有两个一样的容器会自动删掉宕机的物理机上的这个容器，从而误删net-alias，进而域名无法解析</p>
<h2 id="某快递客户php短连接httpsaonealibaba-inccomtask10409778访问drds会导致极低概率出现连接被reset货运快递客户事务没生效导致数据库写入的金额对不上账" class="headerLink">
    <a href="#%e6%9f%90%e5%bf%ab%e9%80%92%e5%ae%a2%e6%88%b7php%e7%9f%ad%e8%bf%9e%e6%8e%a5httpsaonealibaba-inccomtask10409778%e8%ae%bf%e9%97%aedrds%e4%bc%9a%e5%af%bc%e8%87%b4%e6%9e%81%e4%bd%8e%e6%a6%82%e7%8e%87%e5%87%ba%e7%8e%b0%e8%bf%9e%e6%8e%a5%e8%a2%abreset%e8%b4%a7%e8%bf%90%e5%bf%ab%e9%80%92%e5%ae%a2%e6%88%b7%e4%ba%8b%e5%8a%a1%e6%b2%a1%e7%94%9f%e6%95%88%e5%af%bc%e8%87%b4%e6%95%b0%e6%8d%ae%e5%ba%93%e5%86%99%e5%85%a5%e7%9a%84%e9%87%91%e9%a2%9d%e5%af%b9%e4%b8%8d%e4%b8%8a%e8%b4%a6" class="header-mark"></a><a href="https://aone.alibaba-inc.com/task/10409778" target="_blank" rel="noopener noreferrer">某快递客户PHP短连接</a>访问DRDS会导致极低概率出现连接被reset、货运快递客户事务没生效导致数据库写入的金额对不上账</h2><h2 id="参考文章" class="headerLink">
    <a href="#%e5%8f%82%e8%80%83%e6%96%87%e7%ab%a0" class="header-mark"></a>参考文章</h2><p><a href="https://mp.weixin.qq.com/s?__biz=MzU5Mzc0NDUyNg==&amp;mid=2247483793&amp;idx=1&amp;sn=c7b4ec96d186dd74689482077522337f&amp;scene=21#wechat_redirect" target="_blank" rel="noopener noreferrer">https://mp.weixin.qq.com/s?__biz=MzU5Mzc0NDUyNg==&mid=2247483793&idx=1&sn=c7b4ec96d186dd74689482077522337f&scene=21#wechat_redirect</a></p>
</div>

        <div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>更新于 2018-10-24</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line print:!tw-hidden">
            <div class="post-info-md"></div>
            <div class="post-info-share"></div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M497.941 225.941L286.059 14.059A48 48 0 0 0 252.118 0H48C21.49 0 0 21.49 0 48v204.118a48 48 0 0 0 14.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882 0l204.118-204.118c18.745-18.745 18.745-49.137 0-67.882zM112 160c-26.51 0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882 0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397 0h48.721a48 48 0 0 1 33.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137 0 67.882z"/></svg>&nbsp;<a href="/tags/linux/">Linux</a>,&nbsp;<a href="/tags/tcp/">TCP</a>,&nbsp;<a href="/tags/network/">Network</a>,&nbsp;<a href="/tags/performance/">Performance</a>,&nbsp;<a href="/tags/docker/">Docker</a>,&nbsp;<a href="/tags/debug/">Debug</a></section>
        <section class="print:!tw-hidden">
            <span><button class="tw-text-fgColor-link-muted hover:tw-text-fgColor-link-muted-hover" onclick="window.history.back();">返回</button></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
        </section>
    </div>

    <div class="post-nav print:tw-hidden"><a href="/posts/high_load/" class="prev" rel="prev" title="Load很高，CPU使用率很低"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M31.7 239l136-136c9.4-9.4 24.6-9.4 33.9 0l22.6 22.6c9.4 9.4 9.4 24.6 0 33.9L127.9 256l96.4 96.4c9.4 9.4 9.4 24.6 0 33.9L201.7 409c-9.4 9.4-24.6 9.4-33.9 0l-136-136c-9.5-9.4-9.5-24.6-.1-34z"/></svg>Load很高，CPU使用率很低</a>
            <a href="/posts/%E4%B8%80%E4%B8%AA%E6%B2%A1%E6%9C%89%E9%81%B5%E5%AE%88tcp%E8%A7%84%E5%88%99%E5%AF%BC%E8%87%B4%E7%9A%84%E9%97%AE%E9%A2%98/" class="next" rel="next" title="一个没有遵守tcp规则导致的问题">一个没有遵守tcp规则导致的问题<svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 256 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M224.3 273l-136 136c-9.4 9.4-24.6 9.4-33.9 0l-22.6-22.6c-9.4-9.4-9.4-24.6 0-33.9l96.4-96.4-96.4-96.4c-9.4-9.4-9.4-24.6 0-33.9L54.3 103c9.4-9.4 24.6-9.4 33.9 0l136 136c9.5 9.4 9.5 24.6.1 34z"/></svg></a></div>
</div>
<div id="comments" class="print:!tw-hidden tw-pt-32 tw-pb-8"><div id="disqus_thread" class="comment"></div><noscript>
                Please enable JavaScript to view the comments powered by <a href="https://disqus.com/?ref_noscript">Disqus</a>.
            </noscript></div></article></div>
        </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">
                    由 <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer" title="Hugo 0.139.0">Hugo</a> 强力驱动&nbsp;|&nbsp;主题 - <a href="https://github.com/HEIGE-PCloud/DoIt" target="_blank" rel="noopener noreferrer" title="DoIt 0.4.0"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M402.3 344.9l32-32c5-5 13.7-1.5 13.7 5.7V464c0 26.5-21.5 48-48 48H48c-26.5 0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h273.5c7.1 0 10.7 8.6 5.7 13.7l-32 32c-1.5 1.5-3.5 2.3-5.7 2.3H48v352h352V350.5c0-2.1.8-4.1 2.3-5.6zm156.6-201.8L296.3 405.7l-90.4 10c-26.2 2.9-48.5-19.2-45.6-45.6l10-90.4L432.9 17.1c22.9-22.9 59.9-22.9 82.7 0l43.2 43.2c22.9 22.9 22.9 60 .1 82.8zM460.1 174L402 115.9 216.2 301.8l-7.3 65.3 65.3-7.3L460.1 174zm64.8-79.7l-43.2-43.2c-4.1-4.1-10.8-4.1-14.8 0L436 82l58.1 58.1 30.9-30.9c4-4.2 4-10.8-.1-14.9z"/></svg> DoIt</a>
                </div><div class="footer-line"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M256 8C119.033 8 8 119.033 8 256s111.033 248 248 248 248-111.033 248-248S392.967 8 256 8zm0 448c-110.532 0-200-89.451-200-200 0-110.531 89.451-200 200-200 110.532 0 200 89.451 200 200 0 110.532-89.451 200-200 200zm107.351-101.064c-9.614 9.712-45.53 41.396-104.065 41.396-82.43 0-140.484-61.425-140.484-141.567 0-79.152 60.275-139.401 139.762-139.401 55.531 0 88.738 26.62 97.593 34.779a11.965 11.965 0 0 1 1.936 15.322l-18.155 28.113c-3.841 5.95-11.966 7.282-17.499 2.921-8.595-6.776-31.814-22.538-61.708-22.538-48.303 0-77.916 35.33-77.916 80.082 0 41.589 26.888 83.692 78.277 83.692 32.657 0 56.843-19.039 65.726-27.225 5.27-4.857 13.596-4.039 17.82 1.738l19.865 27.17a11.947 11.947 0 0 1-1.152 15.518z"/></svg>2024<span class="author">&nbsp;<a href="/" target="_blank" rel="noopener noreferrer"></a></span></div>
            <div class="footer-line">
                    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
                    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: inline;">
                        <span class="post-meta-item-icon"><svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M288 144a110.94 110.94 0 0 0-31.24 5 55.4 55.4 0 0 1 7.24 27 56 56 0 0 1-56 56 55.4 55.4 0 0 1-27-7.24A111.71 111.71 0 1 0 288 144zm284.52 97.4C518.29 135.59 410.93 64 288 64S57.68 135.64 3.48 241.41a32.35 32.35 0 0 0 0 29.19C57.71 376.41 165.07 448 288 448s230.32-71.64 284.52-177.41a32.35 32.35 0 0 0 0-29.19zM288 400c-98.65 0-189.09-55-237.93-144C98.91 167 189.34 112 288 112s189.09 55 237.93 144C477.1 345 386.66 400 288 400z"/></svg></span>
                        <span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span>
                    </span></div>
            <div class="footer-line">
            </div>
        </div></footer></div>

    <div id="fixed-buttons" class="print:!tw-hidden"><a href="#back-to-top" id="back-to-top-button" class="fixed-button tw-transition-opacity tw-opacity-0" title="回到顶部">
            <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6 0-33.9L207 39c9.4-9.4 24.6-9.4 33.9 0l194.3 194.3c9.4 9.4 9.4 24.6 0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3 0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg>
        </a><a href="#comments" id="view-comments" class="fixed-button" title="查看评论">
            <svg class="icon"
    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!-- Font Awesome Free 5.15.4 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) --><path d="M256 32C114.6 32 0 125.1 0 240c0 49.6 21.4 95 57 130.7C44.5 421.1 2.7 466 2.2 466.5c-2.2 2.3-2.8 5.7-1.5 8.7S4.8 480 8 480c66.3 0 116-31.8 140.6-51.4 32.7 12.3 69 19.4 107.4 19.4 141.4 0 256-93.1 256-208S397.4 32 256 32z"/></svg>
        </a></div>
<script>window.config={"comment":{}};</script><script
    src="/js/theme.min.js"
    
      defer
    
  ></script><script
    src="https://.disqus.com/embed.js"
    
      defer
    
  ></script>
    
    <script type="speculationrules">
        {
          "prerender": [
            {
              "where": { "href_matches": "/*" },
              "eagerness": "moderate"
            }
          ]
        }
    </script>
      
</body>

</html>
