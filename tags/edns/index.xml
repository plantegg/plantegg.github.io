<rss xmlns:atom="http://www.w3.org/2005/Atom" version="2.0">
    <channel>
        <title>EDNS - 标签 - plantegg</title>
        <link>http://localhost:1313/tags/edns/</link>
        <description>EDNS - 标签 - plantegg</description>
        <generator>Hugo -- gohugo.io</generator><language>zh-Hans</language><lastBuildDate>Sun, 13 Jan 2019 10:30:03 &#43;0000</lastBuildDate><atom:link href="http://localhost:1313/tags/edns/" rel="self" type="application/rss+xml" /><item>
    <title>中间件的vipclient服务在centos7上域名解析失败</title>
    <link>http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E8%87%AA%E5%B7%B1%E7%9A%84dns%E6%9C%8D%E5%8A%A1%E5%9C%A8alios7%E4%B8%8A%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E5%A4%B1%E8%B4%A5/</link>
    <pubDate>Sun, 13 Jan 2019 10:30:03 &#43;0000</pubDate><author>
        <name>作者</name>
    </author><guid>http://localhost:1313/posts/%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%9A%84%E8%87%AA%E5%B7%B1%E7%9A%84dns%E6%9C%8D%E5%8A%A1%E5%9C%A8alios7%E4%B8%8A%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90%E5%A4%B1%E8%B4%A5/</guid>
    <description><![CDATA[<h1 id="中间件的vipclient服务在centos7上域名解析失败" class="headerLink">
    <a href="#%e4%b8%ad%e9%97%b4%e4%bb%b6%e7%9a%84vipclient%e6%9c%8d%e5%8a%a1%e5%9c%a8centos7%e4%b8%8a%e5%9f%9f%e5%90%8d%e8%a7%a3%e6%9e%90%e5%a4%b1%e8%b4%a5" class="header-mark"></a>中间件的vipclient服务在centos7上域名解析失败</h1><blockquote>
  <p>我们申请了一批ECS，操作系统是centos7，这些ECS部署了中间件的DNS服务（vipclient），但是发现这个时候域名解析失败，而同样的配置在centos6上就运行正确</p>

</blockquote><h2 id="抓包分析" class="headerLink">
    <a href="#%e6%8a%93%e5%8c%85%e5%88%86%e6%9e%90" class="header-mark"></a>抓包分析</h2><p>分别在centos6、centos7上nslookup通过同一个DNS Server解析同一个域名，并抓包比较得到如下截图（为了方便我将centos6、7抓包做到了一张图上）：</p>
<p><img class="tw-inline" loading="lazy" src=http://localhost:1313/Users/ren/case/ossimg/1d5295ccb1fab715f246b54faf94eaaf.png   alt="image.png"  ></p>
<p>绿色部分是正常的解析（centos6），<strong>红色部分是解析，多了一个OPT（centos7）</strong></p>
<p>赶紧Google一下OPT，原来DNS协议还有一个extention，参考<a href="https://tools.ietf.org/html/rfc6891#page-15" title="EDNS OPT" target="_blank" rel="noopener noreferrer">这里</a>：</p>
<p>而centos7默认启用edns，但是vipclient实现的时候没有支持edns，所以 centos7 解析域名就出了问题</p>
<h2 id="通过-dig-命令来查看dns解析过程" class="headerLink">
    <a href="#%e9%80%9a%e8%bf%87-dig-%e5%91%bd%e4%bb%a4%e6%9d%a5%e6%9f%a5%e7%9c%8bdns%e8%a7%a3%e6%9e%90%e8%bf%87%e7%a8%8b" class="header-mark"></a>通过 dig 命令来查看dns解析过程</h2><p>在centos7上，通过命令 dig edas.console.cztest.com 解析失败，但是改用这个命令禁用edns后就解析正常了：dig +noedns edas.console.cztest.com</p>
<p>vipclient会启动一个53端口，在上面监听dns query，也就是自己就是一个DNS Service</p>
<p><img class="tw-inline" loading="lazy" src=https://cdn.jsdelivr.net/gh/plantegg/plantegg.github.io/images/951413iMgBlog/dig.png   alt="img"  ></p>
<h2 id="分析vipclient域名解析返回的包内容" class="headerLink">
    <a href="#%e5%88%86%e6%9e%90vipclient%e5%9f%9f%e5%90%8d%e8%a7%a3%e6%9e%90%e8%bf%94%e5%9b%9e%e7%9a%84%e5%8c%85%e5%86%85%e5%ae%b9" class="header-mark"></a>分析vipclient域名解析返回的包内容</h2><p><img class="tw-inline" loading="lazy" src=http://localhost:1313/Users/ren/case/ossimg/0882e4815fb1acfa80f813db4bb7265b.png   alt="image.png"  ></p>
<p>把上图中最后4个16进制翻译成10进制IP地址，这个IP地址正是域名所对应的IP，可见vipclient收到域名解析后，因为看不懂edns协议，就按照自己的理解返回了结果，客户端收到这个结果后按照edns协议解析不出来IP，也就是两个的协议不对等导致了问题</p>
<h2 id="总结" class="headerLink">
    <a href="#%e6%80%bb%e7%bb%93" class="header-mark"></a>总结</h2><p>centos7之前默认都不启用edns，centos7后默认启用edns，但是vipclient目前不支持edns
通过命令：dig +noedns edas.console.cztest.com 能解析到域名所对应的IP
但是命令：dig edas.console.cztest.com  解析不到IP，因为vipclient（相当于这里的dns server）没有兼容edns，实际返回的结果带了IP但是客户端不支持edns协议所以解析不到（vipclient返回的格式、规范不对）</p>
]]></description>
</item></channel>
</rss>
