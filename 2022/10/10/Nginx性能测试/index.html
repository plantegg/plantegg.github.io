<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 8.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.0.0/css/all.min.css" integrity="sha256-VHqXKFhhMxcpubYf9xiWdCiojEbY9NexQ4jh8AxbvcM=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"plantegg.github.io","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.26.0","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js" defer></script>

    <meta name="description" content="Nginx 性能测试压测工具选择 wrk ，apache ab压nginx单核没问题，多核的话 ab 自己先到瓶颈。另外默认关闭 access.log 避免 osq(osq 优化的自旋锁)。 Nginx 官方测试数据普通测试数据参考官方数据，不再多做测试 RPS for HTTP RequestsThe table and graph below show the number of HTTP r">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx 性能测试">
<meta property="og:url" content="https://plantegg.github.io/2022/10/10/Nginx%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/index.html">
<meta property="og:site_name" content="plantegg">
<meta property="og:description" content="Nginx 性能测试压测工具选择 wrk ，apache ab压nginx单核没问题，多核的话 ab 自己先到瓶颈。另外默认关闭 access.log 避免 osq(osq 优化的自旋锁)。 Nginx 官方测试数据普通测试数据参考官方数据，不再多做测试 RPS for HTTP RequestsThe table and graph below show the number of HTTP r">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/NGINX-HTTP-RPS.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20221008100922349.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20221008100808480.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20220930143920567.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20220930143419304.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20221009093842151.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20220916174106821.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20220916174234039.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20220916202347245.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20220916151006533.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20220916151310488.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/1663329200304-4f4b615b-8507-47c8-87ff-7e92939f12bc.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20220916151613388.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20220919180725510.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20220919180758887.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20220919180916190.png">
<meta property="og:image" content="https://plantegg.github.io/images/951413iMgBlog/image-20231117103535342.png">
<meta property="article:published_time" content="2022-10-10T04:30:03.000Z">
<meta property="article:modified_time" content="2025-11-16T11:58:49.527Z">
<meta property="article:author" content="twitter @plantegg">
<meta property="article:tag" content="CPU">
<meta property="article:tag" content="nginx">
<meta property="article:tag" content="performance">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://plantegg.github.io/images/951413iMgBlog/NGINX-HTTP-RPS.png">


<link rel="canonical" href="https://plantegg.github.io/2022/10/10/Nginx%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://plantegg.github.io/2022/10/10/Nginx%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/","path":"2022/10/10/Nginx性能测试/","title":"Nginx 性能测试"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Nginx 性能测试 | plantegg</title>
  








  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">plantegg</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">java tcp mysql performance network docker Linux</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Nginx-%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95"><span class="nav-number">1.</span> <span class="nav-text">Nginx 性能测试</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E5%AE%98%E6%96%B9%E6%B5%8B%E8%AF%95%E6%95%B0%E6%8D%AE"><span class="nav-number">1.1.</span> <span class="nav-text">Nginx 官方测试数据</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RPS-for-HTTP-Requests"><span class="nav-number">1.1.1.</span> <span class="nav-text">RPS for HTTP Requests</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RPS-for-HTTPS-Requests"><span class="nav-number">1.1.2.</span> <span class="nav-text">RPS for HTTPS Requests</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E9%85%8D%E7%BD%AE%E5%8F%82%E6%95%B0"><span class="nav-number">1.2.</span> <span class="nav-text">参考配置参数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#https-%E9%85%8D%E7%BD%AE"><span class="nav-number">1.2.1.</span> <span class="nav-text">https 配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%9B%E5%BB%BAecdsa-P256-%E7%A7%98%E9%92%A5%E5%92%8C%E8%AF%81%E4%B9%A6"><span class="nav-number">1.2.2.</span> <span class="nav-text">创建ecdsa P256 秘钥和证书</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#https-%E9%95%BF%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.2.3.</span> <span class="nav-text">https 长连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#https-%E7%9F%AD%E8%BF%9E%E6%8E%A5"><span class="nav-number">1.2.4.</span> <span class="nav-text">https 短连接</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E5%90%8C-CPU-%E5%9E%8B%E5%8F%B7%E4%B8%8B-Nginx-%E9%9D%99%E6%80%81%E9%A1%B5%E9%9D%A2%E7%9A%84%E5%A4%84%E7%90%86%E8%83%BD%E5%8A%9B"><span class="nav-number">1.3.</span> <span class="nav-text">不同 CPU 型号下 Nginx 静态页面的处理能力</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#sendfile-%E5%92%8C-tcp-nopush"><span class="nav-number">1.4.</span> <span class="nav-text">sendfile 和 tcp_nopush</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#tcp-nopush-%E5%AF%B9%E6%80%A7%E8%83%BD%E7%9A%84%E5%BD%B1%E5%93%8D"><span class="nav-number">1.4.1.</span> <span class="nav-text">tcp_nopush 对性能的影响</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E6%9E%90%E5%8F%82%E8%80%83%E6%95%B0%E6%8D%AE"><span class="nav-number">1.4.2.</span> <span class="nav-text">分析参考数据</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#perf-top-%E6%95%B0%E6%8D%AE"><span class="nav-number">1.4.3.</span> <span class="nav-text">perf top 数据</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx-%E5%9C%A816%E6%A0%B8%E5%90%8E%E5%86%8D%E5%A2%9E%E5%8A%A0%E6%A0%B8%E6%95%B0%E6%80%A7%E8%83%BD%E6%8F%90%E5%8D%87%E5%BE%88%E5%B0%91%E7%9A%84%E5%88%86%E6%9E%90"><span class="nav-number">1.5.</span> <span class="nav-text">Nginx 在16核后再增加核数性能提升很少的分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ARM%E4%B8%8B%E8%BF%99%E4%B8%AA%E7%93%B6%E9%A2%88%E6%9B%B4%E6%98%8E%E6%98%BE"><span class="nav-number">1.5.1.</span> <span class="nav-text">ARM下这个瓶颈更明显</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E9%94%81%E7%9A%84%E7%AB%9E%E4%BA%89"><span class="nav-number">1.5.2.</span> <span class="nav-text">文件锁的竞争</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%BD%AF%E4%B8%AD%E6%96%AD%E5%92%8C-nginx-%E6%89%80%E5%9C%A8-node-%E5%85%B3%E7%B3%BB"><span class="nav-number">1.6.</span> <span class="nav-text">软中断和 nginx 所在 node 关系</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BD%91%E7%BB%9C%E6%8F%8F%E8%BF%B0%E7%AC%A6%E3%80%81%E6%95%B0%E6%8D%AE%E7%BC%93%E5%86%B2%E5%8C%BA%EF%BC%8C%E8%AE%BE%E5%A4%87%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="nav-number">1.6.1.</span> <span class="nav-text">网络描述符、数据缓冲区，设备的关系</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Nginx%E5%A4%84%E7%90%86HTTP%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">1.7.</span> <span class="nav-text">Nginx处理HTTP的生命周期</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">1.8.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-number">1.9.</span> <span class="nav-text">参考资料</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">twitter @plantegg</p>
  <div class="site-description" itemprop="description">java mysql tcp performance network docker Linux</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">185</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">274</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://plantegg.github.io/2022/10/10/Nginx%E6%80%A7%E8%83%BD%E6%B5%8B%E8%AF%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="twitter @plantegg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="plantegg">
      <meta itemprop="description" content="java mysql tcp performance network docker Linux">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="Nginx 性能测试 | plantegg">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Nginx 性能测试
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-10-10 12:30:03" itemprop="dateCreated datePublished" datetime="2022-10-10T12:30:03+08:00">2022-10-10</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2025-11-16 19:58:49" itemprop="dateModified" datetime="2025-11-16T19:58:49+08:00">2025-11-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/performance/" itemprop="url" rel="index"><span itemprop="name">performance</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h1 id="Nginx-性能测试"><a href="#Nginx-性能测试" class="headerlink" title="Nginx 性能测试"></a>Nginx 性能测试</h1><p>压测工具选择 wrk ，apache ab压nginx单核没问题，多核的话 ab 自己先到瓶颈。另外默认关闭 access.log 避免 osq(osq 优化的自旋锁)。</p>
<h2 id="Nginx-官方测试数据"><a href="#Nginx-官方测试数据" class="headerlink" title="Nginx 官方测试数据"></a><a target="_blank" rel="noopener" href="https://www.nginx.com/blog/testing-the-performance-of-nginx-and-nginx-plus-web-servers/">Nginx 官方测试数据</a></h2><p>普通测试数据参考官方数据，不再多做测试</p>
<h3 id="RPS-for-HTTP-Requests"><a href="#RPS-for-HTTP-Requests" class="headerlink" title="RPS for HTTP Requests"></a>RPS for HTTP Requests</h3><p>The table and graph below show the number of HTTP requests for varying numbers of CPUs and varying request sizes, in kilobytes (KB).</p>
<table>
<thead>
<tr>
<th align="center">CPUs</th>
<th align="center">0 KB</th>
<th align="center">1 KB</th>
<th align="center">10 KB</th>
<th align="center">100 KB</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">145,551</td>
<td align="center">74,091</td>
<td align="center">54,684</td>
<td align="center">33,125</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">249,293</td>
<td align="center">131,466</td>
<td align="center">102,069</td>
<td align="center">62,554</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">543,061</td>
<td align="center">261,269</td>
<td align="center">207,848</td>
<td align="center">88,691</td>
</tr>
<tr>
<td align="center">8</td>
<td align="center">1,048,421</td>
<td align="center">524,745</td>
<td align="center">392,151</td>
<td align="center">91,640</td>
</tr>
<tr>
<td align="center">16</td>
<td align="center">2,001,846</td>
<td align="center">972,382</td>
<td align="center">663,921</td>
<td align="center">91,623</td>
</tr>
<tr>
<td align="center">32</td>
<td align="center">3,019,182</td>
<td align="center">1,316,362</td>
<td align="center">774,567</td>
<td align="center">91,640</td>
</tr>
<tr>
<td align="center">36</td>
<td align="center">3,298,511</td>
<td align="center">1,309,358</td>
<td align="center">764,744</td>
<td align="center">91,655</td>
</tr>
</tbody></table>
<p><a target="_blank" rel="noopener" href="https://www.nginx.com/wp-content/uploads/2017/08/NGINX-HTTP-RPS.png"><img src="/images/951413iMgBlog/NGINX-HTTP-RPS.png" alt="img"></a></p>
<h3 id="RPS-for-HTTPS-Requests"><a href="#RPS-for-HTTPS-Requests" class="headerlink" title="RPS for HTTPS Requests"></a>RPS for HTTPS Requests</h3><p>HTTPS RPS is lower than HTTP RPS for the same provisioned bare‑metal hardware because the data encryption and decryption necessary to secure data transmitted between machines is computationally expensive.</p>
<p>Nonetheless, continued advances in Intel architecture – resulting in servers with faster processors and better memory management – mean that the performance of software for CPU‑bound encryption tasks continually improves compared to dedicated hardware encryption devices.</p>
<p>Though RPS for HTTPS are roughly one‑quarter less than for HTTP at the 16‑CPU mark, “throwing hardware at the problem” – in the form of additional CPUs – is more effective than for HTTP, for the more commonly used file sizes and all the way up to 36 CPUs.</p>
<table>
<thead>
<tr>
<th align="center">CPUs</th>
<th align="center">0 KB</th>
<th align="center">1 KB</th>
<th align="center">10 KB</th>
<th align="center">100 KB</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">71,561</td>
<td align="center">40,207</td>
<td align="center">23,308</td>
<td align="center">4,830</td>
</tr>
<tr>
<td align="center">2</td>
<td align="center">151,325</td>
<td align="center">85,139</td>
<td align="center">48,654</td>
<td align="center">9,871</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">324,654</td>
<td align="center">178,395</td>
<td align="center">96,808</td>
<td align="center">19,355</td>
</tr>
<tr>
<td align="center">8</td>
<td align="center">647,213</td>
<td align="center">359,576</td>
<td align="center">198,818</td>
<td align="center">38,900</td>
</tr>
<tr>
<td align="center">16</td>
<td align="center">1,262,999</td>
<td align="center">690,329</td>
<td align="center">383,860</td>
<td align="center">77,427</td>
</tr>
<tr>
<td align="center">32</td>
<td align="center">2,197,336</td>
<td align="center">1,207,959</td>
<td align="center">692,804</td>
<td align="center">90,430</td>
</tr>
<tr>
<td align="center">36</td>
<td align="center">2,175,945</td>
<td align="center">1,239,624</td>
<td align="center">733,745</td>
<td align="center">89,842</td>
</tr>
</tbody></table>
<h2 id="参考配置参数"><a href="#参考配置参数" class="headerlink" title="参考配置参数"></a>参考配置参数</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">user nginx;</span><br><span class="line">worker_processes 4;</span><br><span class="line">worker_cpu_affinity 00000000000000000000000000001111;</span><br><span class="line"></span><br><span class="line"># Load dynamic modules. See /usr/share/doc/nginx/README.dynamic.</span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    use epoll;</span><br><span class="line">    accept_mutex off;</span><br><span class="line">    worker_connections 102400;</span><br><span class="line">&#125;</span><br><span class="line">http &#123;</span><br><span class="line">    access_log off;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    sendfile_max_chunk 512k;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    keepalive_timeout   60;</span><br><span class="line">    keepalive_requests 100000000000;</span><br><span class="line"></span><br><span class="line">		#在 nginx.conf 中增加以下开销能提升短连接 RPS</span><br><span class="line">    open_file_cache max=10240000 inactive=60s;</span><br><span class="line">    open_file_cache_valid 80s;</span><br><span class="line">    open_file_cache_min_uses 1;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    # Load modular configuration files from the /etc/nginx/conf.d directory.</span><br><span class="line">    # See http://nginx.org/en/docs/ngx_core_module.html#include</span><br><span class="line">    # for more information.</span><br><span class="line">    include /etc/nginx/conf.d/*.conf;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        listen       [::]:80 default_server;</span><br><span class="line">        server_name  _;</span><br><span class="line">        root         /apt/uos.aarch;</span><br><span class="line"></span><br><span class="line">        # Load configuration files for the default server block.</span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        location /&#123;</span><br><span class="line">                #root /polarx/apt/uos.aarch;</span><br><span class="line">                index index.html;</span><br><span class="line">                autoindex on;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">        		#return 200 &#x27;a&#x27;;</span><br><span class="line">        		#root   /usr/share/nginx/html;</span><br><span class="line">        		#index  index.html index.htm;</span><br><span class="line">        		#autoindex 目录文件浏览模式</span><br><span class="line">        		autoindex on;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure>

<h3 id="https-配置"><a href="#https-配置" class="headerlink" title="https 配置"></a>https 配置</h3><p>解开https默认配置注释 &#x2F;&#x2F; sed -i “57,81s&#x2F;#(.*)&#x2F;\1&#x2F;“ &#x2F;etc&#x2F;nginx&#x2F;nginx.conf</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># Settings for a TLS enabled server.</span><br><span class="line">#</span><br><span class="line">#    server &#123;</span><br><span class="line">#        listen       443 ssl http2 default_server;</span><br><span class="line">#        listen       [::]:443 ssl http2 default_server;</span><br><span class="line">#        server_name  _;</span><br><span class="line">#        root         /usr/share/nginx/html;</span><br><span class="line">#</span><br><span class="line">#        ssl_certificate &quot;/etc/pki/nginx/server.crt&quot;;</span><br><span class="line">#        ssl_certificate_key &quot;/etc/pki/nginx/private/server.key&quot;;</span><br><span class="line">#        ssl_session_cache shared:SSL:1m;</span><br><span class="line">#        ssl_session_timeout  10m;</span><br><span class="line">#        ssl_ciphers HIGH:!aNULL:!MD5;</span><br><span class="line">#        ssl_prefer_server_ciphers on;</span><br><span class="line">#</span><br><span class="line">#        # Load configuration files for the default server block.</span><br><span class="line">#        include /etc/nginx/default.d/*.conf;</span><br><span class="line">#</span><br><span class="line">#        location / &#123;</span><br><span class="line">#        &#125;</span><br><span class="line">#</span><br><span class="line">#        error_page 404 /404.html;</span><br><span class="line">#            location = /40x.html &#123;</span><br><span class="line">#        &#125;</span><br><span class="line">#</span><br><span class="line">#        error_page 500 502 503 504 /50x.html;</span><br><span class="line">#            location = /50x.html &#123;</span><br><span class="line">#        &#125;</span><br><span class="line">#    &#125;</span><br></pre></td></tr></table></figure>

<p>生成秘钥文件和配置https</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mkdir /etc/pki/nginx/  /etc/pki/nginx/private -p</span><br><span class="line">openssl genrsa -des3 -out server.key 2048  #会有两次要求输入密码,输入同一个即可</span><br><span class="line">openssl rsa -in server.key -out server.key</span><br><span class="line">openssl req -new -key server.key -out server.csr</span><br><span class="line">openssl req -new -x509 -key server.key -out server.crt -days 3650</span><br><span class="line">openssl req -new -x509 -key server.key -out ca.crt -days 3650</span><br><span class="line">openssl x509 -req -days 3650 -in server.csr -CA ca.crt -CAkey server.key -CAcreateserial -out server.crt</span><br><span class="line"></span><br><span class="line">cp server.crt /etc/pki/nginx/</span><br><span class="line">cp server.key /etc/pki/nginx/private</span><br><span class="line"></span><br><span class="line">启动nginx</span><br><span class="line">systemctl start nginx</span><br></pre></td></tr></table></figure>

<h3 id="创建ecdsa-P256-秘钥和证书"><a href="#创建ecdsa-P256-秘钥和证书" class="headerlink" title="创建ecdsa P256 秘钥和证书"></a>创建ecdsa P256 秘钥和证书</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -sha256 -nodes -days 365 -newkey ec:&lt;(openssl ecparam -name prime256v1) -keyout ecdsa.key -out ecdsa.crt -subj &quot;/C=CN/ST=Beijing/L=Beijing/O=Example Inc./OU=Web Security/CN=example1.com&quot;</span><br></pre></td></tr></table></figure>

<h3 id="https-长连接"><a href="#https-长连接" class="headerlink" title="https 长连接"></a>https 长连接</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wrk -t 32 -c 1000 -d 30 --latency https://$serverIP:443</span><br></pre></td></tr></table></figure>

<h3 id="https-短连接"><a href="#https-短连接" class="headerlink" title="https 短连接"></a>https 短连接</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wrk -t 32 -c 1000 -d 30  -H &#x27;Connection: close&#x27;  --latency https://$serverIP:443</span><br></pre></td></tr></table></figure>

<h2 id="不同-CPU-型号下-Nginx-静态页面的处理能力"><a href="#不同-CPU-型号下-Nginx-静态页面的处理能力" class="headerlink" title="不同 CPU 型号下 Nginx 静态页面的处理能力"></a>不同 CPU 型号下 Nginx 静态页面的处理能力</h2><p>对比不同 CPU 型号下 Nginx 静态页面的处理能力。静态文件下容易出现 同一文件上的 自旋锁（OSQ），null 测试场景表示直接返回，不读取文件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wrk -t12 -c400 -d30s http://100.81.131.221:18082/index.html //参数可以调整，目标就是将 CPU 压满</span><br></pre></td></tr></table></figure>

<p>软中断在 node0 上，intel E5和 M的对比，在M上访问单个文件锁竞争太激烈，改成请求直接 return 后多核能保持较好的线性能力（下表中 null标识）</p>
<table>
<thead>
<tr>
<th align="center">CPUs(括号中为core序号)</th>
<th align="center">E5-2682</th>
<th>E5-2682 null</th>
<th>M</th>
<th align="center">M  null</th>
<th>AMD 7t83 null</th>
<th>AMD 7t83</th>
<th>ft s2500  on null</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1(0)</td>
<td align="center">69282&#x2F;61500.77</td>
<td>118694&#x2F;106825</td>
<td>74091</td>
<td align="center">135539&#x2F;192691</td>
<td>190568</td>
<td>87190</td>
<td>35064</td>
</tr>
<tr>
<td align="center">2(1,2)</td>
<td align="center">130648 us 31%</td>
<td>233947</td>
<td>131466</td>
<td align="center"></td>
<td>365315</td>
<td></td>
<td></td>
</tr>
<tr>
<td align="center">2(1对HT)</td>
<td align="center">94158 34%</td>
<td>160114</td>
<td></td>
<td align="center"></td>
<td>217783</td>
<td></td>
<td></td>
</tr>
<tr>
<td align="center">4(0-3)</td>
<td align="center">234884&#x2F;211897</td>
<td>463033&#x2F;481010</td>
<td></td>
<td align="center">499507&#x2F;748880</td>
<td>730189</td>
<td>323591</td>
<td></td>
</tr>
<tr>
<td align="center">8(0-7)</td>
<td align="center">467658&#x2F;431308</td>
<td>923348&#x2F;825002</td>
<td></td>
<td align="center">1015744&#x2F;1529721</td>
<td>1442115</td>
<td>650780</td>
<td></td>
</tr>
<tr>
<td align="center">8(0-15)</td>
<td align="center"></td>
<td>1689722&#x2F;1363031</td>
<td></td>
<td align="center">1982448&#x2F;3047778</td>
<td>2569314</td>
<td>915399</td>
<td></td>
</tr>
</tbody></table>
<p>测试说明：</p>
<ul>
<li>压测要将多个核打满，有时候因为软中断的挤占会导致部分核打不满</li>
<li>要考虑软中断对CPU使用的挤占&#x2F;以及软中断跨node的影响</li>
<li>测试结果两组数字的话，前者为nginx、软中断分别在不同的node</li>
<li>E5&#x2F;M 软中断绑 node1，测试结果的两组数据表示软中断和nginx跨node和同node（同 node时软中断和nginx尽量错开）</li>
<li>null 指的是 nginx 直接返回 200，不从文件读取html，保证没有文件锁</li>
<li>AMD 软中断总是能跟着绑核的nginx进程跑</li>
<li>压测要将多个核打满，有时候因为软中断的挤占会导致部分核打不满</li>
</ul>
<p>M是裸金属ECS，moc卡插在Die1上，所以软中断默认绑在 Die1 上，测试强行将软中断绑定到 Die0 实际测试结果和绑定在 Die1 性能一样，猜测改了驱动将网络包的描述符没有按硬件绑死而是跟软中断就近分配。</p>
<h2 id="sendfile-和-tcp-nopush"><a href="#sendfile-和-tcp-nopush" class="headerlink" title="sendfile 和 tcp_nopush"></a>sendfile 和 tcp_nopush</h2><h3 id="tcp-nopush-对性能的影响"><a href="#tcp-nopush-对性能的影响" class="headerlink" title="tcp_nopush 对性能的影响"></a>tcp_nopush 对性能的影响</h3><p>M上，返回很小的 html页面，如果 tcp_nopush&#x3D;on 性能能有20%的提升，并且开启后 si% 使用率从10%降到了0. Tcp_nodelay&#x3D;on 就基本对性能没啥影响</p>
<blockquote>
<p>TCP_NOPUSH 是 FreeBSD 的一个 socket 选项，对应 Linux 的 TCP_CORK，Nginx 里统一用 <code>tcp_nopush</code> 来控制它。启用它之后，数据包会累计到一定大小之后才会发送，减小了额外开销，提高网络效率。</p>
<p>To keep everything logical, Nginx tcp_nopush activates the TCP_CORK option in the Linux TCP stack since the TCP_NOPUSH one exists on FreeBSD only.</p>
</blockquote>
<p>nginx on M 8核，http 长连接，访问极小的静态页面（AMD 上测试也是 sendfile off 性能要好30%左右）</p>
<table>
<thead>
<tr>
<th></th>
<th>tcp_nopush on</th>
<th>tcp_nopush off</th>
</tr>
</thead>
<tbody><tr>
<td>sendfile on</td>
<td>46万(PPS 44万)</td>
<td>37万（PPS 73万）</td>
</tr>
<tr>
<td>sendfile off</td>
<td>49万(PPS 48万)</td>
<td>49万（PPS 48万)</td>
</tr>
</tbody></table>
<p>问题：为什么 sendfile off 性能反而好？（PPS 明显低了）</p>
<p>答：一次请求Nginx要回复header+body, header在用户态内存，body走sendfile在内核态内存，nginx没有机会合并header+body, sendfile on后导致每次请求要回复两个tcp包。而 sendfile off的时候虽然有用户态内核态切换、copy，但是有机会把 header&#x2F;body 合并成一个tcp包</p>
<p>从抓包来看，sendfile on的时候每次 http get都是回复两个包：1) http 包头（len：288）2）http body(len: 58) </p>
<p><img src="/images/951413iMgBlog/image-20221008100922349.png" alt="image-20221008100922349"></p>
<p>sendfile off的时候每次 http get都是回复一个包： http 包头+body（len：292&#x3D;288+4）</p>
<p><img src="/images/951413iMgBlog/image-20221008100808480.png" alt="image-20221008100808480"></p>
<p>在这个小包场景，如果sendfile&#x3D;off 后，回包在http层面就已经合并从1个了，导致内核没机会再次 cork（合并包）；如果sendfile&#x3D;on 则是每次请求回复两个tcp包，如果设置了  nopush 会在内核层面合并一次。</p>
<p>如果不是访问磁盘上的静态页面，而是直接 return某个内存的内容的话，sendfile on&#x2F;off 对性能没有影响，原理也如上，不需要访问磁盘，也就没有机会分两个包发送包头和body了。</p>
<h3 id="分析参考数据"><a href="#分析参考数据" class="headerlink" title="分析参考数据"></a>分析参考数据</h3><p>以下数据都是变换不同的 sendfile、tcp_nopush等组合来观察QPS、setsockopt、PPS来分析这些参数起了什么作用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">//tcp_nopush off; QPS 37万  很明显 pps 比46万高了将近1倍，这是因为 tcp_cork 合并了小包</span><br><span class="line">//nginx 创建连接设置的 sock opt</span><br><span class="line">#cat strace.log.88206</span><br><span class="line">08:31:19.632581 setsockopt(3, SOL_TCP, TCP_NODELAY, [1], 4) = 0 &lt;0.000013&gt;</span><br><span class="line"></span><br><span class="line">#tsar --traffic --live -i1</span><br><span class="line">Time              ---------------------traffic--------------------</span><br><span class="line">Time               bytin  bytout   pktin  pktout  pkterr  pktdrp</span><br><span class="line">30/09/22-07:00:22  52.9M  122.8M  748.2K  726.8K    0.00    0.00</span><br><span class="line">30/09/22-07:00:23  52.9M  122.7M  748.1K  726.2K    0.00    0.00</span><br><span class="line">30/09/22-07:00:24  53.0M  122.9M  749.2K  727.2K    0.00    0.00</span><br><span class="line">30/09/22-07:00:25  53.0M  122.8M  749.3K  726.6K    0.00    0.00</span><br><span class="line">30/09/22-07:00:26  52.9M  122.8M  748.2K  727.1K    0.00    0.00</span><br><span class="line">30/09/22-07:00:27  53.1M  123.0M  750.5K  728.0K    0.00    0.00</span><br><span class="line"></span><br><span class="line">//tcp_nopush      on; QPS 46万</span><br><span class="line">#tsar --traffic --live -i1</span><br><span class="line">Time              ---------------------traffic--------------------</span><br><span class="line">Time               bytin  bytout   pktin  pktout  pkterr  pktdrp</span><br><span class="line">30/09/22-07:00:54  40.2M  127.6M  447.6K  447.6K    0.00    0.00</span><br><span class="line">30/09/22-07:00:55  40.2M  127.5M  447.1K  447.1K    0.00    0.00</span><br><span class="line">30/09/22-07:00:56  40.1M  127.4M  446.8K  446.8K    0.00    0.00</span><br><span class="line"></span><br><span class="line">//sendfile on ,tcp_nopush on, quickack on; QPS 46万</span><br><span class="line">#ip route change 172.16.0.0/24 dev eth0 quickack 1</span><br><span class="line"></span><br><span class="line">#ip route</span><br><span class="line">default via 172.16.0.253 dev eth0</span><br><span class="line">169.254.0.0/16 dev eth0 scope link metric 1002</span><br><span class="line">172.16.0.0/24 dev eth0 scope link quickack 1</span><br><span class="line">192.168.5.0/24 dev docker0 proto kernel scope link src 192.168.5.1</span><br><span class="line"></span><br><span class="line">//nginx 创建连接设置的 sock opt </span><br><span class="line">#cat strace.log.85937</span><br><span class="line">08:27:44.702111 setsockopt(3, SOL_TCP, TCP_CORK, [1], 4) = 0 &lt;0.000011&gt;</span><br><span class="line">08:27:44.702353 setsockopt(3, SOL_TCP, TCP_CORK, [0], 4) = 0 &lt;0.000013&gt;</span><br><span class="line"></span><br><span class="line">#tsar --traffic -i1 --live</span><br><span class="line">Time              ---------------------traffic--------------------</span><br><span class="line">Time               bytin  bytout   pktin  pktout  pkterr  pktdrp</span><br><span class="line">08/10/22-03:27:23  40.7M  152.9M  452.6K  905.2K    0.00    0.00</span><br><span class="line">08/10/22-03:27:24  40.7M  152.9M  452.6K  905.2K    0.00    0.00</span><br><span class="line">08/10/22-03:27:25  40.6M  152.8M  452.3K  904.5K    0.00    0.00</span><br><span class="line">08/10/22-03:27:26  40.6M  152.7M  452.1K  904.1K    0.00    0.00</span><br><span class="line">08/10/22-03:27:27  40.6M  152.7M  452.0K  904.0K    0.00    0.00</span><br><span class="line">08/10/22-03:27:28  40.7M  153.1M  453.2K  906.5K    0.00    0.00</span><br><span class="line"></span><br><span class="line">//sendfile on , quickack on; QPS 42万</span><br><span class="line">#tsar --traffic -i1 --live</span><br><span class="line">Time              ---------------------traffic--------------------</span><br><span class="line">Time               bytin  bytout   pktin  pktout  pkterr  pktdrp</span><br><span class="line">08/10/22-04:02:53  57.9M  158.7M  812.3K    1.2M    0.00    0.00</span><br><span class="line">08/10/22-04:02:54  58.3M  159.6M  817.3K    1.2M    0.00    0.00</span><br><span class="line">08/10/22-04:02:55  58.2M  159.4M  816.0K    1.2M    0.00    0.00</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://thoughts.t37.net/nginx-optimization-understanding-sendfile-tcp-nodelay-and-tcp-nopush-c55cdd276765">This behavior is confirmed in a comment from the TCP stack source about TCP_CORK</a>:</p>
<blockquote>
<p>When set indicates to always queue non-full frames. Later the user clears this option and we transmit any pending partial frames in the queue. This is meant to be used alongside sendfile() to get properly filled frames when the user (for example) must write out headers with a write() call first and then use sendfile to send out the data parts. TCP_CORK can be set together with TCP_NODELAY and it is stronger than TCP_NODELAY.</p>
</blockquote>
<h3 id="perf-top-数据"><a href="#perf-top-数据" class="headerlink" title="perf top 数据"></a>perf top 数据</h3><p>以下都是 sendfile on的时候变换 tcp_nopush 参数得到的不同 perf 数据</p>
<p>tcp_nopush&#x3D;off：(QPS 37万)</p>
<p><img src="/images/951413iMgBlog/image-20220930143920567.png" alt="image-20220930143920567"></p>
<p>tcp_nopush&#x3D;on：(QPS 46万)</p>
<p><img src="/images/951413iMgBlog/image-20220930143419304.png" alt="image-20220930143419304"></p>
<p>对比一下，在sendfile on的时候，用不同的push 参数对应的 tcp 栈</p>
<p><img src="/images/951413iMgBlog/image-20221009093842151.png" alt="image-20221009093842151"></p>
<h2 id="Nginx-在16核后再增加核数性能提升很少的分析"><a href="#Nginx-在16核后再增加核数性能提升很少的分析" class="headerlink" title="Nginx 在16核后再增加核数性能提升很少的分析"></a>Nginx 在16核后再增加核数性能提升很少的分析</h2><p>16核 perf top</p>
<p><img src="/images/951413iMgBlog/image-20220916174106821.png" alt="image-20220916174106821"></p>
<p>32核 perf top</p>
<p><img src="/images/951413iMgBlog/image-20220916174234039.png" alt="image-20220916174234039"></p>
<p>从以上两个perf top 对比可以看到内核锁消耗增加非常明显</p>
<p>这是因为<a target="_blank" rel="noopener" href="https://www.cnblogs.com/LoyenWang/p/12826811.html">读写文件锁 osq_lock</a> ，比如nginx需要写日志访问 access.log，需要加锁</p>
<p><code>osq(optimistci spinning queue)</code>是基于MCS算法的一个具体实现，osq_lock 是Linux 中对MCS的实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">        return 200 &#x27;&lt;!DOCTYPE html&gt;&lt;h2&gt;null!&lt;/h2&gt;\n&#x27;; #直接内存返回，不读磁盘文件，避免文件锁</span><br><span class="line">        # because default content-type is application/octet-stream,</span><br><span class="line">    		# browser will offer to &quot;save the file&quot;...</span><br><span class="line">    		# if you want to see reply in browser, uncomment next line </span><br><span class="line">    		# add_header Content-Type text/plain;</span><br><span class="line">        root   /usr/share/nginx/html;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="ARM下这个瓶颈更明显"><a href="#ARM下这个瓶颈更明显" class="headerlink" title="ARM下这个瓶颈更明显"></a>ARM下这个瓶颈更明显</h3><p>M上用40-64 core 并发的时候 perf top都是如下图，40 core以上网络瓶颈，pps 达到620万（离ECS规格承诺的1200万还很远），CPU压不起来了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#tsar --traffic -i1 --live</span><br><span class="line">Time              ---------------------traffic--------------------</span><br><span class="line">Time               bytin  bytout   pktin  pktout  pkterr  pktdrp</span><br><span class="line">16/09/22-12:41:07 289.4M  682.8M    3.2M    3.2M    0.00    0.00</span><br><span class="line">16/09/22-12:41:08 285.5M  674.4M    3.1M    3.1M    0.00    0.00</span><br><span class="line">16/09/22-12:41:09 285.0M  672.6M    3.1M    3.1M    0.00    0.00</span><br><span class="line">16/09/22-12:41:10 287.5M  678.3M    3.1M    3.1M    0.00    0.00</span><br><span class="line">16/09/22-12:41:11 289.2M  682.0M    3.2M    3.2M    0.00    0.00</span><br><span class="line">16/09/22-12:41:12 290.1M  685.1M    3.2M    3.2M    0.00    0.00</span><br><span class="line">16/09/22-12:41:13 288.3M  680.4M    3.1M    3.1M    0.00    0.00</span><br><span class="line"></span><br><span class="line">#ethtool -l eth0</span><br><span class="line">Channel parameters for eth0:</span><br><span class="line">Pre-set maximums:</span><br><span class="line">RX:		0</span><br><span class="line">TX:		0</span><br><span class="line">Other:		0</span><br><span class="line">Combined:	32  //所以用不满64 core，依据上面的测试数据推算64队列的话那么基本可以跑到1200万pps</span><br><span class="line">Current hardware settings:</span><br><span class="line">RX:		0</span><br><span class="line">TX:		0</span><br><span class="line">Other:		0</span><br><span class="line">Combined:	32</span><br></pre></td></tr></table></figure>

<p><img src="/images/951413iMgBlog/image-20220916202347245.png" alt="image-20220916202347245"></p>
<h3 id="文件锁的竞争"><a href="#文件锁的竞争" class="headerlink" title="文件锁的竞争"></a>文件锁的竞争</h3><p>Nginx 在M 上使用 16 core的时候完全压不起来，都是内核态锁竞争，16core QPS 不到23万，线性能力很差（单核68000）</p>
<p>从下图可以看到 sys 偏高，真正用于 us 的 CPU 太少，而内核态 CPU 消耗过高的是 osq_lock(写日志文件锁相关)</p>
<p><img src="/images/951413iMgBlog/image-20220916151006533.png" alt="image-20220916151006533"></p>
<p><img src="/images/951413iMgBlog/image-20220916151310488.png" alt="image-20220916151310488"></p>
<p><img src="/images/951413iMgBlog/1663329200304-4f4b615b-8507-47c8-87ff-7e92939f12bc.png" alt="img"></p>
<p><img src="/images/951413iMgBlog/image-20220916151613388.png" alt="image-20220916151613388"></p>
<p>16核对应的perf状态</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Performance counter stats for process id &#x27;49643&#x27;:</span><br><span class="line"></span><br><span class="line">      2479.448740      task-clock (msec)         #    0.994 CPUs utilized</span><br><span class="line">              233      context-switches          #    0.094 K/sec</span><br><span class="line">                0      cpu-migrations            #    0.000 K/sec</span><br><span class="line">                0      page-faults               #    0.000 K/sec</span><br><span class="line">    3,389,330,461      cycles                    #    1.367 GHz</span><br><span class="line">    1,045,248,301      stalled-cycles-frontend   #   30.84% frontend cycles idle</span><br><span class="line">    1,378,321,174      stalled-cycles-backend    #   40.67% backend  cycles idle</span><br><span class="line">    3,877,095,782      instructions              #    1.14  insns per cycle</span><br><span class="line">                                                 #    0.36  stalled cycles per insn</span><br><span class="line">  &lt;not supported&gt;      branches</span><br><span class="line">        2,128,918      branch-misses             #    0.00% of all branches</span><br><span class="line"></span><br><span class="line">      2.493168013 seconds time elapsed</span><br></pre></td></tr></table></figure>

<h2 id="软中断和-nginx-所在-node-关系"><a href="#软中断和-nginx-所在-node-关系" class="headerlink" title="软中断和 nginx 所在 node 关系"></a>软中断和 nginx 所在 node 关系</h2><p>以下两种情况的软中断都绑在 32-47 core上</p>
<p>软中断和 nginx 在同一个node，这时基本看不到多少 si% </p>
<p><img src="/images/951413iMgBlog/image-20220919180725510.png" alt="image-20220919180725510"></p>
<p><img src="/images/951413iMgBlog/image-20220919180758887.png" alt="image-20220919180758887"></p>
<p>软中断和 nginx 跨node（性能相当于同node的70-80%）, 软中断几乎快打满 8 个核了，同时性能还差</p>
<p><img src="/images/951413iMgBlog/image-20220919180916190.png" alt="image-20220919180916190"></p>
<h3 id="网络描述符、数据缓冲区，设备的关系"><a href="#网络描述符、数据缓冲区，设备的关系" class="headerlink" title="网络描述符、数据缓冲区，设备的关系"></a>网络描述符、数据缓冲区，设备的关系</h3><p>网络描述符的内存分配跟着设备走（设备插在哪个node 就就近在本 node 分配描述符的内存）， 数据缓冲区内存跟着队列(中断)走， 如果队列绑定到DIE0， 而设备在DIE1上，这样在做DMA通信时， 会产生跨 DIE 的交织访问.</p>
<h2 id="Nginx处理HTTP的生命周期"><a href="#Nginx处理HTTP的生命周期" class="headerlink" title="Nginx处理HTTP的生命周期"></a><strong>Nginx处理HTTP的生命周期</strong></h2><p>Nginx将HTTP处理分成了11个阶段。下面的阶段，按顺序执行</p>
<table>
<thead>
<tr>
<th><strong>阶段名称</strong></th>
<th><strong>阶段作用</strong></th>
<th><strong>涉及的模块Moduel</strong></th>
<th><strong>Moduel作用</strong></th>
</tr>
</thead>
<tbody><tr>
<td>POST_READ</td>
<td>接收到完整的http头部后处理的阶段，在uri重写之前。一般跳过</td>
<td>realip</td>
<td>读取客户端真实IP信息，用于限流等</td>
</tr>
<tr>
<td>SERVER_RERITE</td>
<td>location匹配前，修改uri的阶段，用于重定向，location块外的重写指令（多次执行）</td>
<td>rewrite</td>
<td>重定向</td>
</tr>
<tr>
<td>FIND_CONFIG</td>
<td>uri寻找匹配的location块配置项（多次执行）</td>
<td>find_config</td>
<td>根据URI寻找匹配的localtion块配置</td>
</tr>
<tr>
<td>REWRITE</td>
<td>找到location块后再修改uri，location级别的uri重写阶段（多次执行）</td>
<td>rewrite</td>
<td>重定向</td>
</tr>
<tr>
<td>POST_WRITE</td>
<td>防死循环，跳转到对应阶段</td>
<td>&#x2F;</td>
<td>&#x2F;</td>
</tr>
<tr>
<td>PREACCESS</td>
<td>权限预处理</td>
<td>limt_conn</td>
<td>限制处理请求的速率，还可以设置桶的大小，是否延迟等参数</td>
</tr>
<tr>
<td>limit_req</td>
<td>限制连接和请求数</td>
<td></td>
<td></td>
</tr>
<tr>
<td>ACCESS</td>
<td>判断是否允许这个请求进入</td>
<td>auth_basic</td>
<td>实现简单的用户名、密码登录</td>
</tr>
<tr>
<td>access</td>
<td>支持配置allow\deny等指令</td>
<td></td>
<td></td>
</tr>
<tr>
<td>auth_request</td>
<td>将请求转发到第三方认证服务器上</td>
<td></td>
<td></td>
</tr>
<tr>
<td>POST_ACCESS</td>
<td>向用户发送拒绝服务的错误码，用来响应上一阶段的拒绝</td>
<td>&#x2F;</td>
<td>&#x2F;</td>
</tr>
<tr>
<td>PRECONTENT</td>
<td>服务器响应内容之前向响应内容添加一些额外的内容。</td>
<td>try_files</td>
<td>匹配配置的多个url地址</td>
</tr>
<tr>
<td>mirrors</td>
<td>复制一个相同的子请求，例如生产流量复制</td>
<td></td>
<td></td>
</tr>
<tr>
<td>CONTENT</td>
<td>内容生成阶段，该阶段产生响应，并发送到客户端</td>
<td>concat</td>
<td>如果访问多个小文件，可在一次请求上返回多个小文件内容</td>
</tr>
<tr>
<td>random_index，index, auto_index</td>
<td>显示location下目录或目录下的index.html文件的配置</td>
<td></td>
<td></td>
</tr>
<tr>
<td>static</td>
<td>通过absolute_redirect等指令设置重定向的Location等</td>
<td></td>
<td></td>
</tr>
<tr>
<td>LOG</td>
<td>记录访问日志</td>
<td>log</td>
<td>配置日志格式，存储位置等</td>
</tr>
</tbody></table>
<p>也可以通过源码ngx_module.c 中，查看到ngx_module_name，其中包含了在编译 Nginx 的时候的 with 指令所包含的所有模块，它们之间的顺序非常关键，在数组中顺序是相反的。</p>
<p><img src="/images/951413iMgBlog/image-20231117103535342.png" alt="image-20231117103535342"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>要考虑软中断、以及网卡软中断队列数量对性能的影响</p>
<p>sendfile不一定导致性能变好了</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>完善的Nginx在AWS Graviton上的测试报告<a target="_blank" rel="noopener" href="https://armkeil.blob.core.windows.net/developer/Files/pdf/white-paper/guidelines-for-deploying-nginx-plus-on-aws.pdf">https://armkeil.blob.core.windows.net/developer/Files/pdf/white-paper/guidelines-for-deploying-nginx-plus-on-aws.pdf</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/performance/" rel="tag"># performance</a>
              <a href="/tags/CPU/" rel="tag"># CPU</a>
              <a href="/tags/nginx/" rel="tag"># nginx</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/07/03/MySQL8.0%E7%9A%84%E4%B8%80%E4%BA%9B%E6%95%B0%E6%8D%AE/" rel="prev" title="MySQL 8.0新特性和性能数据">
                  <i class="fa fa-angle-left"></i> MySQL 8.0新特性和性能数据
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/10/10/Linux%20BUG%E5%86%85%E6%A0%B8%E5%AF%BC%E8%87%B4%E7%9A%84%20TCP%E8%BF%9E%E6%8E%A5%E5%8D%A1%E6%AD%BB/" rel="next" title="一个Linux 内核 bug 导致的 TCP连接卡死">
                  一个Linux 内核 bug 导致的 TCP连接卡死 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">twitter @plantegg</span>
  </div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
